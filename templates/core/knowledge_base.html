{% extends "base.html" %}
{% load static %}

{% block title %}Suporte - GRS{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/knowledge_base.css' %}">
{% endblock %}

{% block content %}
<div class="knowledge-base-page">
    <div class="kb-header">
        <div class="kb-header-content">
            <h1 class="kb-title">Suporte</h1>
            <p class="kb-subtitle">Centralize e compartilhe conhecimento da equipe</p>
        </div>
        {% if can_edit %}
        <button class="kb-btn-create" id="btn-new-article">
            <i class="bi bi-plus-lg"></i> Novo Artigo
        </button>
        {% endif %}
    </div>

    <!-- Barra de Busca -->
    <div class="kb-search-container">
        <div class="kb-search-bar">
            <i class="bi bi-search"></i>
            <input type="text" id="kb-search-input"
                placeholder="Busque por tutoriais, soluções ou perguntas frequentes...">
            <button class="kb-search-btn" id="btn-search">Buscar</button>
        </div>
    </div>

    <!-- Conteúdo Principal -->
    <div id="kb-content-area">
        <!-- Cards Iniciais (View: 'cards') -->
        <div id="view-cards" class="kb-cards-grid">


            <div class="kb-card" onclick="switchView('list', 'training')">
                <div class="kb-card-icon training">
                    <i class="bi bi-book"></i>
                </div>
                <h3>Treinamentos</h3>
                <p>Módulos completos de treinamento para capacitação da equipe.</p>
                <div class="kb-card-count" id="count-training">... cursos</div>
            </div>

            <div class="kb-card" onclick="switchView('list', 'troubleshooting')">
                <div class="kb-card-icon troubleshooting">
                    <i class="bi bi-tools"></i>
                </div>
                <h3>Resolução de Problemas</h3>
                <p>Guias práticos para solucionar falhas e erros comuns na operação.</p>
                <div class="kb-card-count" id="count-troubleshooting">... artigos</div>
            </div>

            <div class="kb-card" onclick="switchView('tools')">
                <div class="kb-card-icon tools">
                    <i class="bi bi-robot"></i>
                </div>
                <h3>Ferramentas de IA</h3>
                <p>Explore as melhores ferramentas de inteligência artificial disponíveis na internet.</p>
                <div class="kb-card-count" id="count-tools">... ferramentas</div>
            </div>

            <div class="kb-card" onclick="window.location.href='{% url 'sites' %}'">
                <div class="kb-card-icon sites">
                    <i class="bi bi-globe"></i>
                </div>
                <h3>Sites & Sistemas</h3>
                <p>Acesso rápido a todos os sites e sistemas corporativos.</p>
                <div class="kb-card-count">Acessar</div>
            </div>

            <div class="kb-card" onclick="window.location.href='{% url 'localizacao' %}'">
                <div class="kb-card-icon location">
                    <i class="bi bi-geo-alt"></i>
                </div>
                <h3>Localização das Lojas</h3>
                <p>Mapa e lista de todas as lojas da rede.</p>
                <div class="kb-card-count">Acessar</div>
            </div>
        </div>

        <!-- Listagem de Artigos (View: 'list') -->
        <div id="view-list" class="kb-list-container d-none">
            <div class="kb-list-header">
                <button class="kb-btn-back" onclick="switchView('cards')">
                    <i class="bi bi-arrow-left"></i> Voltar
                </button>
                <h2 id="list-title">Tutoriais e Guias</h2>
            </div>
            <div class="kb-articles-list" id="articles-list">
                <!-- Artigos injetados via JS -->
            </div>
        </div>

        <!-- Ferramentas de IA (View: 'tools') -->
        <div id="view-tools" class="kb-list-container d-none">
            <div class="kb-list-header">
                <div>
                    <button class="kb-btn-back" onclick="switchView('cards')">
                        <i class="bi bi-arrow-left"></i> Voltar
                    </button>
                    <h2>Ferramentas de IA</h2>
                </div>
            </div>

            <div class="kb-tools-filters mb-4 d-flex gap-2 flex-wrap">
                <button class="btn btn-sm btn-outline-primary active" onclick="filterTools('all', this)">Todas</button>
                <button class="btn btn-sm btn-outline-primary" onclick="filterTools('ia', this)">Chat & Geral</button>
                <button class="btn btn-sm btn-outline-primary"
                    onclick="filterTools('marketing', this)">Marketing</button>
                <button class="btn btn-sm btn-outline-primary" onclick="filterTools('design', this)">Design &
                    Imagem</button>
                <button class="btn btn-sm btn-outline-primary" onclick="filterTools('video', this)">Vídeo</button>
                <button class="btn btn-sm btn-outline-primary" onclick="filterTools('audio', this)">Áudio & Voz</button>
                <button class="btn btn-sm btn-outline-primary" onclick="filterTools('coding', this)">Dev</button>
                <button class="btn btn-sm btn-outline-primary"
                    onclick="filterTools('productivity', this)">Produtividade</button>
                <button class="btn btn-sm btn-outline-primary" onclick="filterTools('business', this)">Negócios</button>
            </div>

            <div class="kb-tools-grid" id="tools-grid">
                <!-- Ferramentas injetadas via JS -->
            </div>
        </div>
    </div>
</div>

<!-- Modal de Artigo -->
<div class="kb-modal-overlay d-none" id="article-modal">
    <div class="kb-modal">
        <div class="kb-modal-header">
            <h3 id="modal-title">Novo Artigo</h3>
            <button class="btn-close" id="close-modal"></button>
        </div>
        <div class="kb-modal-content">
            <form id="article-form">
                <input type="hidden" id="article-id">
                <div class="mb-3">
                    <label class="form-label">Categoria</label>
                    <select class="form-select" id="article-category">
                        <option value="tutorials">Tutoriais e Guias</option>
                        <option value="solutions">Soluções Comuns</option>
                        <option value="faq">Perguntas Frequentes</option>
                        <option value="troubleshooting">Resolução de Problemas</option>
                        <option value="training">Treinamentos</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Título</label>
                    <input type="text" class="form-control" id="article-title" required
                        placeholder="Digite o título do artigo...">
                </div>
                <div class="mb-3">
                    <label class="form-label">Conteúdo</label>
                    <textarea class="form-control" id="article-text" rows="8" required
                        placeholder="Digite o conteúdo... (Use **texto** para negrito)"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Tags (separadas por vírgula)</label>
                    <input type="text" class="form-control" id="article-tags" placeholder="ex: tutorial, sistema, guia">
                </div>
            </form>
        </div>
        <div class="kb-modal-footer">
            <button class="btn btn-light" id="btn-cancel">Cancelar</button>
            <button type="submit" form="article-form" class="btn btn-primary">Salvar Artigo</button>
        </div>
    </div>
</div>

<!-- Modal de Detalhes da Ferramenta -->
<div class="kb-modal-overlay d-none" id="tool-modal">
    <div class="kb-modal" style="max-width: 500px;">
        <div class="kb-modal-header">
            <h3 id="tool-modal-title">Nome da Ferramenta</h3>
            <button class="btn-close" id="close-tool-modal"></button>
        </div>
        <div class="kb-modal-content">
            <div class="text-center mb-4">
                <div class="kb-tool-icon mx-auto" style="width: 80px; height: 80px; font-size: 32px;">
                    <i class="bi bi-robot"></i>
                </div>
            </div>
            <h5 class="fw-bold mb-3">Sobre a ferramenta</h5>
            <p id="tool-modal-desc" class="text-muted" style="font-size: 1.1em; line-height: 1.6;"></p>

            <div class="mt-4 pt-3 border-top">
                <h6 class="fw-bold mb-2 small text-uppercase text-muted">Categoria</h6>
                <span id="tool-modal-badge" class="badge bg-light text-dark border">Categoria</span>
            </div>
        </div>
        <div class="kb-modal-footer">
            <button class="btn btn-light" id="btn-close-tool">Fechar</button>
            <a href="#" target="_blank" id="btn-access-tool" class="btn btn-primary d-flex align-items-center gap-2">
                Acessar Ferramenta <i class="bi bi-box-arrow-up-right"></i>
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // --- Navegação (Disponível Globalmente) ---
    window.switchView = function (view, category = '') {
        console.log('Switching to view:', view, 'category:', category);
        currentView = view;
        currentCategory = category;

        const cardsGrid = document.getElementById('view-cards');
        const listView = document.getElementById('view-list');
        const toolsView = document.getElementById('view-tools');

        if (cardsGrid) cardsGrid.classList.add('d-none');
        if (listView) listView.classList.add('d-none');
        if (toolsView) toolsView.classList.add('d-none');

        if (view === 'cards') {
            if (cardsGrid) cardsGrid.classList.remove('d-none');
            updateCounts();
        } else if (view === 'list') {
            if (listView) listView.classList.remove('d-none');
            const listTitle = document.getElementById('list-title');
            if (listTitle) {
                listTitle.textContent = category === 'search' ? 'Resultados da Busca' : (categoryNames[category] || 'Artigos');
            }
            renderArticles();
        } else if (view === 'tools') {
            if (toolsView) toolsView.classList.remove('d-none');
            renderTools();
        }
    };

    // Variáveis globais
    let currentView = 'cards';
    let currentCategory = '';
    let articles = [];
    let tools = [];
    const canEdit = {% if can_edit %}true{% else %} false{% endif %};

    const categoryNames = {
        'tutorials': 'Tutoriais e Guias',
        'solutions': 'Soluções Comuns',
        'faq': 'Perguntas Frequentes',
        'troubleshooting': 'Resolução de Problemas',
        'training': 'Treinamentos'
    };

    // --- Fetch Data ---
    async function loadData() {
        try {
            const [artRes, toolRes] = await Promise.all([
                fetch('/api/kb/articles/'),
                fetch('/api/kb/tools/')
            ]);
            articles = await artRes.json();
            tools = await toolRes.json();
            updateCounts();
        } catch (err) {
            console.error('Erro ao carregar dados:', err);
        }
    }

    function updateCounts() {
        const counts = { tutorials: 0, solutions: 0, faq: 0, troubleshooting: 0, training: 0 };
        articles.forEach(a => { if (counts[a.categoria] !== undefined) counts[a.categoria]++; });

        const setCnt = (id, txt) => { const el = document.getElementById(id); if (el) el.textContent = txt; };
        setCnt('count-tutorials', `${counts.tutorials} artigos`);
        setCnt('count-solutions', `${counts.solutions} artigos`);
        setCnt('count-faq', `${counts.faq} artigos`);
        setCnt('count-troubleshooting', `${counts.troubleshooting} artigos`);
        setCnt('count-training', `${counts.training} cursos`);
        setCnt('count-tools', `${tools.length} ferramentas`);
    }

    // --- Renderers ---
    function renderArticles() {
        const container = document.getElementById('articles-list');
        if (!container) return;
        container.innerHTML = '';

        let filtered = articles;
        if (currentCategory !== 'search' && currentCategory !== '') {
            filtered = articles.filter(a => a.categoria === currentCategory);
        } else if (currentCategory === 'search') {
            const term = document.getElementById('kb-search-input')?.value.toLowerCase() || '';
            filtered = articles.filter(a =>
                a.titulo.toLowerCase().includes(term) ||
                a.conteudo.toLowerCase().includes(term) ||
                (a.tags && a.tags.some(t => t.toLowerCase().includes(term)))
            );
        }

        if (filtered.length === 0) {
            container.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-inbox fs-1 d-block mb-3"></i>Nenhum artigo encontrado</div>';
            return;
        }

        filtered.forEach(a => {
            const item = document.createElement('div');
            item.className = 'kb-article-item';

            // Renderização de Conteúdo Simplificada
            let renderedContent = a.conteudo || "";
            renderedContent = renderedContent.replace(/### (.*?)\n/g, '<h5 class="mt-3 mb-2 fw-bold text-primary">$1</h5>');
            renderedContent = renderedContent.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            renderedContent = renderedContent.replace(/^- (.*?)$/gm, '<div class="d-flex mb-1"><i class="bi bi-dot me-2"></i><span>$1</span></div>');
            renderedContent = renderedContent.replace(/^[⚠️❗] (.*?)$/gm, '<div class="alert alert-warning py-2 px-3 my-2 d-flex align-items-center gap-2"><i class="bi bi-exclamation-triangle-fill"></i><span>$1</span></div>');
            renderedContent = renderedContent.replace(/\n/g, '<br>');

            item.innerHTML = `
                <div class="kb-article-header">
                    <div class="kb-article-title-content">
                        <h4>${a.titulo}</h4>
                        <div class="kb-article-meta">
                            <span class="kb-article-views"><i class="bi bi-eye"></i> ${a.views || 0}</span>
                            <div class="kb-article-tags">
                                ${(a.tags || []).map(t => `<span class="kb-tag">${t}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="kb-article-actions">
                        ${canEdit ? `
                            <button class="kb-btn-action edit-btn" title="Editar"><i class="bi bi-pencil"></i></button>
                            <button class="kb-btn-action danger delete-btn" title="Excluir"><i class="bi bi-trash"></i></button>
                        ` : ''}
                        <i class="bi bi-chevron-down ms-2 text-muted chevron-icon"></i>
                    </div>
                </div>
                <div class="kb-article-content d-none">
                    <div class="kb-article-text">${renderedContent}</div>
                </div>
            `;

            const header = item.querySelector('.kb-article-header');
            const content = item.querySelector('.kb-article-content');
            const chevron = item.querySelector('.chevron-icon');

            header.onclick = (e) => {
                if (e.target.closest('.kb-btn-action')) return;
                const isExpanded = !content.classList.contains('d-none');
                if (!isExpanded) {
                    fetch(`/api/kb/articles/${a.id}/`).then(res => res.json()).then(data => { a.views = data.views; });
                }
                content.classList.toggle('d-none');
                chevron.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(180deg)';
                item.classList.toggle('expanded');
            };

            if (canEdit) {
                const editBtn = item.querySelector('.edit-btn');
                const deleteBtn = item.querySelector('.delete-btn');
                if (editBtn) editBtn.onclick = () => openModal(a);
                if (deleteBtn) deleteBtn.onclick = () => deleteArticle(a.id);
            }

            container.appendChild(item);
        });
    }

    // --- Tools Filters ---
    let currentToolCategory = 'all';

    window.filterTools = function (category, btn) {
        currentToolCategory = category;

        // Update pills
        document.querySelectorAll('.kb-tools-filters .btn').forEach(b => {
            b.classList.remove('active');
            b.classList.remove('btn-primary');
            b.classList.add('btn-outline-primary');
        });
        if (btn) {
            btn.classList.add('active');
            btn.classList.add('btn-primary');
            btn.classList.remove('btn-outline-primary');
        }

        renderTools();
    }

    function renderTools() {
        const container = document.getElementById('tools-grid');
        if (!container) return;
        container.innerHTML = '';

        let filtered = tools;
        if (currentToolCategory !== 'all') {
            filtered = tools.filter(t => t.categoria === currentToolCategory);
        }

        // Ordenar por título
        filtered.sort((a, b) => a.titulo.localeCompare(b.titulo));

        filtered.forEach(t => {
            const card = document.createElement('div');
            card.className = 'kb-tool-card';
            card.onclick = () => openToolModal(t);
            card.innerHTML = `
                <div class="kb-tool-icon"><i class="bi bi-robot"></i></div>
                <h4>${t.titulo}</h4>
                <p>Clique para ver detalhes</p>
                <div class="kb-tool-badge badge bg-light text-dark mb-2">${t.categoria}</div>
            `;
            container.appendChild(card);
        });
    }

    function openToolModal(tool) {
        const modal = document.getElementById('tool-modal');
        if (!modal) return;

        document.getElementById('tool-modal-title').textContent = tool.titulo;
        document.getElementById('tool-modal-desc').textContent = tool.descricao;
        document.getElementById('tool-modal-badge').textContent = tool.categoria;
        document.getElementById('btn-access-tool').href = tool.url;

        modal.classList.remove('d-none');
    }

    // --- Artigo Actions ---
    function openModal(article = null) {
        console.log('Opening modal for article:', article);
        const modal = document.getElementById('article-modal');
        const form = document.getElementById('article-form');
        if (!modal || !form) return;
        form.reset();

        if (article) {
            document.getElementById('modal-title').textContent = 'Editar Artigo';
            document.getElementById('article-id').value = article.id;
            document.getElementById('article-category').value = article.categoria;
            document.getElementById('article-title').value = article.titulo;
            document.getElementById('article-text').value = article.conteudo;
            document.getElementById('article-tags').value = (article.tags || []).join(', ');
        } else {
            document.getElementById('modal-title').textContent = 'Novo Artigo';
            document.getElementById('article-id').value = '';
            document.getElementById('article-category').value = (currentCategory === 'search' || currentCategory === '') ? 'tutorials' : currentCategory;
        }

        modal.classList.remove('d-none');
    }

    async function deleteArticle(id) {
        if (!confirm('Deseja excluir este artigo?')) return;
        try {
            const response = await fetch(`/api/kb/articles/${id}/`, {
                method: 'DELETE',
                headers: { 'X-CSRFToken': '{{ csrf_token }}' }
            });
            if (response.ok) {
                loadData().then(() => renderArticles());
            }
        } catch (err) {
            console.error('Erro ao excluir:', err);
        }
    }

    // --- Inicialização ---
    document.addEventListener('DOMContentLoaded', function () {
        loadData();

        // Event Listeners
        const btnSearch = document.getElementById('btn-search');
        if (btnSearch) btnSearch.onclick = () => switchView('list', 'search');

        const searchInput = document.getElementById('kb-search-input');
        if (searchInput) searchInput.onkeydown = (e) => { if (e.key === 'Enter') switchView('list', 'search'); };

        const btnNew = document.getElementById('btn-new-article');
        if (btnNew && canEdit) btnNew.onclick = () => openModal();

        const btnClose = document.getElementById('close-modal');
        if (btnClose) btnClose.onclick = () => document.getElementById('article-modal').classList.add('d-none');

        const btnCancel = document.getElementById('btn-cancel');
        if (btnCancel) btnCancel.onclick = () => document.getElementById('article-modal').classList.add('d-none');

        const modalOverlay = document.getElementById('article-modal');
        if (modalOverlay) {
            modalOverlay.onclick = (e) => {
                if (e.target === modalOverlay) modalOverlay.classList.add('d-none');
            };
        }

        // Tool Modal Listeners
        const toolModalOverlay = document.getElementById('tool-modal');
        const btnCloseTool = document.getElementById('close-tool-modal');
        const btnCloseToolFooter = document.getElementById('btn-close-tool');

        if (toolModalOverlay) {
            toolModalOverlay.onclick = (e) => {
                if (e.target === toolModalOverlay) toolModalOverlay.classList.add('d-none');
            };
        }
        if (btnCloseTool) btnCloseTool.onclick = () => toolModalOverlay.classList.add('d-none');
        if (btnCloseToolFooter) btnCloseToolFooter.onclick = () => toolModalOverlay.classList.add('d-none');

        const articleForm = document.getElementById('article-form');
        if (articleForm) {
            articleForm.onsubmit = async (e) => {
                e.preventDefault();
                const id = document.getElementById('article-id').value;
                const data = {
                    titulo: document.getElementById('article-title').value,
                    conteudo: document.getElementById('article-text').value,
                    categoria: document.getElementById('article-category').value,
                    tags: document.getElementById('article-tags').value
                };

                const url = id ? `/api/kb/articles/${id}/` : '/api/kb/articles/create/';
                const method = id ? 'PUT' : 'POST';

                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                        body: JSON.stringify(data)
                    });
                    if (response.ok) {
                        modalOverlay.classList.add('d-none');
                        loadData().then(() => { if (currentView === 'list') renderArticles(); });
                    }
                } catch (err) {
                    console.error('Erro ao salvar:', err);
                }
            };
        }
    });
</script>
{% endblock %}