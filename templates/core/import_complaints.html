{% extends 'base.html' %}
{% load static %}

{% block title %}Importar Reclamações{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-upload"></i> Importar Reclamações do XLSX
                    </h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h5><i class="bi bi-info-circle"></i> Formato da Planilha</h5>
                        <p class="mb-2">A planilha deve conter as seguintes colunas na ordem especificada:</p>
                        <ul class="mb-0">
                            <li><strong>Coluna A:</strong> LOJA (Código da loja)</li>
                            <li><strong>Coluna B:</strong> NOME (Nome completo do cliente)</li>
                            <li><strong>Coluna C:</strong> ID (ID RA da reclamação)</li>
                            <li><strong>Coluna D:</strong> CPF (CPF do cliente)</li>
                            <li><strong>Coluna E:</strong> E-MAIL (E-mail do cliente)</li>
                            <li><strong>Coluna F:</strong> TELEFONE (Telefone do cliente)</li>
                            <li><strong>Coluna G:</strong> DATA DA RECLAMAÇÃO</li>
                            <li><strong>Coluna H:</strong> PROBLEMA (Tipo da reclamação)</li>
                            <li><strong>Coluna I:</strong> STATUS</li>
                            <li><strong>Coluna J:</strong> Responsável (Nome do responsável pela reclamação)</li>
                            <li><strong>Coluna K:</strong> NOTA (Nota de satisfação de 0 a 10)</li>
                            <li><strong>Coluna L:</strong> VOLTARIA A FAZER NEGÓCIOS? (Sim/Não)</li>
                        </ul>
                    </div>

                    <form method="post" enctype="multipart/form-data" id="importForm">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="xlsx_file" class="form-label">
                                <strong>Selecione o arquivo XLSX:</strong>
                            </label>
                            <input type="file" class="form-control" id="xlsx_file" name="xlsx_file" accept=".xlsx,.xls"
                                required>
                            <small class="form-text text-muted">
                                Apenas arquivos .xlsx ou .xls são aceitos.
                            </small>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'complaint_list' %}" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary" id="btnImport">
                                <i class="bi bi-upload"></i> Importar Dados
                            </button>
                        </div>
                    </form>

                    <div class="mt-4">
                        <h5>Observações Importantes:</h5>
                        <ul>
                            <li>A primeira linha da planilha será ignorada (cabeçalho)</li>
                            <li>Reclamações com o mesmo ID RA serão atualizadas se já existirem</li>
                            <li>Se o responsável não for encontrado, a reclamação ficará sem atribuição</li>
                            <li>CPFs serão formatados automaticamente (apenas números são salvos)</li>
                            <li>Nomes serão divididos automaticamente em nome e sobrenome</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Progress Modal -->
<div class="modal fade" id="progressModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Importando Reclamações</h5>
            </div>
            <div class="modal-body">
                <p id="progressStatus" class="mb-2">Preparando...</p>
                <div class="progress mb-3" style="height: 25px;">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                        role="progressbar" style="width: 0%">0%</div>
                </div>
                <div class="row text-center text-muted small">
                    <div class="col-4">
                        <div id="statTotal">Total: 0</div>
                    </div>
                    <div class="col-4">
                        <div id="statProcessed">Processados: 0</div>
                    </div>
                    <div class="col-4">
                        <div id="statTime">Tempo: 0s</div>
                    </div>
                </div>
                <div id="errorContainer" class="alert alert-danger mt-3 d-none"
                    style="max-height: 150px; overflow-y: auto;">
                    <ul id="errorList" class="mb-0 small"></ul>
                </div>
            </div>
            <div class="modal-footer d-none" id="modalFooter">
                <button type="button" class="btn btn-primary" onclick="window.location.reload()">Concluir</button>
            </div>
        </div>
    </div>
</div>

<!-- SheetJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
    document.getElementById('importForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const fileInput = document.getElementById('xlsx_file');
        if (!fileInput.files.length) {
            alert('Selecione um arquivo!');
            return;
        }

        const file = fileInput.files[0];
        const reader = new FileReader();

        // Show Modal
        const modalEl = document.getElementById('progressModal');
        const modal = new bootstrap.Modal(modalEl);
        modal.show();

        // Reset UI
        document.getElementById('progressBar').style.width = '0%';
        document.getElementById('progressBar').textContent = '0%';
        document.getElementById('progressStatus').textContent = 'Lendo arquivo...';
        document.getElementById('modalFooter').classList.add('d-none');
        document.getElementById('errorContainer').classList.add('d-none');
        document.getElementById('errorList').innerHTML = '';

        const startTime = Date.now();
        const updateTimer = setInterval(() => {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            document.getElementById('statTime').textContent = `Tempo: ${elapsed}s`;
        }, 1000);

        reader.onload = function (e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                // Assume first sheet
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];

                // Convert to JSON (array of arrays)
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                if (jsonData.length < 2) {
                    alert('O arquivo parece vazio ou sem cabeçalho.');
                    modal.hide();
                    clearInterval(updateTimer);
                    return;
                }

                // Remove header
                const rows = jsonData.slice(1);
                const totalRows = rows.length;
                const batchSize = 50;
                let processedCount = 0;
                let currentBatchIndex = 0;
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                document.getElementById('statTotal').textContent = `Total: ${totalRows}`;
                document.getElementById('progressStatus').textContent = 'Iniciando importação...';

                async function processNextBatch() {
                    if (currentBatchIndex >= rows.length) {
                        // Finished
                        clearInterval(updateTimer);
                        document.getElementById('progressBar').classList.remove('progress-bar-animated');
                        document.getElementById('progressBar').classList.add('bg-success');
                        document.getElementById('progressStatus').textContent = 'Concluído!';
                        document.getElementById('modalFooter').classList.remove('d-none');
                        return;
                    }

                    const batch = rows.slice(currentBatchIndex, currentBatchIndex + batchSize);

                    try {
                        const response = await fetch("{% url 'import_complaints_batch' %}", {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken
                            },
                            body: JSON.stringify({ rows: batch })
                        });

                        if (!response.ok) throw new Error('Erro na comunicação com servidor');

                        const result = await response.json();

                        if (result.error) {
                            const li = document.createElement('li');
                            li.textContent = `Erro no lote: ${result.error}`;
                            document.getElementById('errorList').appendChild(li);
                            document.getElementById('errorContainer').classList.remove('d-none');
                        } else if (result.errors && result.errors.length > 0) {
                            result.errors.forEach(err => {
                                const li = document.createElement('li');
                                li.textContent = err;
                                document.getElementById('errorList').appendChild(li);
                            });
                            document.getElementById('errorContainer').classList.remove('d-none');
                        }

                        processedCount += batch.length;
                        currentBatchIndex += batchSize;

                        // Update UI
                        const percent = Math.min(100, Math.round((processedCount / totalRows) * 100));
                        document.getElementById('progressBar').style.width = `${percent}%`;
                        document.getElementById('progressBar').textContent = `${percent}%`;
                        document.getElementById('statProcessed').textContent = `Processados: ${Math.min(processedCount, totalRows)}`;

                        // Estimate remaining time
                        const elapsed = (Date.now() - startTime) / 1000;
                        const itemsPerSec = processedCount / elapsed;
                        const remaining = (totalRows - processedCount) / itemsPerSec;
                        if (itemsPerSec > 0) {
                            document.getElementById('progressStatus').textContent = `Importando... (~${Math.ceil(remaining)}s restantes)`;
                        }

                        // Next batch
                        processNextBatch();

                    } catch (err) {
                        console.error(err);
                        const li = document.createElement('li');
                        li.textContent = `Erro de rede/servidor: ${err.message}`;
                        document.getElementById('errorList').appendChild(li);
                        document.getElementById('errorContainer').classList.remove('d-none');

                        // Continue anyway? Or stop?
                        // Let's stop to avoid cascading failures if auth is lost
                        clearInterval(updateTimer);
                        document.getElementById('progressStatus').textContent = 'Erro fatal na importação.';
                        document.getElementById('progressBar').classList.add('bg-danger');
                        document.getElementById('modalFooter').classList.remove('d-none');
                    }
                }

                processNextBatch();

            } catch (e) {
                console.error(e);
                alert('Erro ao ler arquivo: ' + e.message);
                modal.hide();
                clearInterval(updateTimer);
            }
        };

        reader.readAsArrayBuffer(file);
    });
</script>
{% endblock %}