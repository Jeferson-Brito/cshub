{% extends 'base.html' %}

{% block content %}
{% csrf_token %}
<div class="container-fluid">

    <!-- Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="page-title"><i class="bi bi-receipt-cutoff"></i> {{ title }}</h1>
                <p class="page-subtitle">Gerencie as solicitações de estorno dos clientes</p>
            </div>
            <div class="d-flex gap-2 align-items-center">
                <input type="text" class="form-control" id="searchInput"
                    placeholder="Buscar por ID, nome, CPF, email..." style="width: 280px;" onkeyup="searchRefunds()">
                <select id="statusFilter" class="form-select" style="width: auto;" onchange="loadRefunds()">
                    <option value="">Todos os Status</option>
                    <option value="aberta">Abertas</option>
                    <option value="em_analise">Em Análise</option>
                    <option value="concluida">Concluídas</option>
                    <option value="cancelada">Canceladas</option>
                </select>
            </div>
        </div>
    </div>


    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-6 col-lg-3 mb-3">
            <div class="stat-card stat-card-primary">
                <div class="stat-card-icon"><i class="bi bi-inbox"></i></div>
                <p class="stat-card-title">Total Recebidas</p>
                <h2 class="stat-card-value" id="stat-total">0</h2>
            </div>
        </div>
        <div class="col-6 col-lg-3 mb-3">
            <div class="stat-card stat-card-warning">
                <div class="stat-card-icon"><i class="bi bi-hourglass-split"></i></div>
                <p class="stat-card-title">Pendentes</p>
                <h2 class="stat-card-value" id="stat-pending">0</h2>
            </div>
        </div>
        <div class="col-6 col-lg-3 mb-3">
            <div class="stat-card stat-card-info">
                <div class="stat-card-icon"><i class="bi bi-search"></i></div>
                <p class="stat-card-title">Em Análise</p>
                <h2 class="stat-card-value" id="stat-analysis">0</h2>
            </div>
        </div>
        <div class="col-6 col-lg-3 mb-3">
            <div class="stat-card stat-card-success">
                <div class="stat-card-icon"><i class="bi bi-check-circle"></i></div>
                <p class="stat-card-title">Resolvidas</p>
                <h2 class="stat-card-value" id="stat-resolved">0</h2>
            </div>
        </div>
    </div>


    <!-- Refund Requests Table -->
    <div class="card">
        <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-list-ul text-primary"></i> Lista de Solicitações</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="refundsTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Analista</th>
                            <th>Loja</th>
                            <th>Cliente</th>
                            <th>Valor</th>
                            <th>Tipo</th>
                            <th>Status</th>
                            <th>Data</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="refunds-list">
                        <tr>
                            <td colspan="9" class="text-center py-4">
                                <div class="spinner-border text-primary" role="status"></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Detalhes -->
<div class="modal fade" id="refundDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-receipt"></i> Detalhes da Solicitação #<span
                        id="detail-id"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detail-content">
                <!-- Preenchido via JS -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-warning" onclick="updateStatus('em_analise')">
                    <i class="bi bi-search"></i> Em Análise
                </button>
                <button type="button" class="btn btn-success" onclick="updateStatus('concluida')">
                    <i class="bi bi-check-lg"></i> Concluída
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Upload Anexo -->
<div class="modal fade" id="attachmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-paperclip"></i> Adicionar Anexo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="attachmentForm" enctype="multipart/form-data">
                    <input type="hidden" id="attachment-refund-id">
                    <div class="mb-3">
                        <label class="form-label">Arquivo</label>
                        <input type="file" class="form-control" name="file" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descrição (opcional)</label>
                        <input type="text" class="form-control" name="description"
                            placeholder="Ex: Comprovante de estorno">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="uploadAttachment()">Enviar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Editar Solicitação -->
<div class="modal fade" id="editRefundModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil-square text-warning"></i> Editar Solicitação #<span
                        id="edit-id"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editRefundForm">
                    <input type="hidden" name="refund_id" id="edit-refund-id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Código da Loja</label>
                            <input type="text" class="form-control" name="store_code" id="edit-store-code" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nome do Cliente</label>
                            <input type="text" class="form-control" name="customer_name" id="edit-customer-name"
                                required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">CPF do Cliente</label>
                            <input type="text" class="form-control" name="customer_cpf" id="edit-customer-cpf" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">E-mail do Cliente</label>
                            <input type="email" class="form-control" name="customer_email" id="edit-customer-email"
                                required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Telefone do Cliente</label>
                            <input type="text" class="form-control" name="customer_phone" id="edit-customer-phone"
                                required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Valor do Estorno</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control" name="refund_value" id="edit-refund-value"
                                    required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Motivo da Solicitação</label>
                        <textarea class="form-control" name="reason" id="edit-reason" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Resumo do Atendimento</label>
                        <textarea class="form-control" name="summary" id="edit-summary" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Chave PIX</label>
                        <input type="text" class="form-control" name="pix_key" id="edit-pix-key">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="saveEditRefund()">
                    <i class="bi bi-check-lg"></i> Salvar Alterações
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let currentRefundId = null;

    document.addEventListener('DOMContentLoaded', function () {
        loadStats();
        loadRefunds();
        // Poll for new refund notifications
        setInterval(checkRefundNotifications, 30000);
        checkRefundNotifications();
    });

    async function loadStats() {
        try {
            const res = await fetch('/api/refunds/stats/');
            if (res.ok) {
                const data = await res.json();
                document.getElementById('stat-total').textContent = data.total;
                document.getElementById('stat-pending').textContent = data.pending;
                document.getElementById('stat-analysis').textContent = data.in_analysis;
                document.getElementById('stat-resolved').textContent = data.resolved;
            }
        } catch (e) {
            console.error('Erro ao carregar estatísticas', e);
        }
    }

    let searchTimeout;

    async function loadRefunds() {
        const statusFilter = document.getElementById('statusFilter').value;
        const search = document.getElementById('searchInput')?.value || '';

        let url = '/api/refunds/list/?';
        if (statusFilter) url += `status=${statusFilter}&`;
        if (search) url += `search=${encodeURIComponent(search)}`;

        try {
            const res = await fetch(url);
            if (res.ok) {
                const data = await res.json();
                renderRefunds(data.refunds);
            }
        } catch (e) {
            console.error('Erro ao carregar solicitações', e);
        }
    }

    function searchRefunds() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(loadRefunds, 300);
    }


    function renderRefunds(refunds) {
        const tbody = document.getElementById('refunds-list');
        if (refunds.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4">Nenhuma solicitação encontrada</td></tr>';
            return;
        }

        tbody.innerHTML = refunds.map(r => {
            const statusBadge = getStatusBadge(r.status);
            const date = new Date(r.created_at).toLocaleDateString('pt-BR');
            const cancelBadge = r.cancellation_requested ? '<span class="badge bg-danger ms-1" title="Cancelamento Solicitado">!</span>' : '';
            const rowClass = r.cancellation_requested ? 'table-danger' : '';

            return `
                <tr class="${rowClass}">
                    <td><strong>#${r.id}</strong>${cancelBadge}</td>
                    <td>${r.analyst_name}</td>
                    <td><span class="badge bg-secondary">${r.store_code}</span></td>
                    <td>${r.customer_name}<br><small class="text-muted">${r.customer_cpf}</small></td>
                    <td><strong>R$ ${parseFloat(r.refund_value).toFixed(2)}</strong></td>
                    <td>${r.refund_type}</td>
                    <td>${statusBadge}</td>
                    <td>${date}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="openDetail(${r.id})" title="Ver Detalhes">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="openEditModal(${r.id})" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="openAttachmentModal(${r.id})" title="Anexar">
                            <i class="bi bi-paperclip"></i>
                        </button>
                        {% if user.role == 'gestor' or user.role == 'administrador' %}
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteRefund(${r.id})" title="Excluir">
                            <i class="bi bi-trash"></i>
                        </button>
                        {% endif %}
                    </td>
                </tr>
            `;
        }).join('');

    }

    function getStatusBadge(status) {
        const badges = {
            'aberta': '<span class="badge bg-warning text-dark"><i class="bi bi-circle-fill"></i> Aberta</span>',
            'em_analise': '<span class="badge bg-info"><i class="bi bi-search"></i> Em Análise</span>',
            'concluida': '<span class="badge bg-success"><i class="bi bi-check-lg"></i> Concluída</span>',
            'cancelada': '<span class="badge bg-danger"><i class="bi bi-x-lg"></i> Cancelada</span>'
        };
        return badges[status] || status;
    }


    async function openDetail(id) {
        currentRefundId = id;
        document.getElementById('detail-id').textContent = id;

        try {
            const res = await fetch(`/api/refunds/${id}/`);
            if (res.ok) {
                const data = await res.json();
                const r = data.refund;

                let attachmentsHtml = '';
                if (r.attachments && r.attachments.length > 0) {
                    attachmentsHtml = '<h6 class="mt-4"><i class="bi bi-paperclip"></i> Anexos</h6><ul class="list-group">';
                    r.attachments.forEach(att => {
                        attachmentsHtml += `
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>${att.description || 'Anexo'} - <small class="text-muted">${att.uploaded_by}</small></span>
                                <a href="${att.file_url}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-download"></i></a>
                            </li>
                        `;
                    });
                    attachmentsHtml += '</ul>';
                }

                let cancellationHtml = '';
                if (r.cancellation_requested) {
                    cancellationHtml = `
                        <div class="alert alert-danger mb-4 border-2">
                            <h6 class="alert-heading d-flex align-items-center">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i> 
                                PEDIDO DE CANCELAMENTO SOLICITADO
                            </h6>
                            <hr>
                            <p class="mb-0"><strong>Solicitado por:</strong> ${r.cancellation_requested_by} em ${new Date(r.cancellation_requested_at).toLocaleString('pt-BR')}</p>
                            <p class="mb-2"><strong>Motivo:</strong> <span class="text-dark">${r.cancellation_reason || 'Nenhum motivo informado'}</span></p>
                            <button type="button" class="btn btn-danger btn-sm w-100" onclick="updateStatus('cancelada')">
                                <i class="bi bi-x-circle-fill"></i> EFETIVAR CANCELAMENTO
                            </button>
                        </div>
                    `;
                }

                document.getElementById('detail-content').innerHTML = `
                    ${cancellationHtml}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-item">
                                <p class="info-label"><i class="bi bi-person"></i> Analista Solicitante</p>
                                <p class="info-value">${r.analyst_name}</p>
                            </div>
                            <div class="info-item">
                                <p class="info-label"><i class="bi bi-shop"></i> Código da Loja</p>
                                <p class="info-value">${r.store_code}</p>
                            </div>
                            <div class="info-item">
                                <p class="info-label"><i class="bi bi-person-badge"></i> Cliente</p>
                                <p class="info-value">${r.customer_name}</p>
                            </div>
                            <div class="info-item">
                                <p class="info-label"><i class="bi bi-card-text"></i> CPF</p>
                                <p class="info-value">${r.customer_cpf}</p>
                            </div>
                            <div class="info-item">
                                <p class="info-label"><i class="bi bi-envelope"></i> E-mail</p>
                                <p class="info-value">${r.customer_email}</p>
                            </div>
                            <div class="info-item">
                                <p class="info-label"><i class="bi bi-telephone"></i> Telefone</p>
                                <p class="info-value">${r.customer_phone}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-item">
                                <p class="info-label"><i class="bi bi-calendar"></i> Data do Ocorrido</p>
                                <p class="info-value">${new Date(r.incident_date).toLocaleDateString('pt-BR')}</p>
                            </div>
                            <div class="info-item">
                                <p class="info-label"><i class="bi bi-geo-alt"></i> Local da Compra</p>
                                <p class="info-value">${r.purchase_location}</p>
                            </div>
                            <div class="info-item">
                                <p class="info-label"><i class="bi bi-camera-video"></i> Verificou Câmeras?</p>
                                <p class="info-value">${r.checked_cameras ? 'Sim' : 'Não'}</p>
                            </div>
                            <div class="info-item">
                                <p class="info-label"><i class="bi bi-cash"></i> Valor do Estorno</p>
                                <p class="info-value"><strong>R$ ${parseFloat(r.refund_value).toFixed(2)}</strong></p>
                            </div>
                            <div class="info-item">
                                <p class="info-label"><i class="bi bi-credit-card"></i> Tipo de Estorno</p>
                                <p class="info-value">${r.refund_type}</p>
                            </div>
                            ${r.pix_key ? `<div class="info-item"><p class="info-label"><i class="bi bi-key"></i> Chave PIX</p><p class="info-value">${r.pix_key}</p></div>` : ''}
                        </div>
                    </div>
                    <div class="info-item mt-3">
                        <p class="info-label"><i class="bi bi-question-circle"></i> Motivo da Solicitação</p>
                        <div class="description-box">${r.reason}</div>
                    </div>
                    <div class="info-item mt-3">
                        <p class="info-label"><i class="bi bi-file-text"></i> Resumo do Atendimento</p>
                        <div class="description-box">${r.summary}</div>
                    </div>
                    ${attachmentsHtml}
                `;

                new bootstrap.Modal(document.getElementById('refundDetailModal')).show();
            }
        } catch (e) {
            console.error('Erro ao carregar detalhes', e);
            window.showToast('Erro ao carregar detalhes', 'error');
        }

    }

    async function updateStatus(newStatus) {
        if (!currentRefundId) return;

        if (newStatus === 'cancelada') {
            const result = await Swal.fire({
                title: 'Efetivar Cancelamento',
                text: 'Você tem certeza que deseja EFETIVAR o cancelamento desta solicitação? Esta ação é irreversível.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sim, efetivar!',
                cancelButtonText: 'Voltar'
            });
            if (!result.isConfirmed) return;
        }


        try {

            const res = await fetch(`/api/refunds/${currentRefundId}/status/`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({ status: newStatus })
            });

            if (res.ok) {
                const data = await res.json();
                window.showToast(data.message, 'success');
                bootstrap.Modal.getInstance(document.getElementById('refundDetailModal')).hide();
                loadStats();
                loadRefunds();
            } else {
                const err = await res.json();
                window.showToast(err.error || 'Erro ao atualizar status', 'error');
            }
        } catch (e) {
            console.error('Erro ao atualizar status', e);
            window.showToast('Erro ao atualizar status', 'error');
        }
    }

    function openAttachmentModal(id) {
        document.getElementById('attachment-refund-id').value = id;
        document.getElementById('attachmentForm').reset();
        new bootstrap.Modal(document.getElementById('attachmentModal')).show();
    }

    async function uploadAttachment() {
        const refundId = document.getElementById('attachment-refund-id').value;
        const form = document.getElementById('attachmentForm');
        const formData = new FormData(form);

        try {
            const res = await fetch(`/api/refunds/${refundId}/attachment/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken()
                },
                body: formData
            });

            if (res.ok) {
                const data = await res.json();
                window.showToast(data.message, 'success');
                bootstrap.Modal.getInstance(document.getElementById('attachmentModal')).hide();
            } else {
                const err = await res.json();
                window.showToast(err.error || 'Erro ao enviar anexo', 'error');
            }
        } catch (e) {
            console.error('Erro ao enviar anexo', e);
            window.showToast('Erro ao enviar anexo', 'error');
        }
    }

    async function checkRefundNotifications() {
        try {
            const res = await fetch('/api/refunds/notifications/');
            if (res.ok) {
                const data = await res.json();
                if (data.has_notifications && data.notifications) {
                    data.notifications.forEach(n => {
                        window.showToast(n.message, n.type === 'new_refund' ? 'info' : 'success');
                    });
                    // Play notification sound
                    const audio = document.getElementById('notificationSound');
                    if (audio) audio.play().catch(e => { });
                    // Reload data
                    loadStats();
                    loadRefunds();
                }
            }
        } catch (e) {
            console.error('Erro ao verificar notificações', e);
        }
    }

    async function deleteRefund(id) {
        const result = await Swal.fire({
            title: 'Excluir Solicitação',
            text: `Deseja realmente excluir a solicitação #${id}? Esta ação não pode ser desfeita.`,
            icon: 'error',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Sim, excluir!',
            cancelButtonText: 'Cancelar'
        });

        if (!result.isConfirmed) return;

        try {
            const res = await fetch(`/api/refunds/${id}/delete/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            });

            if (res.ok) {
                const data = await res.json();
                Swal.fire('Excluído!', data.message, 'success');
                loadRefunds();
                loadStats();
            } else {
                const err = await res.json();
                Swal.fire('Erro!', err.error || 'Erro ao excluir', 'error');
            }
        } catch (e) {
            console.error('Erro ao excluir', e);
            Swal.fire('Erro!', 'Erro de conexão', 'error');
        }
    }


    async function openEditModal(id) {
        try {
            const res = await fetch(`/api/refunds/${id}/`);
            if (res.ok) {
                const data = await res.json();
                const r = data.refund;

                document.getElementById('edit-id').textContent = r.id;
                document.getElementById('edit-refund-id').value = r.id;
                document.getElementById('edit-store-code').value = r.store_code;
                document.getElementById('edit-customer-name').value = r.customer_name;
                document.getElementById('edit-customer-cpf').value = r.customer_cpf;
                document.getElementById('edit-customer-email').value = r.customer_email;
                document.getElementById('edit-customer-phone').value = r.customer_phone;
                document.getElementById('edit-refund-value').value = parseFloat(r.refund_value).toFixed(2);
                document.getElementById('edit-reason').value = r.reason;
                document.getElementById('edit-summary').value = r.summary || '';
                document.getElementById('edit-pix-key').value = r.pix_key || '';

                new bootstrap.Modal(document.getElementById('editRefundModal')).show();
            } else {
                window.showToast('Erro ao carregar dados da solicitação', 'error');
            }
        } catch (e) {
            console.error('Erro ao abrir edição', e);
            window.showToast('Erro ao carregar dados', 'error');
        }
    }

    async function saveEditRefund() {
        const form = document.getElementById('editRefundForm');
        const id = document.getElementById('edit-refund-id').value;

        const data = {
            store_code: document.getElementById('edit-store-code').value,
            customer_name: document.getElementById('edit-customer-name').value,
            customer_cpf: document.getElementById('edit-customer-cpf').value,
            customer_email: document.getElementById('edit-customer-email').value,
            customer_phone: document.getElementById('edit-customer-phone').value,
            refund_value: document.getElementById('edit-refund-value').value.replace(',', '.'),
            reason: document.getElementById('edit-reason').value,
            summary: document.getElementById('edit-summary').value,
            pix_key: document.getElementById('edit-pix-key').value
        };

        try {
            const res = await fetch(`/api/refunds/${id}/edit/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                const result = await res.json();
                window.showToast(result.message, 'success');
                bootstrap.Modal.getInstance(document.getElementById('editRefundModal')).hide();
                loadRefunds();
                loadStats();
            } else {
                const err = await res.json();
                window.showToast(err.error || 'Erro ao salvar', 'error');
            }
        } catch (e) {
            console.error('Erro ao salvar edição', e);
            window.showToast('Erro de conexão', 'error');
        }
    }


    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
            document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1] || '';
    }
</script>
{% endblock %}