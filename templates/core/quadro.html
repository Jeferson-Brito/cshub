{% extends 'base.html' %}
{% load static %}

{% block title %}Quadro de Tarefas - Nexus{% endblock %}

{% block extra_css %}
<style>
    /* Kanban Board Styles */
    .kanban-page {
        padding: 0;
        display: flex;
        flex-direction: column;
        height: calc(100vh - 80px);
        overflow: hidden;
    }

    .kanban-page-header {
        background: var(--white);
        border-radius: 12px;
        border: 1px solid var(--light-gray);
        box-shadow: var(--shadow-md);
        padding: 16px 24px;
        margin-bottom: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        flex-shrink: 0;
    }

    .kanban-page-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--gradient-primary);
        border-radius: 12px 12px 0 0;
    }

    .kanban-page-title {
        font-size: 24px;
        font-weight: 700;
        color: var(--dark-color);
        display: flex;
        align-items: center;
        gap: 12px;
        margin: 0;
    }

    .kanban-page-title i {
        color: var(--primary-color);
    }

    .kanban-board-area {
        flex: 1;
        background: white;
        border-radius: 12px;
        border: 1px solid var(--light-gray);
        box-shadow: var(--shadow-md);
        padding: 16px;
        overflow-x: auto;
        min-height: 0;
    }

    .kanban-board-content {
        display: flex;
        gap: 16px;
        height: 100%;
        align-items: flex-start;
    }

    .kanban-list {
        min-width: 280px;
        max-width: 280px;
        background: #f8fafc;
        border-radius: 12px;
        border: 1px solid var(--light-gray);
        display: flex;
        flex-direction: column;
        max-height: 100%;
        flex-shrink: 0;
    }

    .kanban-list-header {
        padding: 14px 16px;
        border-bottom: 1px solid var(--light-gray);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: white;
        border-radius: 12px 12px 0 0;
    }

    .kanban-list-title {
        font-size: 13px;
        font-weight: 700;
        color: var(--dark-color);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin: 0;
    }

    .kanban-list-count {
        background: var(--light-gray);
        color: var(--medium-gray);
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 12px;
        font-weight: 600;
        margin-right: auto;
        margin-left: 8px;
    }

    .kanban-list-menu-btn {
        background: none;
        border: none;
        color: var(--medium-gray);
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .kanban-list-menu-btn:hover {
        background: var(--light-gray);
        color: var(--dark-color);
    }

    /* List Action Menu Dropdown */
    .list-menu-dropdown {
        display: none;
        position: absolute;
        background: white;
        border: 1px solid var(--light-gray);
        border-radius: 8px;
        padding: 8px 0;
        box-shadow: var(--shadow-lg);
        z-index: 100;
        min-width: 180px;
    }

    .list-menu-dropdown.show {
        display: block;
    }

    .list-menu-item {
        padding: 8px 16px;
        font-size: 13px;
        color: var(--dark-color);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: background 0.2s;
    }

    .list-menu-item:hover {
        background: #f1f5f9;
    }

    .list-menu-item.danger {
        color: #ef4444;
    }

    .list-menu-item.danger:hover {
        background: #fee2e2;
    }

    .kanban-cards {
        flex: 1;
        overflow-y: auto;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        min-height: 100px;
    }

    .kanban-card {
        background: white;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        cursor: pointer;
        transition: all 0.2s ease;
        overflow: hidden;
        position: relative;
    }

    .kanban-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 0;
        background: linear-gradient(135deg, var(--primary-color) 0%, #6366f1 100%);
        transition: height 0.2s ease;
        opacity: 0.1;
    }

    .kanban-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        border-color: var(--primary-color);
    }

    .kanban-card:hover::before {
        height: 100%;
    }

    .kanban-card-cover {
        height: 45px;
        width: 100%;
        border-radius: 10px 10px 0 0;
        background-size: cover;
        background-position: center;
    }

    .kanban-card-content {
        padding: 12px 14px;
        position: relative;
        z-index: 1;
    }

    .kanban-card-labels {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-bottom: 10px;
    }

    .kanban-card-label {
        min-width: 40px;
        height: 8px;
        border-radius: 4px;
        display: inline-block;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        font-size: 0;
        color: transparent;
        overflow: hidden;
        vertical-align: middle;
    }

    .kanban-card-label:hover {
        height: 18px;
        padding: 0 10px;
        font-size: 11px;
        font-weight: 600;
        color: white;
        text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
        line-height: 18px;
    }

    .kanban-card-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 10px;
        line-height: 1.4;
    }

    .kanban-card-meta {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    .kanban-card-due {
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        background: #f1f5f9;
        color: #64748b;
    }

    .kanban-card-due.overdue {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        color: #dc2626;
    }

    .kanban-card-due.completed {
        background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        color: #16a34a;
    }

    .kanban-card-due i {
        font-size: 12px;
    }

    .kanban-card-icons {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #94a3b8;
        font-size: 12px;
        margin-left: auto;
    }

    .kanban-card-icon {
        display: flex;
        align-items: center;
        gap: 3px;
        opacity: 0.7;
    }

    .kanban-card-icon i {
        font-size: 14px;
    }

    .kanban-card-progress {
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 3px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        background: linear-gradient(135deg, #e0f2fe 0%, #bfdbfe 100%);
        color: #0369a1;
    }

    .kanban-card-progress.complete {
        background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        color: #16a34a;
    }

    .kanban-add-card {
        padding: 12px;
    }

    .kanban-add-list {
        min-width: 280px;
        max-width: 280px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        border: 2px dashed var(--light-gray);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 16px;
        cursor: pointer;
        transition: all 0.2s;
        flex-shrink: 0;
        gap: 8px;
        color: var(--medium-gray);
        font-weight: 500;
    }

    .kanban-add-list:hover {
        background: rgba(255, 255, 255, 0.6);
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    .kanban-add-list-form {
        display: none;
        width: 100%;
    }

    .kanban-add-list-form.show {
        display: block;
    }

    .kanban-add-list-form input {
        width: 100%;
        padding: 10px;
        border: 2px solid var(--light-gray);
        border-radius: 8px;
        font-size: 14px;
        margin-bottom: 8px;
    }

    .kanban-add-list-form input:focus {
        border-color: var(--primary-color);
        outline: none;
    }

    .kanban-add-list-actions {
        display: flex;
        gap: 8px;
    }

    .kanban-add-card-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--medium-gray);
        font-weight: 500;
        padding: 10px;
        width: 100%;
        border: 2px dashed var(--light-gray);
        background: transparent;
        cursor: pointer;
        border-radius: 8px;
        transition: var(--transition);
        font-size: 14px;
    }

    .kanban-add-card-btn:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
        background: rgba(37, 99, 235, 0.05);
    }

    .add-card-form {
        display: none;
    }

    .add-card-form.show {
        display: block;
    }

    .add-card-form textarea {
        width: 100%;
        padding: 10px;
        border: 2px solid var(--light-gray);
        border-radius: 8px;
        font-size: 14px;
        resize: none;
        min-height: 60px;
        margin-bottom: 8px;
    }

    .add-card-form textarea:focus {
        border-color: var(--primary-color);
        outline: none;
    }

    .add-card-actions {
        display: flex;
        gap: 8px;
    }

    .btn-add {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
    }

    .btn-cancel {
        background: none;
        border: none;
        color: var(--medium-gray);
        font-size: 1.5rem;
        cursor: pointer;
    }

    .sortable-ghost {
        opacity: 0.4;
        background: rgba(37, 99, 235, 0.1) !important;
    }

    /* Modal Styles */
    .card-modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        justify-content: center;
        align-items: flex-start;
        padding-top: 40px;
        overflow-y: auto;
    }

    .card-modal-overlay.show {
        display: flex;
    }

    .card-modal {
        background: white;
        border-radius: 12px;
        width: 100%;
        max-width: 900px;
        max-height: 90vh;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
        margin-bottom: 40px;
        overflow: visible;
        /* Mudado de hidden para permitir popups */
        position: relative;
        display: flex;
        flex-direction: column;
    }

    .card-modal-cover {
        height: 120px;
        background: #f1f5f9;
        display: none;
        position: relative;
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
        z-index: 1;
    }

    .card-modal-cover.no-cover {
        display: none;
    }

    .modal-top-actions {
        position: absolute;
        top: 12px;
        right: 12px;
        display: flex;
        gap: 8px;
        z-index: 1010;
    }

    .modal-top-btn {
        width: 32px;
        height: 32px;
        border-radius: 4px;
        background: rgba(255, 255, 255, 0.3);
        border: none;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 16px;
    }

    /* Se não tiver capa, botões ficam escuros para contraste */
    .card-modal:not(.has-cover) .modal-top-btn {
        background: #f1f5f9;
        color: var(--dark-color);
    }

    .modal-top-btn:hover {
        background: rgba(255, 255, 255, 0.5);
    }

    .card-modal:not(.has-cover) .modal-top-btn:hover {
        background: #e2e8f0;
    }

    /* Cover Selection Dropdown */
    .cover-dropdown {
        display: none;
        position: fixed;
        /* Mudado para fixed para garantir posicionamento sobre o modal */
        background: white;
        border: 1px solid var(--light-gray);
        border-radius: 8px;
        padding: 12px;
        box-shadow: var(--shadow-lg);
        z-index: 2000;
        min-width: 280px;
    }

    .cover-dropdown.show {
        display: block;
    }

    .cover-color-options {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 8px;
        margin-top: 10px;
    }

    .cover-color-option {
        height: 32px;
        border-radius: 4px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: transform 0.1s;
    }

    .cover-color-option:hover {
        transform: scale(1.05);
    }

    .cover-color-option.selected {
        border-color: var(--dark-color);
    }

    .cover-color-none {
        background: #f1f5f9;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .cover-color-none::after {
        content: '';
        width: 1px;
        height: 100%;
        background: #ef4444;
        transform: rotate(45deg);
    }

    /* Two column layout */
    .card-modal-content {
        display: grid;
        grid-template-columns: 1fr 300px;
        min-height: 400px;
        flex: 1;
        overflow: hidden;
    }

    @media (max-width: 768px) {
        .card-modal-content {
            grid-template-columns: 1fr;
        }

        .card-modal-sidebar {
            display: none;
        }
    }

    .card-modal-main {
        padding: 20px;
        border-right: 1px solid var(--light-gray);
        overflow-y: auto;
        overflow-x: hidden;
    }

    .card-modal-sidebar {
        padding: 20px;
        background: #fafafa;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* Title with checkbox */
    .card-title-row {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
    }

    .card-title-checkbox {
        width: 24px;
        height: 24px;
        border: 2px solid var(--medium-gray);
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .card-title-checkbox:hover {
        border-color: var(--primary-color);
    }

    .card-title-input {
        font-size: 22px;
        font-weight: 700;
        color: var(--dark-color);
        border: none;
        flex: 1;
        padding: 4px 0;
        outline: none;
        background: transparent;
    }

    /* Trello-style meta row */
    .card-meta-row {
        display: flex;
        gap: 24px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .card-meta-item {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .card-meta-label {
        font-size: 12px;
        font-weight: 600;
        color: var(--medium-gray);
        text-transform: uppercase;
    }

    .card-meta-value {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .card-label-chip {
        display: inline-flex;
        padding: 4px 12px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        color: white;
    }

    .card-add-label-btn {
        width: 28px;
        height: 28px;
        border-radius: 4px;
        background: #e2e8f0;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        color: var(--dark-color);
    }

    .card-add-label-btn:hover {
        background: #cbd5e1;
    }

    .card-due-date-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: #f1f5f9;
        border-radius: 6px;
        font-size: 13px;
        color: var(--dark-color);
        cursor: pointer;
    }

    .card-due-date-chip:hover {
        background: #e2e8f0;
    }

    .card-due-date-chip i {
        color: var(--medium-gray);
    }

    /* Section styling */
    .card-section {
        margin-bottom: 24px;
    }

    .card-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .card-section-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 600;
        color: var(--dark-color);
    }

    .card-section-title i {
        font-size: 16px;
        color: var(--medium-gray);
    }

    .card-section-btn {
        padding: 6px 12px;
        border: 1px solid var(--light-gray);
        border-radius: 4px;
        background: white;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
    }

    .card-section-btn:hover {
        background: var(--light-gray);
    }

    .card-description-content {
        font-size: 14px;
        color: var(--dark-color);
        line-height: 1.6;
        background: #f8fafc;
        padding: 12px;
        border-radius: 6px;
        min-height: 60px;
    }

    /* Sidebar styles */
    .sidebar-section {
        margin-bottom: 20px;
    }

    .sidebar-section-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 12px;
    }

    .sidebar-section-title i {
        color: var(--medium-gray);
    }

    .comment-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--light-gray);
        border-radius: 6px;
        font-size: 13px;
        resize: none;
    }

    .activity-log {
        max-height: 400px;
        overflow-y: auto;
        overflow-x: hidden;
        margin-top: 12px;
        display: none;
    }

    .activity-log.show {
        display: block;
    }

    .activity-item.hidden-preview {
        display: none;
    }

    .activity-log.expanded .activity-item.hidden-preview {
        display: flex;
    }

    .activity-item {
        display: flex;
        gap: 10px;
        padding: 10px 0;
        border-bottom: 1px solid var(--light-gray);
    }

    .activity-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #f97316;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 12px;
        flex-shrink: 0;
    }

    .activity-content {
        flex: 1;
    }

    .activity-text {
        font-size: 13px;
        color: var(--dark-color);
    }

    .activity-text strong {
        font-weight: 600;
    }

    .activity-date {
        font-size: 11px;
        color: var(--medium-gray);
        margin-top: 2px;
    }

    .activity-date a {
        color: var(--primary-color);
        text-decoration: none;
    }

    .card-modal-header {
        padding: 16px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--light-gray);
    }

    .card-modal-list-selector {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .card-modal-list-selector select {
        padding: 8px 12px;
        border: 1px solid var(--light-gray);
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        background: white;
        cursor: pointer;
    }

    .card-modal-actions {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .card-modal-action-btn {
        background: none;
        border: none;
        color: var(--medium-gray);
        font-size: 18px;
        cursor: pointer;
        padding: 6px;
        border-radius: 6px;
        transition: var(--transition);
    }

    .card-modal-action-btn:hover {
        background: var(--light-gray);
        color: var(--dark-color);
    }

    .card-modal-body {
        padding: 20px;
    }

    /* Title */
    .card-modal-title-input {
        font-size: 20px;
        font-weight: 700;
        color: var(--dark-color);
        border: none;
        width: 100%;
        padding: 8px 0;
        margin-bottom: 16px;
        outline: none;
        background: transparent;
    }

    .card-modal-title-input:focus {
        border-bottom: 2px solid var(--primary-color);
    }

    /* Action Buttons */
    .card-action-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 20px;
    }

    .card-action-btn {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        border: 1px solid var(--light-gray);
        border-radius: 6px;
        background: white;
        font-size: 13px;
        font-weight: 500;
        color: var(--dark-color);
        cursor: pointer;
        transition: var(--transition);
    }

    .card-action-btn:hover {
        background: var(--light-gray);
    }

    .card-action-btn i {
        font-size: 14px;
    }

    /* Labels */
    .card-labels-section {
        margin-bottom: 20px;
        display: none;
    }

    .card-labels-section.show {
        display: block;
    }

    .card-labels-section-title {
        font-size: 12px;
        font-weight: 600;
        color: var(--medium-gray);
        margin-bottom: 8px;
        text-transform: uppercase;
    }

    /* Cover Color Selector */
    .card-cover-section {
        margin-bottom: 20px;
        display: none;
    }

    .card-cover-section.show {
        display: block;
    }

    .cover-color-options {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .cover-color-option {
        width: 50px;
        height: 32px;
        border-radius: 4px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: var(--transition);
    }

    .cover-color-option:hover {
        transform: scale(1.05);
    }

    .cover-color-option.selected {
        border-color: var(--dark-color);
    }

    .cover-color-none {
        background: linear-gradient(135deg, #f3f4f6 45%, transparent 45%, transparent 55%, #f3f4f6 55%);
        background-color: white;
        border: 1px dashed var(--medium-gray) !important;
    }

    .card-labels-container {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }

    .card-label {
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        color: white;
        cursor: pointer;
        transition: var(--transition);
    }

    .card-label:hover {
        opacity: 0.85;
        transform: scale(1.02);
    }

    .card-label.selected {
        box-shadow: 0 0 0 2px white, 0 0 0 4px currentColor;
    }

    .label-urgente {
        background: #ef4444;
    }

    .label-importante {
        background: #f97316;
    }

    .label-normal {
        background: #6b7280;
    }

    .label-baixa {
        background: #3b82f6;
    }

    .label-reuniao {
        background: #6366f1;
    }

    .label-documentacao {
        background: #0891b2;
    }

    .label-bug {
        background: #dc2626;
    }

    .label-feature {
        background: #059669;
    }

    .label-concluido {
        background: #22c55e;
    }

    /* Due Date */
    .card-due-date-section {
        margin-bottom: 20px;
        display: none;
    }

    .card-due-date-section.show {
        display: block;
    }

    .card-due-date-display {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: #fef3c7;
        border-radius: 6px;
        font-size: 13px;
        color: #92400e;
    }

    .card-due-date-display.overdue {
        background: #fee2e2;
        color: #dc2626;
    }

    .card-due-date-display i {
        font-size: 14px;
    }

    .due-date-badge {
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        background: #dc2626;
        color: white;
        margin-left: 8px;
    }

    /* Description */
    .card-description-section {
        margin-bottom: 20px;
    }

    .card-section-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 10px;
    }

    .card-section-title i {
        color: var(--medium-gray);
    }

    .card-description-textarea {
        width: 100%;
        min-height: 100px;
        padding: 12px;
        border: 1px solid var(--light-gray);
        border-radius: 8px;
        font-size: 14px;
        resize: vertical;
        transition: var(--transition);
    }

    .card-description-textarea:focus {
        border-color: var(--primary-color);
        outline: none;
    }

    /* Checklist */
    .card-checklist-section {
        margin-bottom: 20px;
        display: none;
    }

    .card-checklist-section.show {
        display: block;
    }

    .checklist-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .checklist-delete-btn {
        background: none;
        border: none;
        color: var(--medium-gray);
        cursor: pointer;
        padding: 4px;
        font-size: 16px;
    }

    .checklist-delete-btn:hover {
        color: var(--danger-color);
    }

    .checklist-progress {
        margin-bottom: 12px;
    }

    .checklist-progress-text {
        font-size: 12px;
        color: var(--medium-gray);
        margin-bottom: 4px;
    }

    .checklist-progress-bar {
        height: 8px;
        background: var(--light-gray);
        border-radius: 4px;
        overflow: hidden;
    }

    .checklist-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #3b82f6, #22c55e);
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    .checklist-items {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .checklist-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px;
        border-radius: 6px;
        transition: var(--transition);
    }

    .checklist-item:hover {
        background: var(--light-gray);
    }

    .checklist-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: var(--primary-color);
    }

    .checklist-item-text {
        flex: 1;
        font-size: 14px;
        color: var(--dark-color);
    }

    .checklist-item.completed .checklist-item-text {
        text-decoration: line-through;
        color: var(--medium-gray);
    }

    .checklist-add-item {
        display: flex;
        gap: 8px;
        margin-top: 12px;
    }

    .checklist-add-input {
        flex: 1;
        padding: 10px 12px;
        border: 1px solid var(--light-gray);
        border-radius: 6px;
        font-size: 14px;
    }

    .checklist-add-input:focus {
        border-color: var(--primary-color);
        outline: none;
    }

    .checklist-add-btn {
        padding: 10px 16px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
    }

    .checklist-add-btn:hover {
        background: var(--primary-dark);
    }

    /* Labels Dropdown */
    .labels-dropdown {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        background: white;
        border: 1px solid var(--light-gray);
        border-radius: 8px;
        padding: 12px;
        box-shadow: var(--shadow-lg);
        z-index: 10;
        min-width: 280px;
    }

    .labels-dropdown.show {
        display: block;
    }

    .labels-dropdown-title {
        font-size: 12px;
        font-weight: 600;
        color: var(--medium-gray);
        margin-bottom: 10px;
        text-transform: uppercase;
    }

    /* Date Picker Dropdown */
    .date-dropdown {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        background: white;
        border: 1px solid var(--light-gray);
        border-radius: 8px;
        padding: 12px;
        box-shadow: var(--shadow-lg);
        z-index: 10;
    }

    .date-dropdown.show {
        display: block;
    }

    /* Footer */
    .card-modal-footer {
        padding: 16px 20px;
        border-top: 1px solid var(--light-gray);
        display: flex;
        justify-content: space-between;
    }

    .btn-modal {
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: var(--transition);
        border: none;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .btn-modal-primary {
        background: var(--primary-color);
        color: white;
    }

    .btn-modal-primary:hover {
        background: var(--primary-dark);
    }

    .btn-modal-danger {
        background: #fee2e2;
        color: #dc2626;
    }

    .btn-modal-danger:hover {
        background: #fecaca;
    }

    .btn-modal-secondary {
        background: var(--light-gray);
        color: var(--dark-color);
    }

    .btn-modal-secondary:hover {
        background: #d1d5db;
    }

    .modal-actions-left,
    .modal-actions-right {
        display: flex;
        gap: 8px;
    }

    /* Card Options Dropdown */
    .card-options-wrapper {
        position: relative;
    }

    .card-options-dropdown {
        display: none;
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        border: 1px solid var(--light-gray);
        border-radius: 8px;
        padding: 8px 0;
        box-shadow: var(--shadow-lg);
        z-index: 2000;
        min-width: 180px;
    }

    .card-options-dropdown.show {
        display: block;
    }

    /* Members Dropdown */
    .members-dropdown {
        display: none;
        position: fixed;
        background: white;
        border: 1px solid var(--light-gray);
        border-radius: 8px;
        padding: 12px;
        box-shadow: var(--shadow-lg);
        z-index: 2000;
        min-width: 280px;
        max-height: 400px;
        overflow-y: auto;
    }

    .members-dropdown.show {
        display: block;
    }

    .member-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .member-item:hover {
        background: #f1f5f9;
    }

    .member-item.selected {
        background: #e0f2fe;
    }

    .member-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 12px;
    }

    .member-info {
        flex: 1;
    }

    .member-name {
        font-size: 14px;
        font-weight: 500;
        color: var(--dark-color);
    }

    .member-role {
        font-size: 11px;
        color: var(--medium-gray);
    }

    /* Attachments Section */
    .attachments-dropdown {
        display: none;
        position: fixed;
        background: white;
        border: 1px solid var(--light-gray);
        border-radius: 8px;
        padding: 12px;
        box-shadow: var(--shadow-lg);
        z-index: 2000;
        min-width: 300px;
    }

    .attachments-dropdown.show {
        display: block;
    }

    .attachment-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px;
        background: #f8fafc;
        border-radius: 6px;
        margin-bottom: 8px;
    }

    .attachment-icon {
        font-size: 24px;
        color: var(--primary-color);
    }

    .attachment-info {
        flex: 1;
    }

    .attachment-name {
        font-size: 13px;
        font-weight: 500;
        color: var(--dark-color);
    }

    .attachment-date {
        font-size: 11px;
        color: var(--medium-gray);
    }

    .attachment-delete {
        color: var(--medium-gray);
        cursor: pointer;
        padding: 4px;
    }

    .attachment-delete:hover {
        color: #ef4444;
    }

    /* Assigned Members Display */
    .assigned-members-section {
        display: none;
    }

    .assigned-members-section.show {
        display: flex;
    }

    .assigned-avatars {
        display: flex;
        gap: -8px;
    }

    .assigned-avatar {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 10px;
        border: 2px solid white;
        margin-left: -8px;
    }

    .assigned-avatar:first-child {
        margin-left: 0;
    }

    /* Label Modals */
    .labels-modal-overlay,
    .label-edit-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    }

    .labels-selection-modal,
    .label-edit-modal {
        background: white;
        border-radius: 8px;
        width: 90%;
        max-width: 400px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    }

    .labels-modal-header {
        padding: 12px 16px;
        border-bottom: 1px solid #ddd;
        display: flex;
        align-items: center;
        gap: 8px;
        position: relative;
    }

    .labels-modal-header h3 {
        margin: 0;
        font-size: 14px;
        flex: 1;
        text-align: center;
        color: #5e6c84;
    }

    .labels-modal-close {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        font-size: 24px;
        color: #42526e;
        cursor: pointer;
        padding: 4px;
        line-height: 1;
    }

    .labels-modal-back {
        position: absolute;
        left: 8px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        font-size: 16px;
        color: #42526e;
        cursor: pointer;
        padding: 4px;
    }

    .labels-search-input {
        margin: 12px 16px;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }

    .labels-list {
        padding: 0 16px;
        max-height: 400px;
        overflow-y: auto;
    }

    .label-item {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
        padding: 4px;
        border-radius: 4px;
    }

    .label-item:hover {
        background: #f4f5f7;
    }

    .label-item input[type="checkbox"] {
        margin: 0;
        cursor: pointer;
    }

    .label-item-color {
        flex: 1;
        height: 32px;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        padding: 0 12px;
        color: white;
        font-size: 14px;
        font-weight: 500;
    }

    .label-item-edit {
        background: none;
        border: none;
        color: #42526e;
        cursor: pointer;
        padding: 4px 8px;
        font-size: 16px;
    }

    .create-label-btn {
        margin: 12px 16px;
        padding: 8px 12px;
        background: #f4f5f7;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        color: #172b4d;
    }

    .create-label-btn:hover {
        background: #e4e6ea;
    }

    .label-preview {
        height: 80px;
        margin: 16px;
        border-radius: 4px;
    }

    .label-form-group {
        padding: 0 16px;
        margin-bottom: 16px;
    }

    .label-form-group label {
        display: block;
        font-size: 12px;
        font-weight: 600;
        color: #5e6c84;
        margin-bottom: 8px;
    }

    .label-name-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }

    .color-picker-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 8px;
    }

    .color-option {
        height: 40px;
        border-radius: 4px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: transform 0.1s;
    }

    .color-option:hover {
        transform: scale(1.05);
    }

    .color-option.selected {
        border-color: #fff;
        box-shadow: 0 0 0 2px #0079bf;
    }

    .remove-color-btn {
        margin: 12px 16px;
        padding: 8px 12px;
        background: #eb5a46;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .remove-color-btn:hover {
        background: #cf513d;
    }

    .label-edit-actions {
        padding: 12px 16px;
        border-top: 1px solid #ddd;
    }

    .btn-label-save {
        width: 100%;
        padding: 8px;
        background: #0079bf;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
    }

    .btn-label-save:hover {
        background: #026aa7;
    }
</style>
{% endblock %}

{% block content %}
<div class="kanban-page">
    <div class="kanban-page-header">
        <h1 class="kanban-page-title">
            <i class="bi bi-kanban"></i>
            Quadro de Tarefas
        </h1>
    </div>

    <div class="kanban-board-area">
        <div class="kanban-board-content" id="boardContent">
            {% for lista in listas %}
            <div class="kanban-list" data-list-id="{{ lista.id }}">
                <div class="kanban-list-header">
                    <h3 class="kanban-list-title">{{ lista.name }}</h3>
                    <span class="kanban-list-count">{{ lista.cards.count }}</span>
                    <button class="kanban-list-menu-btn" onclick="toggleListMenu(event, {{ lista.id }})">
                        <i class="bi bi-three-dots"></i>
                    </button>
                    <div class="list-menu-dropdown" id="listMenu-{{ lista.id }}">
                        <div class="list-menu-item" onclick="renameList({{ lista.id }}, '{{ lista.name }}')">
                            <i class="bi bi-pencil"></i> Renomear lista
                        </div>
                        <div class="list-menu-item danger" onclick="deleteList({{ lista.id }})">
                            <i class="bi bi-trash"></i> Excluir lista
                        </div>
                    </div>
                </div>
                <div class="kanban-cards" data-list-id="{{ lista.id }}">
                    {% for card in lista.cards.all %}
                    <div class="kanban-card" data-card-id="{{ card.id }}">
                        {% if card.cover_image %}
                        <div class="kanban-card-cover" style="background-image: url('{{ card.cover_image }}');"></div>
                        {% elif card.cover_color %}
                        <div class="kanban-card-cover" style="background: {{ card.cover_color }};"></div>
                        {% endif %}
                        <div class="kanban-card-content">
                            {% if card.labels.exists %}
                            <div class="kanban-card-labels">
                                {% for label in card.labels.all %}
                                <span class="kanban-card-label" style="background: {{ label.color }};"
                                    title="{{ label.name }}">{{ label.name }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                            <div class="kanban-card-title">{{ card.title }}</div>
                            <div class="kanban-card-meta">
                                {% if card.due_date %}
                                <span
                                    class="kanban-card-due {% if card.is_overdue %}overdue{% elif card.due_complete %}completed{% endif %}">
                                    <i class="bi bi-clock"></i>
                                    {{ card.due_date|date:"d M. H:i" }}
                                </span>
                                {% endif %}
                                <div class="kanban-card-icons">
                                    {% if card.description %}
                                    <span class="kanban-card-icon" title="Tem descrição">
                                        <i class="bi bi-text-left"></i>
                                    </span>
                                    {% endif %}
                                    {% if card.checklist_progress.total > 0 %}
                                    <span
                                        class="kanban-card-progress {% if card.checklist_progress.completed == card.checklist_progress.total %}complete{% endif %}">
                                        <i class="bi bi-check2-square"></i>
                                        {{ card.checklist_progress.completed }}/{{ card.checklist_progress.total }}
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    {% endfor %}
                </div>
                <div class="kanban-add-card">
                    <button class="kanban-add-card-btn" onclick="showAddCard({{ lista.id }})">
                        <i class="bi bi-plus-lg"></i> Adicionar cartão
                    </button>
                    <div class="add-card-form" id="addCardForm-{{ lista.id }}">
                        <textarea id="newCardTitle-{{ lista.id }}"
                            placeholder="Digite o título do cartão..."></textarea>
                        <div class="add-card-actions">
                            <button class="btn-add" onclick="addCard({{ lista.id }})">Adicionar</button>
                            <button class="btn-cancel" onclick="hideAddCard({{ lista.id }})">&times;</button>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <p style="color: var(--medium-gray); padding: 20px;">Nenhuma lista encontrada.</p>
            {% endfor %}

            <!-- Botão para adicionar nova lista -->
            <div class="kanban-add-list" id="addListContainer">
                <div id="addListBtn" onclick="showAddListForm()">
                    <i class="bi bi-plus-lg"></i> Adicionar outra lista
                </div>
                <div class="kanban-add-list-form" id="addListForm">
                    <input type="text" id="newListName" placeholder="Nome da lista..."
                        onkeypress="if(event.key==='Enter')addList()">
                    <div class="kanban-add-list-actions">
                        <button class="btn-add" onclick="addList()">Adicionar</button>
                        <button class="btn-cancel" onclick="hideAddListForm()">&times;</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Edição do Cartão -->
<div class="card-modal-overlay" id="cardModalOverlay">
    <div class="card-modal">
        <!-- Botões do Topo (Capa, Opções, Fechar) -->
        <div class="modal-top-actions">
            <button class="modal-top-btn" onclick="toggleCoverPanel(event)" title="Capa">
                <i class="bi bi-image"></i>
            </button>
            <div class="card-options-wrapper" style="position: relative;">
                <button class="modal-top-btn" onclick="toggleCardOptionsMenu(event)" title="Mais opções">
                    <i class="bi bi-three-dots"></i>
                </button>
                <div class="card-options-dropdown" id="cardOptionsDropdown">
                    <div class="list-menu-item danger" onclick="deleteCard()">
                        <i class="bi bi-trash"></i> Excluir Cartão
                    </div>
                </div>
            </div>
            <button class="modal-top-btn" onclick="closeCardModal()" title="Fechar">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>

        <!-- Dropdown de Capa (Popup) -->
        <div class="cover-dropdown" id="coverSection">
            <div class="labels-dropdown-title">Capa</div>
            <div class="card-labels-section-title" style="margin-top: 10px;">Cores</div>
            <div class="cover-color-options" id="coverColorOptions">
                <div class="cover-color-option cover-color-none" data-color="" title="Sem capa"
                    onclick="selectCoverColor('')"></div>
                <div class="cover-color-option" style="background: #22c55e;" data-color="#22c55e"
                    onclick="selectCoverColor('#22c55e')"></div>
                <div class="cover-color-option" style="background: #eab308;" data-color="#eab308"
                    onclick="selectCoverColor('#eab308')"></div>
                <div class="cover-color-option" style="background: #f97316;" data-color="#f97316"
                    onclick="selectCoverColor('#f97316')"></div>
                <div class="cover-color-option" style="background: #ef4444;" data-color="#ef4444"
                    onclick="selectCoverColor('#ef4444')"></div>
                <div class="cover-color-option" style="background: #a855f7;" data-color="#a855f7"
                    onclick="selectCoverColor('#a855f7')"></div>
                <div class="cover-color-option" style="background: #3b82f6;" data-color="#3b82f6"
                    onclick="selectCoverColor('#3b82f6')"></div>
                <div class="cover-color-option" style="background: #06b6d4;" data-color="#06b6d4"
                    onclick="selectCoverColor('#06b6d4')"></div>
                <div class="cover-color-option" style="background: #ec4899;" data-color="#ec4899"
                    onclick="selectCoverColor('#ec4899')"></div>
                <div class="cover-color-option" style="background: #6366f1;" data-color="#6366f1"
                    onclick="selectCoverColor('#6366f1')"></div>
            </div>
        </div>

        <!-- Área da Capa -->
        <div class="card-modal-cover" id="cardModalCover"></div>

        <div class="card-modal-content">
            <!-- Coluna Principal (Esquerda) -->
            <div class="card-modal-main">
                <!-- Linha do Título -->
                <div class="card-title-row">
                    <input type="text" class="card-title-input" id="editCardTitle" placeholder="Título do cartão"
                        onblur="autoSaveCard()">
                    <input type="hidden" id="editCardId">
                </div>

                <!-- Botões de Ação Rápidos -->
                <div class="card-action-buttons" style="margin-bottom: 24px;">
                    <button class="card-action-btn" onclick="openLabelsManagement()">
                        <i class="bi bi-tag"></i> Etiquetas
                    </button>
                    <button class="card-action-btn" onclick="toggleChecklist()">
                        <i class="bi bi-check2-square"></i> Checklist
                    </button>
                    <button class="card-action-btn" onclick="toggleDatePanel()">
                        <i class="bi bi-clock"></i> Datas
                    </button>
                    <button class="card-action-btn" onclick="toggleMembersPanel()">
                        <i class="bi bi-people"></i> Membros
                    </button>
                    <button class="card-action-btn" onclick="toggleAttachmentPanel()">
                        <i class="bi bi-paperclip"></i> Anexo
                    </button>
                </div>

                <!-- Meta Row (Etiquetas e Data) -->
                <div class="card-meta-row">
                    <!-- Etiquetas -->
                    <div class="card-meta-item" id="labelsMetaSection" style="display: none;">
                        <span class="card-meta-label">Etiquetas</span>
                        <div class="card-meta-value">
                            <div id="modalLabelsDisplay" style="display: flex; gap: 4px; flex-wrap: wrap;"></div>
                            <button class="card-add-label-btn" onclick="openLabelsManagement()">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Data de Entrega -->
                    <div class="card-meta-item" id="dueDateMetaSection" style="display: none;">
                        <span class="card-meta-label">Data Entrega</span>
                        <div class="card-meta-value">
                            <div class="card-due-date-chip" onclick="toggleDatePanel()">
                                <i class="bi bi-clock"></i>
                                <span id="dueDateText"></span>
                                <span class="due-date-badge" id="dueDateBadge" style="display: none;">Vencido</span>
                            </div>
                        </div>
                    </div>
                    <!-- Membros Atribuídos -->
                    <div class="card-meta-item" id="assignedMembersSection" style="display: none;">
                        <span class="card-meta-label">Membros</span>
                        <div class="card-meta-value">
                            <div id="assignedAvatarsDisplay" style="display: flex;"></div>
                            <button class="card-add-label-btn" onclick="toggleMembersPanel()">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Anexos -->
                    <div class="card-meta-item" id="attachmentsMetaSection" style="display: none;">
                        <span class="card-meta-label">Anexos</span>
                        <div class="card-meta-value">
                            <span id="attachmentsCount"
                                style="font-size: 13px; color: var(--dark-color); cursor: pointer;"
                                onclick="toggleAttachmentPanel()">
                                <i class="bi bi-paperclip"></i> <span id="attachmentsCountNumber">0</span> anexo(s)
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Seção de Descrição -->
                <div class="card-section">
                    <div class="card-section-header">
                        <div class="card-section-title">
                            <i class="bi bi-text-left"></i> Descrição
                        </div>
                        <button class="card-section-btn" onclick="toggleDescriptionEdit()">Editar</button>
                    </div>
                    <div class="card-description-content" id="cardDescriptionDisplay" onclick="toggleDescriptionEdit()"
                        style="cursor: pointer; min-height: 45px;">
                        Adicione uma descrição mais detalhada...
                    </div>
                    <div id="descriptionEditArea" style="display: none; margin-top: 10px;">
                        <textarea class="comment-input" id="editCardDescription"
                            placeholder="Adicione uma descrição mais detalhada..."
                            style="min-height: 100px;"></textarea>
                        <div style="display: flex; gap: 8px; margin-top: 8px;">
                            <button class="btn-add" onclick="saveDescription()">Salvar</button>
                            <button class="btn-cancel" onclick="toggleDescriptionEdit()">Cancelar</button>
                        </div>
                    </div>
                </div>

                <!-- Seção de Checklist -->
                <div class="card-section" id="checklistSection" style="display: none;">
                    <div class="card-section-header">
                        <div class="card-section-title">
                            <i class="bi bi-check2-square"></i> <span id="checklistTitle">Tarefas</span>
                        </div>
                        <button class="card-section-btn" onclick="deleteChecklist()">Excluir</button>
                    </div>
                    <div class="checklist-progress" style="margin-bottom: 12px;">
                        <div class="checklist-progress-text" id="checklistProgressText">0%</div>
                        <div class="checklist-progress-bar">
                            <div class="checklist-progress-fill" id="checklistProgressFill" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div class="checklist-items" id="checklistItems"></div>
                    <div class="checklist-add-item">
                        <input type="text" class="checklist-add-input" id="newChecklistItem"
                            placeholder="Adicionar item...">
                        <button class="checklist-add-btn" onclick="addChecklistItem()">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Coluna Lateral (Direita) -->
            <div class="card-modal-sidebar">
                <div class="sidebar-section">
                    <div class="sidebar-section-title">
                        <i class="bi bi-chat-left-text"></i> Comentários e atividade
                    </div>
                    <div style="display: flex; justify-content: flex-end; margin-bottom: 12px;">
                        <button class="card-section-btn" id="toggleActivityBtn"
                            onclick="toggleActivityDetails()">Mostrar Detalhes</button>
                    </div>
                    <textarea class="comment-input" placeholder="Escreva um comentário..." rows="1"></textarea>
                </div>

                <div class="activity-log" id="cardActivityLog">
                    <!-- Atividades serão inseridas aqui dinamicamente -->
                </div>
            </div>
        </div>


    </div>

    <!-- Modal de Seleção de Etiquetas -->
    <div class="labels-modal-overlay" id="labelsModalOverlay" style="display: none;">
        <div class="labels-selection-modal">
            <div class="labels-modal-header">
                <h3>Etiquetas</h3>
                <button class="labels-modal-close" onclick="closeLabelSelection()">×</button>
            </div>
            <input type="text" class="labels-search-input" id="labelSearch" placeholder="Buscar etiquetas..."
                onkeyup="filterLabels()">
            <div class="labels-list" id="labelsList">
                <!-- Rendered by JS -->
            </div>
            <button class="create-label-btn" onclick="openCreateLabel()">
                Criar uma nova etiqueta
            </button>
        </div>
    </div>

    <!-- Modal de Edição/Criação de Etiqueta -->
    <div class="label-edit-modal-overlay" id="labelEditModalOverlay" style="display: none;">
        <div class="label-edit-modal">
            <div class="labels-modal-header">
                <button class="labels-modal-back" onclick="backToLabelSelection()">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <h3 id="labelEditTitle">Editar etiqueta</h3>
                <button class="labels-modal-close" onclick="closeLabelEdit()">×</button>
            </div>

            <div class="label-preview" id="labelPreview" style="background: #61bd4f;"></div>

            <div class="label-form-group">
                <label>Título</label>
                <input type="text" class="label-name-input" id="labelNameInput" placeholder="Nome da etiqueta..."
                    maxlength="50">
            </div>

            <div class="label-form-group">
                <label>Selecionar uma cor</label>
                <div class="color-picker-grid" id="colorPickerGrid">
                    <!-- Generated by JS -->
                </div>
            </div>

            <button class="remove-color-btn" onclick="removeLabel()" id="deleteLabelBtn" style="display: none;">
                <i class="bi bi-x"></i> Excluir
            </button>

            <div class="label-edit-actions">
                <button class="btn-label-save" onclick="saveLabel()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Dropdown de Data (Popup) -->
    <div class="date-dropdown" id="dateSection">
        <div class="labels-dropdown-title" style="margin-bottom: 16px;">Data de Entrega</div>

        <div style="display: flex; flex-direction: column; gap: 16px;">
            <div style="display: flex; gap: 8px;">
                <div style="flex: 1.5;">
                    <label
                        style="font-size: 11px; font-weight: 700; color: var(--medium-gray); text-transform: uppercase; display: block; margin-bottom: 4px;">Data</label>
                    <input type="date" id="popupDateInput" class="comment-input" style="padding: 6px 10px;">
                </div>
                <div style="flex: 1;">
                    <label
                        style="font-size: 11px; font-weight: 700; color: var(--medium-gray); text-transform: uppercase; display: block; margin-bottom: 4px;">Hora</label>
                    <input type="time" id="popupTimeInput" class="comment-input" style="padding: 6px 10px;">
                </div>
            </div>

            <div style="display: flex; flex-direction: column; gap: 8px;">
                <button class="btn-modal btn-modal-primary" onclick="saveDueDate()"
                    style="justify-content: center; width: 100%; padding: 8px;">Salvar</button>
                <button class="btn-modal" onclick="removeDueDate()"
                    style="justify-content: center; width: 100%; background: #f1f5f9; color: var(--dark-color); padding: 8px;">Remover</button>
            </div>

            <input type="hidden" id="editCardDueDate"> <!-- Fallback hidden input for compatibility -->
        </div>
    </div>

    <!-- Dropdown de Membros (Popup) -->
    <div class="members-dropdown" id="membersSection">
        <div class="labels-dropdown-title">Membros</div>
        <div id="membersContainer"></div>
    </div>

    <!-- Dropdown de Anexos (Popup) -->
    <div class="attachments-dropdown" id="attachmentsSection">
        <div class="labels-dropdown-title" style="margin-bottom: 12px;">Anexos</div>
        <div id="attachmentsList"></div>
        <div style="margin-top: 12px;">
            <input type="file" id="attachmentFileInput" style="display: none;" onchange="uploadAttachment(this)">
            <button class="btn-modal btn-modal-primary" onclick="document.getElementById('attachmentFileInput').click()"
                style="width: 100%; justify-content: center;">
                <i class="bi bi-upload"></i> Adicionar Anexo
            </button>
        </div>
    </div>
</div>

<!-- Dados de etiquetas disponíveis -->
<script id="labelsData" type="application/json">
{{ labels_json|safe }}
</script>
<script id="membersData" type="application/json">
{{ members_json|safe }}
</script>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    (function () {
        const csrfToken = '{{ csrf_token }}';

        // Estado do cartão atual
        let currentCard = null;
        let currentChecklists = [];
        let selectedLabels = [];

        // Labels disponíveis
        const availableLabels = JSON.parse(document.getElementById('labelsData').textContent);


        // Close all popups when clicking outside
        document.addEventListener('click', function (e) {
            // List of popup IDs and their toggle buttons
            const popups = [
                { id: 'labelsSection', btnText: 'Etiquetas' },
                { id: 'dateSection', btnText: 'Datas' },
                { id: 'membersSection', btnText: 'Membros' },
                { id: 'attachmentsSection', btnText: 'Anexo' },
                { id: 'coverSection', btnText: 'Capa' },
                { id: 'cardOptionsDropdown', btnText: 'three-dots' }
            ];

            popups.forEach(popup => {
                const section = document.getElementById(popup.id);
                if (section && section.classList.contains('show')) {
                    // Check if click is outside the popup and not on its toggle button
                    if (!section.contains(e.target) && !e.target.closest('.card-action-btn') && !e.target.closest('.modal-top-btn') && !e.target.closest('.card-add-label-btn')) {
                        section.classList.remove('show');
                    }
                }
            });
        });

        window.showAddCard = function (listId) {
            document.getElementById('addCardForm-' + listId).classList.add('show');
            document.getElementById('newCardTitle-' + listId).focus();
        };

        window.hideAddCard = function (listId) {
            document.getElementById('addCardForm-' + listId).classList.remove('show');
            document.getElementById('newCardTitle-' + listId).value = '';
        };

        window.addCard = async function (listId) {
            const title = document.getElementById('newCardTitle-' + listId).value.trim();
            if (!title) return;

            try {
                const res = await fetch('/api/kanban/lists/' + listId + '/cards/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ title: title })
                });

                if (res.ok) {
                    location.reload();
                } else {
                    const err = await res.json();
                    alert('Erro: ' + (err.error || 'Não foi possível criar o cartão'));
                }
            } catch (e) {
                console.error('Erro:', e);
                alert('Erro ao criar cartão');
            }
        };

        // Funções para adicionar nova lista
        window.showAddListForm = function () {
            document.getElementById('addListBtn').style.display = 'none';
            document.getElementById('addListForm').classList.add('show');
            document.getElementById('newListName').focus();
        };

        window.hideAddListForm = function () {
            document.getElementById('addListBtn').style.display = 'block';
            document.getElementById('addListForm').classList.remove('show');
            document.getElementById('newListName').value = '';
        };

        window.addList = async function () {
            const name = document.getElementById('newListName').value.trim();
            if (!name) return;

            try {
                const res = await fetch('/api/kanban/boards/{{ board.id }}/lists/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ name: name })
                });

                if (res.ok) {
                    location.reload();
                } else {
                    const err = await res.json();
                    alert('Erro: ' + (err.error || 'Não foi possível criar a lista'));
                }
            } catch (e) {
                console.error('Erro:', e);
                alert('Erro ao criar lista');
            }
        };

        // Menu de Lista
        window.toggleListMenu = function (event, listId) {
            event.stopPropagation();
            const menus = document.querySelectorAll('.list-menu-dropdown');
            menus.forEach(m => {
                if (m.id !== 'listMenu-' + listId) m.classList.remove('show');
            });

            const menu = document.getElementById('listMenu-' + listId);
            menu.classList.toggle('show');

            // Fechar ao clicar fora
            const closeMenu = (e) => {
                if (!menu.contains(e.target)) {
                    menu.classList.remove('show');
                    document.removeEventListener('click', closeMenu);
                }
            };
            if (menu.classList.contains('show')) {
                setTimeout(() => document.addEventListener('click', closeMenu), 0);
            }
        };

        window.renameList = async function (listId, currentName) {
            const newName = prompt('Novo nome para a lista:', currentName);
            if (!newName || newName === currentName) return;

            try {
                const res = await fetch('/api/kanban/lists/' + listId + '/', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ name: newName })
                });

                if (res.ok) {
                    location.reload();
                }
            } catch (e) {
                console.error('Erro ao renomear lista:', e);
            }
        };

        window.deleteList = async function (listId) {
            if (!confirm('Tem certeza que deseja excluir esta lista e todos os seus cartões?')) return;

            try {
                const res = await fetch('/api/kanban/lists/' + listId + '/', {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                });

                if (res.ok) {
                    location.reload();
                } else {
                    alert('Erro ao excluir lista');
                }
            } catch (e) {
                console.error('Erro ao excluir lista:', e);
            }
        };

        // Função para abrir o modal de edição
        window.openCardModal = async function (cardId) {
            try {
                const res = await fetch('/api/kanban/cards/' + cardId + '/');
                if (!res.ok) throw new Error('Erro ao carregar cartão');

                const data = await res.json();
                currentCard = data;

                document.getElementById('editCardId').value = cardId;
                document.getElementById('editCardTitle').value = data.title || '';

                // Descrição
                const descArea = document.getElementById('editCardDescription');
                const descDisplay = document.getElementById('cardDescriptionDisplay');
                descArea.value = data.description || '';
                descDisplay.textContent = data.description || 'Adicione uma descrição mais detalhada...';

                document.getElementById('descriptionEditArea').style.display = 'none';
                descDisplay.style.display = 'block';

                // Carregar data de vencimento
                updateDueDateDisplay(data.due_date);

                // Carregar Capa
                updateCoverDisplay(data.cover_color);

                // Carregar labels
                selectedLabels = data.labels ? data.labels.map(l => l.id) : [];
                renderLabels();

                // Carregar checklists
                currentChecklists = data.checklists || [];
                if (currentChecklists.length > 0) {
                    document.getElementById('checklistSection').style.display = 'block';
                    renderChecklists();
                } else {
                    document.getElementById('checklistSection').style.display = 'none';
                }


                // Load attachments count
                try {
                    const attRes = await fetch('/api/kanban/cards/' + cardId + '/attachments/');
                    if (attRes.ok) {
                        const atts = await attRes.json();
                        updateAttachmentsMetaDisplay(atts.length);
                    }
                } catch (e) { console.log('Erro ao carregar anexos', e); }

                // Render activities
                renderActivities(data.activities || []);

                document.getElementById('cardModalOverlay').classList.add('show');
            } catch (e) {
                console.error('Erro ao abrir cartão:', e);
                alert('Erro ao carregar dados do cartão');
            }
        };

        // Função para atualizar exibição da data de vencimento
        function updateDueDateDisplay(dueDate) {
            const metaSection = document.getElementById('dueDateMetaSection');
            const text = document.getElementById('dueDateText');
            const badge = document.getElementById('dueDateBadge');

            const pDateInput = document.getElementById('popupDateInput');
            const pTimeInput = document.getElementById('popupTimeInput');

            if (dueDate) {
                const date = new Date(dueDate);
                const now = new Date();
                const isOverdue = date < now;

                const options = { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' };
                text.textContent = date.toLocaleDateString('pt-BR', options);

                if (isOverdue) {
                    badge.style.display = 'inline';
                    badge.classList.add('overdue');
                } else {
                    badge.style.display = 'none';
                }

                // Preencher inputs do popup
                const datePart = date.toISOString().split('T')[0];
                const timePart = date.toTimeString().split(' ')[0].slice(0, 5);
                pDateInput.value = datePart;
                pTimeInput.value = timePart;

                metaSection.style.display = 'flex';
            } else {
                metaSection.style.display = 'none';
                pDateInput.value = '';
                pTimeInput.value = '12:00';
            }
        }

        function updateCoverDisplay(color) {
            const cover = document.getElementById('cardModalCover');
            const modal = document.querySelector('.card-modal');
            if (color) {
                cover.style.background = color;
                cover.style.display = 'block';
                modal.classList.add('has-cover');
            } else {
                cover.style.display = 'none';
                modal.classList.remove('has-cover');
            }
        }

        // Renderizar labels
        function renderLabels() {
            const container = document.getElementById('labelsContainer');
            const displayArea = document.getElementById('modalLabelsDisplay');
            const metaSection = document.getElementById('labelsMetaSection');

            if (!container) return;

            // Render no popup de seleção
            container.innerHTML = availableLabels.map(label => {
                const isSelected = selectedLabels.some(l => l === label.id || l.id === label.id);
                return `<span class="card-label ${isSelected ? 'selected' : ''}" 
                              style="background: ${label.color}"
                              data-label-id="${label.id}" 
                              onclick="toggleLabel(${label.id})">${label.name}</span>`;
            }).join('');

            // Render na área de meta do modal (Trello style)
            const activeLabels = availableLabels.filter(label =>
                selectedLabels.some(l => l === label.id || l.id === label.id)
            );

            if (activeLabels.length > 0) {
                displayArea.innerHTML = activeLabels.map(label => `
                    <span class="card-label-chip" style="background: ${label.color}" title="${label.name}">
                        ${label.name}
                    </span>
                `).join('');
                metaSection.style.display = 'flex';
            } else {
                metaSection.style.display = 'none';
            }
        }

        // Toggle label - saves to server
        window.toggleLabel = async function (labelId) {
            if (!currentCard) return;

            const isCurrentlySelected = selectedLabels.some(l => l === labelId || l.id === labelId);
            const action = isCurrentlySelected ? 'remove' : 'add';

            try {
                const res = await fetch('/api/kanban/cards/' + currentCard.id + '/labels/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ label_id: labelId, action: action })
                });

                if (res.ok) {
                    // Update local state
                    if (action === 'add') {
                        const label = availableLabels.find(l => l.id === labelId);
                        if (label) selectedLabels.push(label);
                    } else {
                        selectedLabels = selectedLabels.filter(l => l !== labelId && l.id !== labelId);
                    }
                    renderLabels();
                    // Reload to show labels on cards
                    location.reload();
                } else {
                    const err = await res.json();
                    alert('Erro: ' + (err.error || 'Não foi possível salvar etiqueta'));
                }
            } catch (e) {
                console.error('Erro ao salvar etiqueta:', e);
            }
        };

        // Renderizar checklists
        function renderChecklists() {
            const container = document.getElementById('checklistItems');

            if (currentChecklists.length === 0) {
                container.innerHTML = '';
                document.getElementById('checklistProgressText').textContent = '0%';
                document.getElementById('checklistProgressFill').style.width = '0%';
                return;
            }

            // Pegar o primeiro checklist (simplificado)
            const checklist = currentChecklists[0];
            const items = checklist.items || [];

            container.innerHTML = items.map(item => `
                <div class="checklist-item ${item.is_completed ? 'completed' : ''}" data-item-id="${item.id}">
                    <input type="checkbox" ${item.is_completed ? 'checked' : ''} 
                           onchange="toggleChecklistItem(${checklist.id}, ${item.id}, this.checked)">
                    <span class="checklist-item-text">${item.text}</span>
                </div>
            `).join('');

            updateChecklistProgress(items);
        }

        // Atualizar progresso do checklist
        function updateChecklistProgress(items) {
            if (!items || items.length === 0) {
                document.getElementById('checklistProgressText').textContent = '0%';
                document.getElementById('checklistProgressFill').style.width = '0%';
                return;
            }

            const completed = items.filter(i => i.is_completed).length;
            const total = items.length;
            const percent = Math.round((completed / total) * 100);

            document.getElementById('checklistProgressText').textContent = percent + '%';
            document.getElementById('checklistProgressFill').style.width = percent + '%';
        }

        // Toggle item do checklist
        window.toggleChecklistItem = async function (checklistId, itemId, isCompleted) {
            try {
                await fetch('/api/kanban/checklists/' + checklistId + '/items/', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ item_id: itemId, is_completed: isCompleted })
                });

                // Atualizar estado local
                const checklist = currentChecklists.find(c => c.id === checklistId);
                if (checklist) {
                    const item = checklist.items.find(i => i.id === itemId);
                    if (item) item.is_completed = isCompleted;
                    renderChecklists();
                }
            } catch (e) {
                console.error('Erro ao atualizar item:', e);
            }
        };

        // Adicionar item ao checklist
        window.addChecklistItem = async function () {
            const input = document.getElementById('newChecklistItem');
            const text = input.value.trim();
            if (!text) return;

            if (currentChecklists.length === 0) return;

            const checklistId = currentChecklists[0].id;

            try {
                const res = await fetch('/api/kanban/checklists/' + checklistId + '/items/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ text: text })
                });

                if (res.ok) {
                    const newItem = await res.json();
                    currentChecklists[0].items.push(newItem);
                    renderChecklists();
                    input.value = '';
                }
            } catch (e) {
                console.error('Erro ao adicionar item:', e);
            }
        };

        // Toggle panels
        window.toggleLabelsPanel = function () {
            const section = document.getElementById('labelsSection');
            section.classList.toggle('show');
            if (section.classList.contains('show')) {
                renderLabels();

                // Posicionar perto do botão
                const btn = event.currentTarget;
                const rect = btn.getBoundingClientRect();
                section.style.top = (rect.bottom + window.scrollY + 5) + 'px';
                section.style.left = (rect.left + window.scrollX) + 'px';
            }
        };

        window.toggleDescriptionEdit = function () {
            const display = document.getElementById('cardDescriptionDisplay');
            const area = document.getElementById('descriptionEditArea');
            const isEditing = display.style.display === 'none';

            if (isEditing) {
                display.style.display = 'block';
                area.style.display = 'none';
            } else {
                display.style.display = 'none';
                area.style.display = 'block';
                document.getElementById('editCardDescription').focus();
            }
        };

        window.saveDescription = async function () {
            const description = document.getElementById('editCardDescription').value;
            if (!currentCard) return;

            try {
                const res = await fetch('/api/kanban/cards/' + currentCard.id + '/', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ description: description })
                });

                if (res.ok) {
                    document.getElementById('cardDescriptionDisplay').textContent = description || 'Adicione uma descrição mais detalhada...';
                    toggleDescriptionEdit();
                }
            } catch (e) {
                console.error('Erro ao salvar descrição:', e);
            }
        };

        window.toggleCoverPanel = function (event) {
            const section = document.getElementById('coverSection');
            section.classList.toggle('show');

            if (section.classList.contains('show')) {
                if (event && event.currentTarget) {
                    const btn = event.currentTarget;
                    const rect = btn.getBoundingClientRect();
                    section.style.top = (rect.bottom + 5) + 'px';
                    section.style.left = (rect.left - 250) + 'px'; // Deslocar para a esquerda para não sumir
                }
                updateCoverSelection();
            }
        };

        window.selectCoverColor = async function (color) {
            if (!currentCard) return;

            // Update visual selection
            document.querySelectorAll('.cover-color-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.dataset.color === color) {
                    opt.classList.add('selected');
                }
            });

            // Update modal cover
            updateCoverDisplay(color);

            // Save to server
            try {
                await fetch('/api/kanban/cards/' + currentCard.id + '/', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ cover_color: color })
                });
                currentCard.cover_color = color;
            } catch (e) {
                console.error('Erro ao salvar cor:', e);
            }
        };

        function updateCoverSelection() {
            const currentColor = currentCard ? currentCard.cover_color : '';
            document.querySelectorAll('.cover-color-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.dataset.color === currentColor) {
                    opt.classList.add('selected');
                }
            });
        }

        window.toggleDatePanel = function () {
            const section = document.getElementById('dateSection');
            section.classList.toggle('show');

            if (section.classList.contains('show')) {
                // Se estiver abrindo e tiver data, garantir que os inputs estão atuais
                if (currentCard && currentCard.due_date) {
                    const date = new Date(currentCard.due_date);
                    document.getElementById('popupDateInput').value = date.toISOString().split('T')[0];
                    document.getElementById('popupTimeInput').value = date.toTimeString().split(' ')[0].slice(0, 5);
                } else {
                    // Data padrão: hoje
                    if (!document.getElementById('popupDateInput').value) {
                        document.getElementById('popupDateInput').value = new Date().toISOString().split('T')[0];
                        document.getElementById('popupTimeInput').value = "12:00";
                    }
                }

                // Posicionar perto do botão (se disparado por evento)
                if (window.event && event.currentTarget) {
                    const btn = event.currentTarget;
                    const rect = btn.getBoundingClientRect();
                    section.style.top = (rect.bottom + window.scrollY + 5) + 'px';
                    section.style.left = (rect.left + window.scrollX) + 'px';
                }
            }
        };

        window.saveDueDate = async function () {
            if (!currentCard) return;

            const dateVal = document.getElementById('popupDateInput').value;
            const timeVal = document.getElementById('popupTimeInput').value || "12:00";

            if (!dateVal) {
                alert("Selecione uma data");
                return;
            }

            const isoString = `${dateVal}T${timeVal}`;

            try {
                const res = await fetch('/api/kanban/cards/' + currentCard.id + '/', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ due_date: isoString })
                });

                if (res.ok) {
                    const updatedData = await res.json();
                    currentCard.due_date = updatedData.due_date;
                    updateDueDateDisplay(currentCard.due_date);
                    toggleDatePanel();
                }
            } catch (e) {
                console.error(e);
            }
        };

        window.removeDueDate = async function () {
            if (!currentCard) return;

            try {
                const res = await fetch('/api/kanban/cards/' + currentCard.id + '/', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ due_date: null })
                });

                if (res.ok) {
                    currentCard.due_date = null;
                    updateDueDateDisplay(null);
                    toggleDatePanel();
                }
            } catch (e) {
                console.error(e);
            }
        };

        window.toggleChecklist = async function () {
            const section = document.getElementById('checklistSection');

            if (section.style.display === 'block') {
                section.style.display = 'none';
            } else {
                // Criar checklist se não existir
                if (currentChecklists.length === 0 && currentCard) {
                    try {
                        const res = await fetch('/api/kanban/cards/' + currentCard.id + '/checklists/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken
                            },
                            body: JSON.stringify({ title: 'Tarefas' })
                        });

                        if (res.ok) {
                            const newChecklist = await res.json();
                            currentChecklists.push(newChecklist);
                        }
                    } catch (e) {
                        console.error('Erro ao criar checklist:', e);
                    }
                }

                section.style.display = 'block';
                renderChecklists();
            }
        };

        window.deleteChecklist = function () {
            if (confirm('Excluir esta lista de tarefas?')) {
                document.getElementById('checklistSection').style.display = 'none';
                currentChecklists = [];
                // Idealmente deletar no servidor também, mas mantendo simplificado
            }
        };

        // Funções principais
        window.closeCardModal = function () {
            document.getElementById('cardModalOverlay').classList.remove('show');
            currentCard = null;
            currentChecklists = [];
            selectedLabels = [];
        };

        window.saveCard = async function () {
            const cardId = document.getElementById('editCardId').value;
            const title = document.getElementById('editCardTitle').value.trim();
            const description = document.getElementById('editCardDescription').value.trim();
            const due_date = document.getElementById('editCardDueDate').value;

            if (!title) {
                alert('O título é obrigatório');
                return;
            }

            try {
                const res = await fetch('/api/kanban/cards/' + cardId + '/', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        title: title,
                        description: description,
                        due_date: due_date || null
                    })
                });

                if (res.ok) {
                    location.reload();
                } else {
                    let errMsg = 'Não foi possível salvar o cartão';
                    try {
                        const err = await res.json();
                        errMsg = err.error || errMsg;
                    } catch (jsonErr) {
                        console.error('Erro ao parsear resposta:', jsonErr);
                    }
                    alert('Erro: ' + errMsg);
                }
            } catch (e) {
                console.error('Erro ao salvar:', e);
                alert('Erro ao salvar cartão');
            }
        };

        window.deleteCard = async function () {
            if (!confirm('Tem certeza que deseja excluir este cartão?')) return;

            const cardId = document.getElementById('editCardId').value;
            if (!cardId) {
                alert('ID do cartão não encontrado');
                return;
            }

            console.log('Excluindo cartão ID:', cardId);

            try {
                const res = await fetch('/api/kanban/cards/' + cardId + '/', {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Resposta da exclusão:', res.status, res.statusText);

                if (res.ok) {
                    closeCardModal();
                    location.reload();
                } else {
                    let errMsg = 'Não foi possível excluir o cartão';
                    try {
                        const err = await res.json();
                        errMsg = err.error || errMsg;
                    } catch (jsonErr) {
                        console.error('Erro ao parsear resposta:', jsonErr);
                    }
                    alert('Erro: ' + errMsg);
                }
            } catch (e) {
                console.error('Erro ao excluir:', e);
                alert('Erro ao excluir cartão: ' + e.message);
            }
        };

        // Enter para adicionar item ao checklist
        document.getElementById('newChecklistItem').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                addChecklistItem();
            }
        });

        // Fechar modal ao clicar fora
        document.getElementById('cardModalOverlay').addEventListener('click', function (e) {
            if (e.target === this) {
                closeCardModal();
            }
        });

        // Adicionar event listeners para clicar nos cards
        document.querySelectorAll('.kanban-card').forEach(function (card) {
            card.addEventListener('click', function (e) {
                if (e.defaultPrevented) return;
                const cardId = this.dataset.cardId;
                openCardModal(cardId);
            });
        });

        // Inicializar Sortable para drag-and-drop
        document.querySelectorAll('.kanban-cards').forEach(function (container) {
            new Sortable(container, {
                group: 'cards',
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: async function (evt) {
                    const cardId = evt.item.dataset.cardId;
                    const newListId = evt.to.dataset.listId;
                    const newPosition = evt.newIndex;

                    try {
                        await fetch('/api/kanban/cards/' + cardId + '/move/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken
                            },
                            body: JSON.stringify({ list_id: newListId, position: newPosition })
                        });
                    } catch (e) {
                        console.error('Erro ao mover:', e);
                    }
                }
            });
        });

        // Auto-save card on blur
        window.autoSaveCard = async function () {
            if (!currentCard) return;

            const title = document.getElementById('editCardTitle').value.trim();
            if (!title) return;

            try {
                await fetch('/api/kanban/cards/' + currentCard.id + '/', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ title: title })
                });
                currentCard.title = title;
            } catch (e) {
                console.error('Erro ao salvar título:', e);
            }
        };

        // Toggle card options menu (3-dots)
        window.toggleCardOptionsMenu = function (event) {
            event.stopPropagation();
            const menu = document.getElementById('cardOptionsDropdown');
            menu.classList.toggle('show');

            const closeMenu = (e) => {
                if (!menu.contains(e.target)) {
                    menu.classList.remove('show');
                    document.removeEventListener('click', closeMenu);
                }
            };
            if (menu.classList.contains('show')) {
                setTimeout(() => document.addEventListener('click', closeMenu), 0);
            }
        };

        // Members functionality
        const availableMembers = JSON.parse(document.getElementById('membersData')?.textContent || '[]');
        let selectedMembers = [];


        // Update attachments meta display
        function updateAttachmentsDisplay(count) {
            const section = document.getElementById('attachmentsMetaSection');
            const countEl = document.getElementById('attachmentsCountNumber');
            if (section && countEl) {
                if (count > 0) {
                    countEl.textContent = count;
                    section.style.display = 'flex';
                } else {
                    section.style.display = 'none';
                }
            }
        }

        window.toggleMembersPanel = function () {
            const section = document.getElementById('membersSection');
            section.classList.toggle('show');

            if (section.classList.contains('show')) {
                renderMembers();
                if (window.event && event.currentTarget) {
                    const btn = event.currentTarget;
                    const rect = btn.getBoundingClientRect();
                    section.style.top = (rect.bottom + 5) + 'px';
                    section.style.left = (rect.left) + 'px';
                }
            }
        };

        function renderMembers() {
            const container = document.getElementById('membersContainer');
            if (!container) return;

            container.innerHTML = availableMembers.map(member => {
                const isSelected = selectedMembers.some(m => m === member.id || m.id === member.id);
                return `
                    <div class="member-item ${isSelected ? 'selected' : ''}" onclick="toggleMember(${member.id})">
                        <div class="member-avatar">${member.initials}</div>
                        <div class="member-info">
                            <div class="member-name">${member.name}</div>
                            <div class="member-role">${member.role}</div>
                        </div>
                        ${isSelected ? '<i class="bi bi-check-lg" style="color: var(--primary-color);"></i>' : ''}
                    </div>
                `;
            }).join('') || '<p style="color: var(--medium-gray); text-align: center; padding: 20px;">Nenhum membro disponível</p>';
        }

        window.toggleMember = async function (memberId) {
            if (!currentCard) return;

            const isCurrentlySelected = selectedMembers.some(m => m === memberId || m.id === memberId);
            const action = isCurrentlySelected ? 'remove' : 'add';

            try {
                const res = await fetch('/api/kanban/cards/' + currentCard.id + '/members/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ member_id: memberId, action: action })
                });

                if (res.ok) {
                    if (action === 'add') {
                        selectedMembers.push(memberId);
                    } else {
                        selectedMembers = selectedMembers.filter(m => m !== memberId && m.id !== memberId);
                    }
                    renderMembers();
                    updateAssignedMembersDisplay();
                }
            } catch (e) {
                console.error('Erro ao atribuir membro:', e);
            }
        };

        function updateAssignedMembersDisplay() {
            const section = document.getElementById('assignedMembersSection');
            const display = document.getElementById('assignedAvatarsDisplay');
            if (!section || !display) return;

            const activeMembers = availableMembers.filter(m =>
                selectedMembers.some(sm => sm === m.id || sm.id === m.id)
            );

            if (activeMembers.length > 0) {
                display.innerHTML = activeMembers.slice(0, 5).map(m =>
                    `<div class="assigned-avatar" title="${m.name}">${m.initials}</div>`
                ).join('');
                section.style.display = 'flex';
            } else {
                section.style.display = 'none';
            }
        }



        // Render activities
        function renderActivities(activities) {
            const container = document.getElementById('cardActivityLog');
            const toggleBtn = document.getElementById('toggleActivityBtn');
            if (!container) return;

            if (!activities || activities.length === 0) {
                container.innerHTML = '<p style="color: var(--medium-gray); text-align: center; padding: 20px; font-size: 13px;">Nenhuma atividade registrada</p>';
                if (toggleBtn) toggleBtn.style.display = 'none';
                return;
            }

            // Sort activities by date (most recent first)
            const sortedActivities = [...activities].sort((a, b) =>
                new Date(b.created_at) - new Date(a.created_at)
            );

            // Show last 3 activities by default, hide the rest
            const previewCount = 3;
            const hasMore = sortedActivities.length > previewCount;

            container.innerHTML = sortedActivities.map((activity, index) => {
                const timeAgo = getTimeAgo(activity.created_at);
                const isHidden = index >= previewCount;
                return `
                    <div class="activity-item ${isHidden ? 'hidden-preview' : ''}">
                        <div class="activity-avatar">${activity.user_initials || 'U'}</div>
                        <div class="activity-content">
                            <div class="activity-text">${activity.description}</div>
                            <div class="activity-date">${timeAgo}</div>
                        </div>
                    </div>
                `;
            }).join('');

            // Show/hide toggle button based on activity count
            if (toggleBtn) {
                if (hasMore) {
                    toggleBtn.style.display = 'inline-block';
                    toggleBtn.textContent = 'Mostrar Detalhes';
                } else {
                    toggleBtn.style.display = 'none';
                }
            }

            // Always show activity log (but with preview)
            container.classList.add('show');
        }

        // Time ago helper
        function getTimeAgo(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHour = Math.floor(diffMin / 60);
            const diffDay = Math.floor(diffHour / 24);

            if (diffSec < 60) return 'agora';
            if (diffMin < 60) return `há ${diffMin} minuto${diffMin > 1 ? 's' : ''}`;
            if (diffHour < 24) return `há ${diffHour} hora${diffHour > 1 ? 's' : ''}`;
            if (diffDay === 1) return 'ontem';
            if (diffDay < 7) return `há ${diffDay} dias`;
            return date.toLocaleDateString('pt-BR');
        }

        // Update attachments meta display
        function updateAttachmentsMetaDisplay(count) {
            const section = document.getElementById('attachmentsMetaSection');
            const countEl = document.getElementById('attachmentsCountNumber');
            if (section && countEl) {
                if (count > 0) {
                    countEl.textContent = count;
                    section.style.display = 'flex';
                } else {
                    section.style.display = 'none';
                }
            }
        }

        // Attachments functionality
        window.toggleAttachmentPanel = function () {
            const section = document.getElementById('attachmentsSection');
            section.classList.toggle('show');

            if (section.classList.contains('show')) {
                loadAttachments();
                if (window.event && event.currentTarget) {
                    const btn = event.currentTarget;
                    const rect = btn.getBoundingClientRect();
                    section.style.top = (rect.bottom + 5) + 'px';
                    section.style.left = (rect.left) + 'px';
                }
            }
        };

        async function loadAttachments() {
            if (!currentCard) return;
            const list = document.getElementById('attachmentsList');
            list.innerHTML = '<p style="color: var(--medium-gray); text-align: center;">Carregando...</p>';

            try {
                const res = await fetch('/api/kanban/cards/' + currentCard.id + '/attachments/');
                if (res.ok) {
                    const attachments = await res.json();
                    updateAttachmentsMetaDisplay(attachments.length);
                    if (attachments.length === 0) {
                        list.innerHTML = '<p style="color: var(--medium-gray); text-align: center; padding: 10px;">Nenhum anexo</p>';
                    } else {
                        list.innerHTML = attachments.map(att => `
                            <div class="attachment-item">
                                <i class="bi bi-file-earmark attachment-icon"></i>
                                <div class="attachment-info">
                                    <a href="${att.url}" target="_blank" class="attachment-name">${att.filename}</a>
                                    <div class="attachment-date">${att.uploaded_at}</div>
                                </div>
                                <i class="bi bi-trash attachment-delete" onclick="deleteAttachment(${att.id})"></i>
                            </div>
                        `).join('');
                    }
                }
            } catch (e) {
                console.error('Erro ao carregar anexos:', e);
                list.innerHTML = '<p style="color: #ef4444;">Erro ao carregar</p>';
            }
        }

        window.uploadAttachment = async function (input) {
            if (!currentCard || !input.files || input.files.length === 0) return;

            const file = input.files[0];
            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch('/api/kanban/cards/' + currentCard.id + '/attachments/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    body: formData
                });

                if (res.ok) {
                    loadAttachments();
                    input.value = '';
                } else {
                    alert('Erro ao fazer upload');
                }
            } catch (e) {
                console.error('Erro ao fazer upload:', e);
            }
        };

        window.deleteAttachment = async function (attachmentId) {
            if (!confirm('Excluir este anexo?')) return;

            try {
                const res = await fetch('/api/kanban/cards/' + currentCard.id + '/attachments/' + attachmentId + '/', {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                });
                if (res.ok) {
                    loadAttachments();
                }
            } catch (e) {
                console.error('Erro ao excluir anexo:', e);
            }
        };

        // Toggle activity details
        window.toggleActivityDetails = function () {
            const activityLog = document.getElementById('cardActivityLog');
            const toggleBtn = document.getElementById('toggleActivityBtn');

            if (activityLog.classList.contains('expanded')) {
                // Collapse to preview (show only 3)
                activityLog.classList.remove('expanded');
                toggleBtn.textContent = 'Mostrar Detalhes';
            } else {
                // Expand to show all
                activityLog.classList.add('expanded');
                toggleBtn.textContent = 'Ocultar Detalhes';
            }
        };

        // ============================================
        // LABEL MANAGEMENT SYSTEM
        // ============================================

        // Trello color palette (30 colors)
        const labelColors = [
            '#b3f3da', '#f3d660', '#fad29c', '#f8c4d0', '#e1c7fd',
            '#61bd4f', '#f2d600', '#ff9f1a', '#eb5a46', '#c377e0',
            '#0b6e49', '#946f00', '#ad5e18', '#ae2a19', '#68217a',
            '#c6edfb', '#c0e6ff', '#d5f4e9', '#fdd7e4', '#e6e6e6',
            '#579dff', '#60c6d2', '#94c748', '#e774bb', '#8e8e8e',
            '#1f7eeb', '#227d9b', '#5b7c11', '#a8528f', '#626362'
        ];

        let currentEditingLabel = null;
        let allBoardLabels = [];
        let currentCardLabels = [];

        // Open label selection modal
        window.openLabelsManagement = function () {
            if (!currentCard) return;

            // Load labels and show modal
            loadBoardLabels().then(() => {
                document.getElementById('labelsModalOverlay').style.display = 'flex';
                renderLabelsList();
            });
        };

        // Close label selection
        window.closeLabelSelection = function () {
            document.getElementById('labelsModalOverlay').style.display = 'none';
        };

        // Load all board labels
        async function loadBoardLabels() {
            try {
                // Assuming boardId is 1 - adjust based on your implementation
                const boardId = 1;
                const res = await fetch(`/api/kanban/boards/${boardId}/labels/`);
                const data = await res.json();
                allBoardLabels = data.labels || [];

                // Get current card labels
                if (currentCard && currentCard.labels) {
                    currentCardLabels = currentCard.labels.map(l => l.id);
                }
            } catch (e) {
                console.error('Error loading labels:', e);
                allBoardLabels = [];
            }
        }

        // Render labels list
        function renderLabelsList() {
            const container = document.getElementById('labelsList');
            if (!container) return;

            if (allBoardLabels.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Nenhuma etiqueta criada</p>';
                return;
            }

            container.innerHTML = allBoardLabels.map(label => {
                const isChecked = currentCardLabels.includes(label.id);
                const displayName = label.name || '';

                return `
                    <div class="label-item" data-label-id="${label.id}">
                        <input type="checkbox" ${isChecked ? 'checked' : ''} 
                               onchange="toggleLabelOnCard(${label.id})">
                        <div class="label-item-color" style="background: ${label.color};"
                             onclick="toggleLabelOnCard(${label.id})">
                            ${displayName}
                        </div>
                        <button class="label-item-edit" onclick="openEditLabel(${label.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        // Toggle label on card
        window.toggleLabelOnCard = async function (labelId) {
            if (!currentCard) return;

            const isCurrentlyOn = currentCardLabels.includes(labelId);
            const action = isCurrentlyOn ? 'remove' : 'add';

            try {
                const res = await fetch(`/api/kanban/cards/${currentCard.id}/labels/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        label_id: labelId,
                        action: action
                    })
                });

                if (res.ok) {
                    // Update local state
                    if (action === 'add') {
                        currentCardLabels.push(labelId);
                    } else {
                        currentCardLabels = currentCardLabels.filter(id => id !== labelId);
                    }

                    // Re-render
                    renderLabelsList();
                    // Reload card to show updated labels
                    location.reload();
                }
            } catch (e) {
                console.error('Error toggling label:', e);
            }
        };

        // Filter labels
        window.filterLabels = function () {
            const search = document.getElementById('labelSearch').value.toLowerCase();
            const items = document.querySelectorAll('.label-item');

            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(search) ? 'flex' : 'none';
            });
        };

        // Open create label
        window.openCreateLabel = function () {
            currentEditingLabel = null;
            document.getElementById('labelEditTitle').textContent = 'Criar etiqueta';
            document.getElementById('labelNameInput').value = '';
            document.getElementById('labelPreview').style.background = '#61bd4f';
            document.getElementById('deleteLabelBtn').style.display = 'none';

            // Render color picker
            renderColorPicker('#61bd4f');

            // Hide selection modal, show edit modal
            document.getElementById('labelsModalOverlay').style.display = 'none';
            document.getElementById('labelEditModalOverlay').style.display = 'flex';
        };

        // Open edit label
        window.openEditLabel = function (labelId) {
            const label = allBoardLabels.find(l => l.id === labelId);
            if (!label) return;

            currentEditingLabel = label;
            document.getElementById('labelEditTitle').textContent = 'Editar etiqueta';
            document.getElementById('labelNameInput').value = label.name || '';
            document.getElementById('labelPreview').style.background = label.color;
            document.getElementById('deleteLabelBtn').style.display = 'block';

            // Render color picker
            renderColorPicker(label.color);

            // Hide selection modal, show edit modal
            document.getElementById('labelsModalOverlay').style.display = 'none';
            document.getElementById('labelEditModalOverlay').style.display = 'flex';
        };

        // Render color picker grid
        function renderColorPicker(selectedColor) {
            const container = document.getElementById('colorPickerGrid');
            if (!container) return;

            container.innerHTML = labelColors.map(color => `
                <div class="color-option ${color === selectedColor ? 'selected' : ''}" 
                     style="background: ${color};"
                     onclick="selectColor('${color}')"></div>
            `).join('');
        }

        // Select color
        window.selectColor = function (color) {
            document.getElementById('labelPreview').style.background = color;

            // Update selected state
            document.querySelectorAll('.color-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            event.target.classList.add('selected');
        };

        // Save label (create or update)
        window.saveLabel = async function () {
            const name = document.getElementById('labelNameInput').value.trim();
            const color = document.getElementById('labelPreview').style.background || '#61bd4f';
            const boardId = 1; // Adjust based on your implementation

            if (currentEditingLabel) {
                // Update existing label
                try {
                    const res = await fetch(`/api/kanban/labels/${currentEditingLabel.id}/`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ name, color })
                    });

                    if (res.ok) {
                        closeLabelEdit();
                        await loadBoardLabels();
                        openLabelsManagement();
                    }
                } catch (e) {
                    console.error('Error updating label:', e);
                    alert('Erro ao atualizar etiqueta');
                }
            } else {
                // Create new label
                try {
                    const res = await fetch(`/api/kanban/boards/${boardId}/labels/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ name, color })
                    });

                    if (res.ok) {
                        closeLabelEdit();
                        await loadBoardLabels();
                        openLabelsManagement();
                    }
                } catch (e) {
                    console.error('Error creating label:', e);
                    alert('Erro ao criar etiqueta');
                }
            }
        };

        // Delete label
        window.removeLabel = async function () {
            if (!currentEditingLabel) return;

            if (!confirm(`Excluir a etiqueta "${currentEditingLabel.name || 'sem nome'}"?`)) {
                return;
            }

            try {
                const res = await fetch(`/api/kanban/labels/${currentEditingLabel.id}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                });

                if (res.ok) {
                    closeLabelEdit();
                    await loadBoardLabels();
                    openLabelsManagement();
                }
            } catch (e) {
                console.error('Error deleting label:', e);
                alert('Erro ao excluir etiqueta');
            }
        };

        // Back to label selection
        window.backToLabelSelection = function () {
            closeLabelEdit();
            openLabelsManagement();
        };

        // Close label edit
        window.closeLabelEdit = function () {
            document.getElementById('labelEditModalOverlay').style.display = 'none';
        };

    })();
</script>
{% endblock scripts %}