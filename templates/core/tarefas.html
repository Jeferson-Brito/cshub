{% extends 'base.html' %}

{% block content %}
{% csrf_token %}
<div class="container-fluid">

    <!-- Header -->
    <div class="page-header">

        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="page-title"><i class="bi bi-list-task"></i> {{ title }}</h1>
                <p class="page-subtitle">Gerencie suas tarefas e rotinas diárias</p>
            </div>
            <div class="d-flex gap-2 align-items-center">
                <select id="statusFilter" class="form-select" style="width: auto;" onchange="filterTasks()">
                    <option value="">Todos os Status</option>
                    <option value="pendente">Pendentes</option>
                    <option value="em_andamento">Em Andamento</option>
                    <option value="concluida">Concluídas</option>
                </select>
                {% if show_create_button %}
                <div class="dropdown">
                    <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown"
                        data-bs-boundary="viewport" data-bs-popper-config='{"strategy":"fixed"}'>
                        <i class="bi bi-plus-lg"></i> Criar
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow-lg" style="z-index: 1050;">
                        {% if is_manager %}
                        <li><a class="dropdown-item" href="#" onclick="openCreateTaskModal(); return false;">
                                <i class="bi bi-check2-square text-primary"></i> Nova Tarefa
                            </a></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        {% endif %}
                        <li><a class="dropdown-item" href="#" onclick="openRefundRequestModal(); return false;">
                                <i class="bi bi-receipt-cutoff text-warning"></i> Solicitar ao CS Clientes
                            </a></li>
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Alertas para Gestores -->
    {% if is_manager %}
    <div id="manager-alerts" class="alert alert-warning d-none mb-4">
        <h6 class="alert-heading mb-2"><i class="bi bi-exclamation-triangle-fill"></i> Rotinas não cumpridas ontem</h6>
        <ul id="alerts-list" class="mb-0 small"></ul>
    </div>
    {% endif %}

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-6 col-lg-3 mb-3">
            <div class="stat-card stat-card-primary">
                <div class="stat-card-icon"><i class="bi bi-list-task"></i></div>
                <p class="stat-card-title">Total Tarefas</p>
                <h2 class="stat-card-value" id="stat-total">0</h2>
            </div>
        </div>
        <div class="col-6 col-lg-3 mb-3">
            <div class="stat-card stat-card-warning">
                <div class="stat-card-icon"><i class="bi bi-hourglass-split"></i></div>
                <p class="stat-card-title">Pendentes</p>
                <h2 class="stat-card-value" id="stat-pending">0</h2>
            </div>
        </div>
        <div class="col-6 col-lg-3 mb-3">
            <div class="stat-card stat-card-info">
                <div class="stat-card-icon"><i class="bi bi-receipt-cutoff"></i></div>
                <p class="stat-card-title">Solicitações CS</p>
                <h2 class="stat-card-value" id="stat-refunds">0</h2>
            </div>
        </div>
        <div class="col-6 col-lg-3 mb-3">
            <div class="stat-card stat-card-success">
                <div class="stat-card-icon"><i class="bi bi-check-circle"></i></div>
                <p class="stat-card-title">Concluídas</p>
                <h2 class="stat-card-value" id="stat-completed">0</h2>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Tarefas Atribuídas -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-list-ul text-primary"></i> Tarefas Atribuídas</h5>
                    {% if is_manager %}
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-primary" id="btn-team"
                            onclick="loadTasks('team')">Time</button>
                        <button type="button" class="btn btn-light border" id="btn-my"
                            onclick="loadTasks('my')">Minhas</button>
                    </div>
                    {% endif %}

                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="tasksTable">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 50px;"></th>
                                    <th>Tarefa</th>
                                    <th>Atribuído</th>
                                    <th>Prazo</th>
                                    <th>Prioridade</th>
                                    {% if is_manager %}<th style="width: 80px;">Ações</th>{% endif %}
                                </tr>
                            </thead>
                            <tbody id="tasks-list">
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="clearfix"></div>

    <!-- Solicitações ao CS Clientes (NRS Suporte) -->
    <div class="row mt-4" style="position: relative; z-index: 1;">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white py-3">
                    <h5 class="mb-3 fw-bold"><i class="bi bi-receipt-cutoff me-2"></i>Solicitações ao CS Clientes</h5>
                    <div class="d-flex gap-2 align-items-center flex-wrap">
                        <input type="text" class="form-control form-control-sm rounded-pill shadow-sm" id="refundSearch"
                            placeholder="Buscar por ID, nome, CPF..." style="width: 150px; border: none;"
                            onkeyup="searchRefunds()">
                        <select class="form-select form-select-sm rounded-pill shadow-sm" id="refundAnalystFilter"
                            style="width: 150px; border: none;" onchange="loadMyRefunds()">
                            <option value="">Todos Analistas</option>
                        </select>
                        <input type="text" class="form-control form-control-sm rounded-pill shadow-sm"
                            id="refundStoreFilter" placeholder="Loja (ex: PB05)" style="width: 150px; border: none;"
                            onkeyup="searchRefunds()">
                        <select class="form-select form-select-sm rounded-pill shadow-sm" id="refundStatusFilter"
                            style="width: 150px; border: none;" onchange="loadMyRefunds()">
                            <option value="">Todos Status</option>
                            <option value="aberta">Abertas</option>
                            <option value="em_analise">Em Análise</option>
                            <option value="concluida">Concluídas</option>
                            <option value="cancelada">Canceladas</option>
                        </select>
                        <button class="btn btn-sm btn-light rounded-pill shadow-sm" onclick="clearRefundFilters()"
                            title="Limpar filtros">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Analista</th>
                                    <th>Loja</th>
                                    <th>Cliente</th>
                                    <th>Valor</th>
                                    <th>Status</th>
                                    <th>Visualizado por</th>
                                    <th>Data</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="my-refunds-list">
                                <tr>
                                    <td colspan="9" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Detalhes Solicitação -->
<div class="modal fade" id="refundDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-receipt"></i> Solicitação #<span id="refund-detail-id"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="refund-detail-content">
                <!-- Preenchido via JS -->
            </div>
            <div class="modal-footer" id="refund-detail-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>


<!-- Modal Criar Tarefa -->
<div class="modal fade" id="createTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-check2-square text-primary"></i> Nova Tarefa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createTaskForm">
                    <div class="mb-3">
                        <label class="form-label">Título</label>
                        <input type="text" class="form-control" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descrição</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Atribuir a</label>
                        <select class="form-select" name="assigned_to" id="task-analyst-select" required>
                            <!-- Preenchido via JS -->
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Prazo (Data e Hora)</label>
                            <input type="datetime-local" class="form-control" name="due_date" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Prioridade</label>
                            <select class="form-select" name="priority">
                                <option value="baixa">Baixa</option>
                                <option value="media" selected>Média</option>
                                <option value="alta">Alta</option>
                                <option value="urgente">Urgente</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveTask()">Criar Tarefa</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Criar Rotina -->
<div class="modal fade" id="createRoutineModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-arrow-repeat text-success"></i> Nova Rotina Diária</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createRoutineForm">
                    <div class="mb-3">
                        <label class="form-label">Título da Atividade</label>
                        <input type="text" class="form-control" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descrição/Procedimento</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Atribuir a</label>
                        <select class="form-select" name="assigned_to" id="routine-analyst-select" required>
                            <!-- Preenchido via JS -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label d-block text-uppercase small fw-bold text-muted">Horário
                                    *</label>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <label class="form-label small text-muted text-uppercase mb-1">Início</label>
                                        <div class="custom-timepicker-container">
                                            <input type="text" class="custom-timepicker-input" name="time_start"
                                                placeholder="--:--" readonly>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small text-muted text-uppercase mb-1">Fim</label>
                                        <div class="custom-timepicker-container">
                                            <input type="text" class="custom-timepicker-input" name="time_limit"
                                                placeholder="--:--" readonly>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-text mt-1">Defina o intervalo (opcional).</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveRoutine()">Criar Rotina</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Task Modal -->
<div class="modal fade" id="editTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil-square text-primary"></i> Editar Tarefa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editTaskForm">
                    <input type="hidden" name="task_id">
                    <div class="mb-3">
                        <label class="form-label">Título</label>
                        <input type="text" class="form-control" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descrição</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Prazo (Data e Hora)</label>
                        <input type="datetime-local" class="form-control" name="due_date">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Prioridade</label>
                        <select class="form-select" name="priority">
                            <option value="baixa">Baixa</option>
                            <option value="media">Média</option>
                            <option value="alta">Alta</option>
                            <option value="urgente">Urgente</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveEditTask()">Salvar Alterações</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Solicitar ao CS Clientes -->
<div class="modal fade" id="refundRequestModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-receipt-cutoff text-warning"></i> Solicitar Estorno ao CS
                    Clientes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="refundRequestForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nome do Analista</label>
                            <input type="text" class="form-control" id="refund-analyst-name" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Código da Loja <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="store_code" placeholder="Ex: PB05" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nome do Cliente <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="customer_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">CPF do Cliente <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="customer_cpf" id="cpf-input"
                                placeholder="000.000.000-00" maxlength="14" oninput="formatCPF(this)" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">E-mail do Cliente <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" name="customer_email" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Telefone do Cliente <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="customer_phone" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Data do Ocorrido <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" name="incident_date" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Horário do Ocorrido <span class="text-danger">*</span></label>
                            <input type="time" class="form-control" name="incident_time" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Local da Compra <span class="text-danger">*</span></label>
                            <select class="form-select" name="purchase_location" required>
                                <option value="" disabled selected>Selecione...</option>
                                <option value="loja_fisica">Loja Física</option>
                                <option value="site">Site</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Motivo da Solicitação de Estorno <span
                                class="text-danger">*</span></label>
                        <textarea class="form-control" name="reason" rows="3" required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Verificou nas Câmeras? <span class="text-danger">*</span></label>
                            <select class="form-select" name="checked_cameras" required>
                                <option value="" disabled selected>Selecione...</option>
                                <option value="false">Não</option>
                                <option value="true">Sim</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Valor do Estorno <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control" name="refund_value" id="refund-value-input"
                                    placeholder="0,00" oninput="formatCurrency(this)" required>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Pagamento realizado com: <span
                                    class="text-danger">*</span></label>
                            <select class="form-select" name="refund_type" required onchange="togglePixField(this)">
                                <option value="" disabled selected>Selecione...</option>
                                <option value="pix">PIX</option>
                                <option value="cartao_credito">Cartão de Crédito</option>
                                <option value="cartao_debito">Cartão de Débito</option>
                                <option value="checkout_web">Checkout Web (Site)</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Destino do estorno <span class="text-danger">*</span></label>
                            <select class="form-select" name="refund_destination" required>
                                <option value="" disabled selected>Selecione...</option>
                                <option value="estorno_bancario">Estorno bancário</option>
                                <option value="creditos_lavanderia">Créditos na lavanderia</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3" id="pix-key-field">
                        <label class="form-label">Chave PIX para Estorno</label>
                        <input type="text" class="form-control" name="pix_key"
                            placeholder="CPF, E-mail, Telefone ou Chave aleatória">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Resumo do Atendimento <span class="text-danger">*</span></label>
                        <textarea class="form-control" name="summary" rows="3" required
                            placeholder="Descreva o resumo do atendimento ao cliente..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><i class="bi bi-paperclip"></i> Anexos (fotos, prints, etc.)</label>
                        <input type="file" class="form-control" name="attachments" id="refund-attachments" multiple
                            accept="image/*,.pdf,.doc,.docx">
                        <div class="form-text">Você pode anexar imagens, PDFs ou documentos. Máximo 5 arquivos.</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="submitRefundRequest()">
                    <i class="bi bi-send"></i> Enviar Solicitação
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Editar Solicitação de Estorno -->
<div class="modal fade" id="editRefundModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-pencil-square"></i> Editar Solicitação de Estorno #<span
                        id="edit-refund-id"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editRefundForm">
                    <input type="hidden" name="refund_id" id="edit-refund-id-input">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Código da Loja</label>
                            <input type="text" class="form-control" name="store_code" id="edit-store_code" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nome do Cliente</label>
                            <input type="text" class="form-control" name="customer_name" id="edit-customer_name"
                                required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">CPF do Cliente</label>
                            <input type="text" class="form-control" name="customer_cpf" id="edit-customer_cpf" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">E-mail do Cliente</label>
                            <input type="email" class="form-control" name="customer_email" id="edit-customer_email"
                                required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Telefone do Cliente</label>
                            <input type="text" class="form-control" name="customer_phone" id="edit-customer_phone"
                                required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Data do Ocorrido</label>
                            <input type="date" class="form-control" name="incident_date" id="edit-incident_date"
                                required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Valor do Estorno</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control" name="refund_value" id="edit-refund_value"
                                    required>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Tipo de Pagamento</label>
                            <select class="form-select" name="refund_type" id="edit-refund_type" required>
                                <option value="pix">PIX</option>
                                <option value="cartao_credito">Cartão de Crédito</option>
                                <option value="cartao_debito">Cartão de Débito</option>
                                <option value="checkout_web">Checkout Web</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Destino do Estorno</label>
                            <select class="form-select" name="refund_destination" id="edit-refund_destination" required>
                                <option value="estorno_bancario">Estorno bancário</option>
                                <option value="creditos_lavanderia">Créditos na lavanderia</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Chave PIX (se aplicável)</label>
                        <input type="text" class="form-control" name="pix_key" id="edit-pix_key">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Motivo</label>
                        <textarea class="form-control" name="reason" id="edit-reason" rows="2" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Resumo do Atendimento</label>
                        <textarea class="form-control" name="summary" id="edit-summary" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveEditRefund()">
                    <i class="bi bi-check-lg"></i> Salvar Alterações
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    const isManager = "{{ is_manager|yesno:'true,false' }}" === "true";
    let currentFilter = '';

    document.addEventListener('DOMContentLoaded', function () {
        loadTasks();
        loadMyRefunds();
        loadAnalystsForFilter();
        if (document.getElementById('manager-alerts')) {
            loadManagerAlerts();
        }
        if (isManager) {
            loadUsersOptions();
        }
    });



    function updateStats() {
        // Count stats from loaded data
        const taskRows = document.querySelectorAll('#tasks-list tr:not(.empty-row)');
        const routineRows = document.querySelectorAll('#daily-routines-list tr:not(.empty-row)');

        // Will be updated after data loads
    }

    async function loadUsersOptions() {
        try {
            const res = await fetch('/api/eventos/users/');
            if (res.ok) {
                const users = await res.json();
                const options = users.map(u => `<option value="${u.id}">${u.nome}</option>`).join('');
                const allOption = '<option value="all" class="fw-bold">Selecionar Todos</option>';
                document.getElementById('task-analyst-select').innerHTML = '<option value="">Selecione...</option>' + allOption + options;
                document.getElementById('routine-analyst-select').innerHTML = '<option value="">Selecione...</option>' + allOption + options;
            }
        } catch (e) {
            console.error('Erro ao carregar usuários', e);
        }
    }

    async function loadDailyRoutines() {
        try {
            const res = await fetch('/api/routines/daily/');
            const routines = await res.json();
            const tbody = document.getElementById('daily-routines-list');

            if (routines.length === 0) {
                tbody.innerHTML = '<tr class="empty-row"><td colspan="3" class="text-center text-muted py-4">Nenhuma rotina atribuída para hoje.</td></tr>';
                document.getElementById('stat-routines').textContent = '0';
                return;
            }

            const completed = routines.filter(r => r.completed).length;
            document.getElementById('stat-routines').textContent = `${completed}/${routines.length}`;

            tbody.innerHTML = routines.map(r => `
                <tr class="${r.completed ? 'table-success' : ''}">
                    <td class="text-center">
                        <input class="form-check-input" type="checkbox" 
                            ${r.completed ? 'checked' : ''}
                            onchange="toggleRoutine(${r.log_id}, this.checked)">
                    </td>
                    <td>
                        <span class="${r.completed ? 'text-decoration-line-through text-muted' : ''}">${r.title}</span>
                        ${r.description ? `<br><small class="text-muted">${r.description}</small>` : ''}
                    </td>
                    <td>
                        ${r.completed
                    ? '<span class="badge bg-success"><i class="bi bi-check-lg"></i> Feito</span>'
                    : '<span class="badge bg-warning text-dark"><i class="bi bi-clock"></i> Pendente</span>'}
                    </td>
                </tr>
            `).join('');
        } catch (e) {
            console.error(e);
        }
    }

    async function toggleRoutine(logId, completed) {
        try {
            const res = await fetch(`/api/routines/check/${logId}/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ completed })
            });
            if (res.ok) {
                loadDailyRoutines();
            }
        } catch (e) {
            alert('Erro ao atualizar rotina');
        }
    }

    async function loadTasks(type = 'team') {
        // Update button states
        const btnTeam = document.getElementById('btn-team');
        const btnMy = document.getElementById('btn-my');
        if (btnTeam && btnMy) {
            if (type === 'team') {
                btnTeam.className = 'btn btn-primary';
                btnMy.className = 'btn btn-light border';
            } else {
                btnTeam.className = 'btn btn-light border';
                btnMy.className = 'btn btn-primary';
            }
        }


        try {
            const res = await fetch(`/api/tasks/?type=${type}`);
            const tasks = await res.json();
            const tbody = document.getElementById('tasks-list');

            // Update stats
            const total = tasks.length;
            const pending = tasks.filter(t => t.status === 'pendente').length;
            const completed = tasks.filter(t => t.status === 'concluida').length;

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-pending').textContent = pending;
            document.getElementById('stat-completed').textContent = completed;

            if (tasks.length === 0) {
                tbody.innerHTML = '<tr class="empty-row"><td colspan="6" class="text-center text-muted py-4">Nenhuma tarefa encontrada.</td></tr>';
                return;
            }

            tbody.innerHTML = tasks.map(t => {
                const priorityBadge = getPriorityBadge(t.priority);
                const dateFormatted = t.due_date ? new Date(t.due_date).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' }) : '-';
                const isLate = isOverdue(t.due_date, t.status);

                const actionBtns = isManager ? `
                    <button class="btn btn-sm btn-outline-secondary" title="Editar"
                        onclick="openEditTaskModal('${t.id}', '${t.title}', \`${t.description || ''}\`, '${t.due_date}', '${t.priority}')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" title="Excluir"
                        onclick="deleteTask(${t.id})">
                        <i class="bi bi-trash"></i>
                    </button>
                ` : '';

                return `
                <tr class="${t.status === 'concluida' ? 'table-success' : ''}">
                    <td class="text-center">
                        <input class="form-check-input" type="checkbox" 
                            ${t.status === 'concluida' ? 'checked' : ''}
                            onchange="toggleTask(${t.id}, this.checked)">
                    </td>
                    <td>
                        <span class="${t.status === 'concluida' ? 'text-decoration-line-through text-muted' : ''}">${t.title}</span>
                        ${t.description ? `<br><small class="text-muted">${t.description}</small>` : ''}
                    </td>
                    <td><small>${t.assigned_to}</small></td>
                    <td class="${isLate ? 'text-danger fw-bold' : ''}">
                        <small>${dateFormatted}</small>
                        ${isLate ? '<br><span class="badge bg-danger">Atrasada</span>' : ''}
                    </td>
                    <td>${priorityBadge}</td>
                    ${isManager ? `<td class="text-nowrap">${actionBtns}</td>` : ''}
                </tr>
            `}).join('');
        } catch (e) {
            console.error(e);
        }
    }

    async function deleteTask(taskId) {
        if (!confirm('Tem certeza que deseja excluir esta tarefa?')) return;

        try {
            const res = await fetch(`/api/tasks/${taskId}/delete/`, {
                method: 'DELETE',
                headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
            });

            if (res.ok) {
                loadTasks();
            } else {
                const err = await res.json();
                alert('Erro: ' + (err.error || 'Não foi possível excluir a tarefa'));
            }
        } catch (e) {
            console.error('Erro ao excluir tarefa:', e);
            alert('Erro ao excluir tarefa');
        }
    }

    function getPriorityBadge(priority) {
        const badges = {
            'baixa': '<span class="badge bg-secondary">Baixa</span>',
            'media': '<span class="badge bg-info">Média</span>',
            'alta': '<span class="badge bg-warning text-dark">Alta</span>',
            'urgente': '<span class="badge bg-danger">Urgente</span>'
        };
        return badges[priority] || priority;
    }

    async function toggleTask(taskId, completed) {
        try {
            const res = await fetch(`/api/tasks/${taskId}/toggle/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ completed })
            });
            if (res.ok) {
                loadTasks();
            } else {
                alert('Você não tem permissão para alterar esta tarefa.');
                loadTasks();
            }
        } catch (e) {
            alert('Erro ao atualizar tarefa');
        }
    }

    async function saveTask() {
        const form = document.getElementById('createTaskForm');
        const data = {
            title: form.title.value,
            description: form.description.value,
            assigned_to_id: form.assigned_to.value,
            due_date: form.due_date.value,
            priority: form.priority.value
        };

        try {
            const res = await fetch('/api/tasks/create/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (res.ok) {
                bootstrap.Modal.getInstance(document.getElementById('createTaskModal')).hide();
                form.reset();
                loadTasks();
                if (window.showToast) window.showToast('Tarefa criada com sucesso!', 'success');
            } else {
                if (window.showToast) window.showToast('Erro ao criar tarefa', 'error');
            }
        } catch (e) {
            if (window.showToast) window.showToast('Erro de conexão', 'error');
        }
    }

    async function saveRoutine() {
        const form = document.getElementById('createRoutineForm');
        const data = {
            title: form.title.value,
            description: form.description.value,
            assigned_to_id: form.assigned_to.value,
            time_limit: form.time_limit.value
        };

        try {
            const res = await fetch('/api/routines/create/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (res.ok) {
                bootstrap.Modal.getInstance(document.getElementById('createRoutineModal')).hide();
                form.reset();
                loadDailyRoutines();
                if (window.showToast) window.showToast('Rotina atribuída com sucesso!', 'success');
            } else {
                if (window.showToast) window.showToast('Erro ao criar rotina', 'error');
            }
        } catch (e) {
            if (window.showToast) window.showToast('Erro de conexão', 'error');
        }
    }

    async function loadManagerAlerts() {
        try {
            const res = await fetch('/api/routines/alerts/');
            if (res.ok) {
                const alerts = await res.json();
                const container = document.getElementById('manager-alerts');
                const list = document.getElementById('alerts-list');

                if (alerts.length > 0) {
                    container.classList.remove('d-none');
                    list.innerHTML = alerts.map(a => `
                        <li><strong>${a.analyst}</strong> não realizou: "${a.routine}" em ${new Date(a.date).toLocaleDateString('pt-BR')}.</li>
                    `).join('');
                }
            }
        } catch (e) {
            console.error(e);
        }
    }

    function openEditTaskModal(id, title, description, dueDate, priority) {
        const modal = new bootstrap.Modal(document.getElementById('editTaskModal'));
        const form = document.getElementById('editTaskForm');
        form.task_id.value = id;
        form.title.value = title;
        form.description.value = (description && description !== 'null' && description !== 'undefined') ? description : '';

        if (dueDate && dueDate !== 'null' && dueDate !== 'None') {
            const d = new Date(dueDate);
            if (!isNaN(d)) {
                const offset = d.getTimezoneOffset() * 60000;
                const localISOTime = (new Date(d - offset)).toISOString().slice(0, 16);
                form.due_date.value = localISOTime;
            }
        } else {
            form.due_date.value = '';
        }
        form.priority.value = priority;
        modal.show();
    }

    async function saveEditTask() {
        const form = document.getElementById('editTaskForm');
        const id = form.task_id.value;
        const data = {
            title: form.title.value,
            description: form.description.value,
            due_date: form.due_date.value,
            priority: form.priority.value
        };

        try {
            const res = await fetch(`/api/tasks/${id}/edit/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (res.ok) {
                bootstrap.Modal.getInstance(document.getElementById('editTaskModal')).hide();
                loadTasks();
                if (window.showToast) window.showToast('Tarefa atualizada!', 'success');
            } else {
                if (window.showToast) window.showToast('Erro ao atualizar tarefa', 'error');
            }
        } catch (e) {
            if (window.showToast) window.showToast('Erro de conexão', 'error');
        }
    }

    function openCreateTaskModal() {
        new bootstrap.Modal(document.getElementById('createTaskModal')).show();
    }

    function openCreateRoutineModal() {
        new bootstrap.Modal(document.getElementById('createRoutineModal')).show();
    }

    function openRefundRequestModal() {
        const analystNameField = document.getElementById('refund-analyst-name');
        analystNameField.value = '{{ user.get_full_name|default:user.username }}';
        document.getElementById('refundRequestForm').reset();
        analystNameField.value = '{{ user.get_full_name|default:user.username }}';
        document.getElementById('pix-key-field').style.display = 'block';
        new bootstrap.Modal(document.getElementById('refundRequestModal')).show();
    }

    function togglePixField(select) {
        const pixField = document.getElementById('pix-key-field');
        pixField.style.display = select.value === 'pix' ? 'block' : 'none';
    }

    async function submitRefundRequest() {
        const form = document.getElementById('refundRequestForm');

        // Validate all required fields
        const requiredFields = [
            { name: 'store_code', label: 'Código da Loja' },
            { name: 'customer_name', label: 'Nome do Cliente' },
            { name: 'customer_cpf', label: 'CPF do Cliente' },
            { name: 'customer_email', label: 'E-mail do Cliente' },
            { name: 'customer_phone', label: 'Telefone do Cliente' },
            { name: 'incident_date', label: 'Data do Ocorrido' },
            { name: 'purchase_location', label: 'Local da Compra' },
            { name: 'reason', label: 'Motivo da Solicitação de Estorno' },
            { name: 'checked_cameras', label: 'Verificou nas Câmeras?' },
            { name: 'refund_value', label: 'Valor do Estorno' },
            { name: 'refund_type', label: 'Pagamento realizado com' },
            { name: 'refund_destination', label: 'Destino do Estorno' },
            { name: 'summary', label: 'Resumo do Atendimento' }
        ];

        for (const field of requiredFields) {
            const el = form.elements[field.name];
            if (!el || !el.value || el.value.trim() === '') {
                if (window.showToast) window.showToast(`O campo "${field.label}" é obrigatório!`, 'error');
                if (el) el.focus();
                return;
            }
        }

        const formData = new FormData(form);

        // Add attachments from file input
        const attachmentInput = document.getElementById('refund-attachments');
        if (attachmentInput && attachmentInput.files.length > 0) {
            // Limit to 5 files
            const files = Array.from(attachmentInput.files).slice(0, 5);
            // Clear any existing attachments key and re-add
            formData.delete('attachments');
            files.forEach((file, index) => {
                formData.append('attachments', file);
            });
        }

        try {
            const res = await fetch('/api/refunds/create/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken()
                },
                body: formData
            });

            if (res.ok) {
                const result = await res.json();
                bootstrap.Modal.getInstance(document.getElementById('refundRequestModal')).hide();
                if (window.showToast) window.showToast(result.message, 'success');
                loadMyRefunds();
            } else {
                const err = await res.json();
                if (window.showToast) window.showToast(err.error || 'Erro ao enviar solicitação', 'error');
            }
        } catch (e) {
            console.error('Erro ao enviar solicitação', e);
            if (window.showToast) window.showToast('Erro de conexão', 'error');
        }
    }

    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
            document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1] || '';
    }

    function formatCPF(input) {
        let value = input.value.replace(/\D/g, '');
        if (value.length > 11) value = value.slice(0, 11);
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        input.value = value;
    }

    function formatCurrency(input) {
        let value = input.value.replace(/\D/g, '');
        if (value === '') {
            input.value = '';
            return;
        }
        value = (parseInt(value) / 100).toFixed(2);
        value = value.replace('.', ',');
        value = value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        input.value = value;
    }

    function isOverdue(dateStr, status) {
        if (!dateStr || status === 'concluida') return false;
        return new Date(dateStr) < new Date().setHours(0, 0, 0, 0);
    }

    async function loadManagerRoutineOverview() {
        try {
            const res = await fetch('/api/routines/overview/');
            if (res.ok) {
                const data = await res.json();
                const container = document.getElementById('team-routines-list');

                if (data.length === 0) {
                    container.innerHTML = '<div class="p-3 text-center text-muted">Nenhuma rotina encontrada.</div>';
                    return;
                }

                container.innerHTML = data.map((analyst, index) => `
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="flush-heading${index}">
                            <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapse${index}">
                                ${analyst.analyst_name} 
                                <span class="badge ${analyst.routines.filter(r => r.completed).length === analyst.routines.length ? 'bg-success' : 'bg-secondary'} ms-2">
                                    ${analyst.routines.filter(r => r.completed).length}/${analyst.routines.length}
                                </span>
                            </button>
                        </h2>
                        <div id="flush-collapse${index}" class="accordion-collapse collapse" data-bs-parent="#team-routines-list">
                            <div class="accordion-body p-0">
                                <ul class="list-group list-group-flush">
                                    ${analyst.routines.map(r => `
                                        <li class="list-group-item d-flex justify-content-between align-items-center ps-4">
                                            <span class="small">${r.title}</span>
                                            ${r.completed ? '<i class="bi bi-check-circle-fill text-success"></i>' : '<i class="bi bi-circle text-muted"></i>'}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        } catch (e) {
            console.error('Erro ao carregar overview', e);
        }
    }

    function filterTasks() {
        currentFilter = document.getElementById('statusFilter').value;
        loadTasks();
    }

    // ===================== SOLICITAÇÕES AO CS CLIENTES =====================
    let refundSearchTimeout;
    let allAnalysts = [];

    async function loadAnalystsForFilter() {
        try {
            const res = await fetch('/api/users/nrs-analysts/');
            if (res.ok) {
                const data = await res.json();
                allAnalysts = data.analysts || [];
                const select = document.getElementById('refundAnalystFilter');
                if (select) {
                    select.innerHTML = '<option value="">Todos Analistas</option>' +
                        allAnalysts.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
                }
            }
        } catch (e) {
            console.error('Erro ao carregar analistas', e);
        }
    }

    async function loadMyRefunds() {
        const statusFilter = document.getElementById('refundStatusFilter')?.value || '';
        const search = document.getElementById('refundSearch')?.value || '';
        const analystFilter = document.getElementById('refundAnalystFilter')?.value || '';
        const storeFilter = document.getElementById('refundStoreFilter')?.value || '';
        const dateStart = document.getElementById('refundDateStart')?.value || '';
        const dateEnd = document.getElementById('refundDateEnd')?.value || '';

        let url = '/api/refunds/list/?all=true&';
        if (statusFilter) url += `status=${statusFilter}&`;
        if (search) url += `search=${encodeURIComponent(search)}&`;
        if (analystFilter) url += `analyst=${analystFilter}&`;
        if (storeFilter) url += `store=${encodeURIComponent(storeFilter)}&`;
        if (dateStart) url += `date_start=${dateStart}&`;
        if (dateEnd) url += `date_end=${dateEnd}&`;

        try {
            const res = await fetch(url);
            if (res.ok) {
                const data = await res.json();
                renderMyRefunds(data.refunds);
                // Update stats
                const count = data.refunds.length;
                const countBadge = document.getElementById('refund-count-badge');
                if (countBadge) countBadge.textContent = `${count} registro${count !== 1 ? 's' : ''}`;
                const statRefunds = document.getElementById('stat-refunds');
                if (statRefunds) statRefunds.textContent = count;
            }
        } catch (e) {
            console.error('Erro ao carregar solicitações', e);
        }
    }

    function searchRefunds() {
        clearTimeout(refundSearchTimeout);
        refundSearchTimeout = setTimeout(loadMyRefunds, 300);
    }

    function clearRefundFilters() {
        document.getElementById('refundSearch').value = '';
        document.getElementById('refundAnalystFilter').value = '';
        document.getElementById('refundStoreFilter').value = '';
        document.getElementById('refundDateStart').value = '';
        document.getElementById('refundDateEnd').value = '';
        document.getElementById('refundStatusFilter').value = '';
        loadMyRefunds();
    }

    function renderMyRefunds(refunds) {
        const tbody = document.getElementById('my-refunds-list');

        if (refunds.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4">Nenhuma solicitação encontrada.</td></tr>';
            return;
        }

        tbody.innerHTML = refunds.map(r => {
            const statusBadge = getRefundStatusBadge(r.status);
            const date = new Date(r.created_at).toLocaleDateString('pt-BR');
            const viewedInfo = r.viewed_by
                ? `<span class="text-success"><i class="bi bi-eye-fill"></i> ${r.viewed_by}</span>`
                : '<span class="text-muted"><i class="bi bi-eye-slash"></i> Não visualizado</span>';

            return `
                <tr>
                    <td><strong>#${r.id}</strong></td>
                    <td><small>${r.analyst_name || '-'}</small></td>
                    <td><span class="badge bg-secondary">${r.store_code || '-'}</span></td>
                    <td>${r.customer_name}<br><small class="text-muted">${r.customer_cpf}</small></td>
                    <td><strong>R$ ${parseFloat(r.refund_value).toFixed(2)}</strong></td>
                    <td>${statusBadge}</td>
                    <td><small>${viewedInfo}</small></td>
                    <td><small>${date}</small></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="openRefundDetail(${r.id})" title="Ver Detalhes">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function getRefundStatusBadge(status) {
        const badges = {
            'aberta': '<span class="badge bg-warning text-dark"><i class="bi bi-circle-fill"></i> Aberta</span>',
            'em_analise': '<span class="badge bg-info"><i class="bi bi-search"></i> Em Análise</span>',
            'concluida': '<span class="badge bg-success"><i class="bi bi-check-lg"></i> Concluída</span>',
            'cancelada': '<span class="badge bg-danger"><i class="bi bi-x-lg"></i> Cancelada</span>'
        };
        return badges[status] || status;
    }

    async function openRefundDetail(id) {
        document.getElementById('refund-detail-id').textContent = id;

        try {
            const res = await fetch(`/api/refunds/${id}/`);
            if (res.ok) {
                const data = await res.json();
                const r = data.refund;

                let attachmentsHtml = '';
                if (r.attachments && r.attachments.length > 0) {
                    attachmentsHtml = '<h6 class="mt-4"><i class="bi bi-paperclip"></i> Anexos</h6><ul class="list-group">';
                    r.attachments.forEach(att => {
                        attachmentsHtml += `
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>${att.description || 'Anexo'} - <small class="text-muted">${att.uploaded_by}</small></span>
                                <a href="${att.file_url}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-download"></i> Baixar</a>
                            </li>
                        `;
                    });
                    attachmentsHtml += '</ul>';
                }

                const viewedInfo = r.viewed_by
                    ? `<div class="alert alert-success py-2 mb-3"><i class="bi bi-eye-fill"></i> Visualizado por <strong>${r.viewed_by}</strong> em ${new Date(r.viewed_at).toLocaleString('pt-BR')}</div>`
                    : '<div class="alert alert-warning py-2 mb-3"><i class="bi bi-eye-slash"></i> Ainda não foi visualizado pelo CS Clientes</div>';

                const cancellationAlert = r.cancellation_requested
                    ? `<div class="alert alert-danger py-2 mb-3 border-2">
                        <i class="bi bi-exclamation-triangle-fill"></i> 
                        <strong>Cancelamento Solicitado:</strong> ${r.cancellation_reason || 'Sem motivo'}
                        <br><small>Por ${r.cancellation_requested_by} em ${new Date(r.cancellation_requested_at).toLocaleString('pt-BR')}</small>
                       </div>`
                    : '';

                document.getElementById('refund-detail-content').innerHTML = `
                    ${viewedInfo}
                    ${cancellationAlert}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-item"><p class="info-label"><i class="bi bi-person"></i> Analista</p><p class="info-value">${r.analyst_name}</p></div>
                            <div class="info-item"><p class="info-label"><i class="bi bi-shop"></i> Loja</p><p class="info-value">${r.store_code}</p></div>
                            <div class="info-item"><p class="info-label"><i class="bi bi-person-badge"></i> Cliente</p><p class="info-value">${r.customer_name}</p></div>
                            <div class="info-item"><p class="info-label"><i class="bi bi-card-text"></i> CPF</p><p class="info-value">${r.customer_cpf}</p></div>
                            <div class="info-item"><p class="info-label"><i class="bi bi-envelope"></i> E-mail</p><p class="info-value">${r.customer_email}</p></div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-item"><p class="info-label"><i class="bi bi-calendar"></i> Data Ocorrido</p><p class="info-value">${new Date(r.incident_date).toLocaleDateString('pt-BR')}</p></div>
                            <div class="info-item"><p class="info-label"><i class="bi bi-cash"></i> Valor</p><p class="info-value"><strong>R$ ${parseFloat(r.refund_value).toFixed(2)}</strong></p></div>
                            <div class="info-item"><p class="info-label"><i class="bi bi-credit-card"></i> Tipo</p><p class="info-value">${r.refund_type}</p></div>
                            <div class="info-item"><p class="info-label"><i class="bi bi-flag"></i> Status</p><p class="info-value">${getRefundStatusBadge(r.status)}</p></div>
                            ${r.pix_key ? `<div class="info-item"><p class="info-label"><i class="bi bi-key"></i> Chave PIX</p><p class="info-value">${r.pix_key}</p></div>` : ''}
                        </div>
                    </div>
                    <div class="info-item mt-3">
                        <p class="info-label"><i class="bi bi-question-circle"></i> Motivo</p>
                        <div class="description-box">${r.reason}</div>
                    </div>
                    <div class="info-item mt-3">
                        <p class="info-label"><i class="bi bi-file-text"></i> Resumo</p>
                        <div class="description-box">${r.summary}</div>
                    </div>
                    ${attachmentsHtml}
                `;

                // Adicionar botões de edição e cancelamento
                let footerButtons = '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>';

                // Botão de edição para quem tem permissão (NRS Suporte, gestor, admin)
                if (r.can_edit && r.status === 'aberta') {
                    footerButtons = `<button class="btn btn-primary me-2" onclick="openEditRefundModal(${r.id})"><i class="bi bi-pencil"></i> Editar</button>` + footerButtons;
                }

                // Botão de cancelamento para gestores
                if (isManager && r.status === 'aberta' && !r.cancellation_requested) {
                    footerButtons += `<button type="button" class="btn btn-warning ms-2" onclick="requestCancellation(${r.id})"><i class="bi bi-x-circle"></i> Solicitar Cancelamento</button>`;
                }

                // Botão de exclusão para gestores e administradores
                if (isManager) {
                    footerButtons += `<button type="button" class="btn btn-danger ms-2" onclick="confirmDeleteRefund(${r.id})"><i class="bi bi-trash"></i> Excluir</button>`;
                }
                document.getElementById('refund-detail-footer').innerHTML = footerButtons;

                new bootstrap.Modal(document.getElementById('refundDetailModal')).show();
            }
        } catch (e) {
            console.error('Erro ao carregar detalhes', e);
            if (window.showToast) window.showToast('Erro ao carregar detalhes', 'error');
        }
    }

    async function requestCancellation(id) {
        // Close Bootstrap modal first to prevent z-index conflicts
        const bsModal = bootstrap.Modal.getInstance(document.getElementById('refundDetailModal'));
        if (bsModal) {
            bsModal.hide();
        }

        // Wait for modal to close
        await new Promise(resolve => setTimeout(resolve, 300));

        const { value: reason } = await Swal.fire({
            title: 'Solicitar Cancelamento',
            text: 'Qual o motivo do cancelamento?',
            input: 'textarea',
            inputPlaceholder: 'Digite o motivo aqui...',
            showCancelButton: true,
            confirmButtonText: 'Solicitar',
            cancelButtonText: 'Voltar',
            confirmButtonColor: '#d33',
            backdrop: true,
            allowOutsideClick: false,
            didOpen: () => {
                // Focus the textarea after SweetAlert opens
                const textarea = Swal.getInput();
                if (textarea) {
                    textarea.focus();
                }
            },
            inputValidator: (value) => {
                if (!value) {
                    return 'Você precisa informar um motivo!';
                }
            }
        });

        if (!reason) return;

        const result = await Swal.fire({
            title: 'Confirmar Solicitação',
            text: `Deseja realmente solicitar o cancelamento da solicitação #${id}?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Sim, solicitar!',
            cancelButtonText: 'Não'
        });

        if (!result.isConfirmed) return;

        try {
            const res = await fetch(`/api/refunds/${id}/cancel/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({ reason: reason })
            });

            if (res.ok) {
                const data = await res.json();
                Swal.fire('Solicitado!', data.message, 'success');
                bootstrap.Modal.getInstance(document.getElementById('refundDetailModal')).hide();
                loadMyRefunds();
            } else {
                const err = await res.json();
                Swal.fire('Erro!', err.error || 'Erro ao solicitar cancelamento', 'error');
            }
        } catch (e) {
            console.error('Erro ao solicitar cancelamento', e);
            Swal.fire('Erro!', 'Erro de conexão', 'error');
        }
    }

    async function openEditRefundModal(id) {
        // Close detail modal first
        const detailModal = bootstrap.Modal.getInstance(document.getElementById('refundDetailModal'));
        if (detailModal) detailModal.hide();

        try {
            const res = await fetch(`/api/refunds/${id}/`);
            if (res.ok) {
                const data = await res.json();
                const r = data.refund;

                // Populate form fields
                document.getElementById('edit-refund-id').textContent = id;
                document.getElementById('edit-refund-id-input').value = id;
                document.getElementById('edit-store_code').value = r.store_code;
                document.getElementById('edit-customer_name').value = r.customer_name;
                document.getElementById('edit-customer_cpf').value = r.customer_cpf;
                document.getElementById('edit-customer_email').value = r.customer_email;
                document.getElementById('edit-customer_phone').value = r.customer_phone || '';
                document.getElementById('edit-incident_date').value = r.incident_date;
                document.getElementById('edit-refund_value').value = parseFloat(r.refund_value).toFixed(2).replace('.', ',');
                document.getElementById('edit-refund_type').value = r.refund_type;
                document.getElementById('edit-pix_key').value = r.pix_key || '';
                document.getElementById('edit-reason').value = r.reason;
                document.getElementById('edit-summary').value = r.summary;

                new bootstrap.Modal(document.getElementById('editRefundModal')).show();
            } else {
                if (window.showToast) window.showToast('Erro ao carregar dados', 'error');
            }
        } catch (e) {
            console.error(e);
            if (window.showToast) window.showToast('Erro de conexão', 'error');
        }
    }

    async function saveEditRefund() {
        const form = document.getElementById('editRefundForm');
        const id = document.getElementById('edit-refund-id-input').value;

        const formData = new FormData(form);

        try {
            const res = await fetch(`/api/refunds/${id}/edit/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken()
                },
                body: formData
            });

            if (res.ok) {
                const data = await res.json();
                bootstrap.Modal.getInstance(document.getElementById('editRefundModal')).hide();
                if (window.showToast) window.showToast(data.message || 'Alterações salvas!', 'success');
                loadMyRefunds();
            } else {
                const err = await res.json();
                if (window.showToast) window.showToast(err.error || 'Erro ao salvar', 'error');
            }
        } catch (e) {
            console.error(e);
            if (window.showToast) window.showToast('Erro de conexão', 'error');
        }
    }

    async function confirmDeleteRefund(id) {
        // Fechar modal de detalhes primeiro
        const detailModal = bootstrap.Modal.getInstance(document.getElementById('refundDetailModal'));
        if (detailModal) {
            detailModal.hide();
        }

        // Aguardar modal fechar
        await new Promise(r => setTimeout(r, 300));

        // Pedir confirmação com senha usando SweetAlert2
        const { value: password, isConfirmed } = await Swal.fire({
            title: 'Confirmar Exclusão',
            html: `
                <p class="text-danger"><strong>⚠️ Atenção:</strong> Esta ação é irreversível!</p>
                <p>A solicitação #${id} será excluída permanentemente.</p>
                <p>Digite sua senha para confirmar:</p>
            `,
            input: 'password',
            inputPlaceholder: 'Digite sua senha',
            inputAttributes: {
                autocapitalize: 'off',
                autocorrect: 'off'
            },
            showCancelButton: true,
            confirmButtonText: '<i class="bi bi-trash"></i> Excluir',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            focusCancel: true,
            inputValidator: (value) => {
                if (!value) {
                    return 'Você precisa digitar sua senha!';
                }
            }
        });

        if (isConfirmed && password) {
            try {
                const res = await fetch(`/api/refunds/${id}/delete/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({ password: password })
                });

                const data = await res.json();

                if (res.ok && data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Excluído!',
                        text: data.message,
                        timer: 2000,
                        showConfirmButton: false
                    });
                    loadMyRefunds();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Erro',
                        text: data.error || 'Não foi possível excluir'
                    });
                }
            } catch (e) {
                console.error(e);
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: 'Erro de conexão'
                });
            }
        }
    }

</script>
{% endblock %}