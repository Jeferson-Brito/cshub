{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<style>
    /* CRITICAL FIX: Override global body min-height: 100vh que causa scroll excessivo */
    body {
        min-height: 0 !important;
        height: auto !important;
    }

    /* Fix white space below pending issues table */
    #irregular-issues {
        min-height: 0 !important;
        height: auto !important;
    }

    #irregular-issues .card {
        min-height: 0 !important;
        height: auto !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- CSRF Token for JavaScript -->
<form style="display:none;">{% csrf_token %}</form>

<div class="container-fluid">
    <!-- Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="page-title"><i class="bi bi-shield-check"></i> {{ title }}</h1>
                <p class="page-subtitle">Auditoria e conformidade das lojas f√≠sicas</p>
            </div>
            <div class="d-flex gap-2 align-items-center">
                {% if user.role in 'gestor,administrador' %}
                <div class="dropdown">
                    <button class="btn btn-primary d-flex align-items-center gap-2 px-3 fw-bold dropdown-toggle"
                        type="button" id="createStoreDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-plus-circle"></i> Criar
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow border-0 p-2"
                        aria-labelledby="createStoreDropdown">
                        <li><a class="dropdown-item rounded-2 py-2" href="{% url 'store_create' %}"><i
                                    class="bi bi-shop me-2 text-primary"></i> Criar Loja</a></li>
                        <li><a class="dropdown-item rounded-2 py-2" href="{% url 'import_stores_xlsx' %}"><i
                                    class="bi bi-file-earmark-excel me-2 text-success"></i> Importar XLSX</a></li>
                        {% if user.is_administrador %}
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li><a class="dropdown-item rounded-2 py-2 text-danger" href="{% url 'store_bulk_delete' %}"><i
                                    class="bi bi-trash3 me-2"></i> Excluir Todas</a></li>
                        {% endif %}
                    </ul>
                </div>
                {% endif %}
                <form method="GET" class="d-flex align-items-center">
                    {% if filter_type %}<input type="hidden" name="filter" value="{{ filter_type }}">{% endif %}
                    <input type="hidden" name="tab" value="{{ tab }}">

                    <!-- Scope Toggle (Analysts Only) -->
                    {% if user.role == 'analista' %}
                    <div class="btn-group me-2" role="group" aria-label="Escopo">
                        <a href="?scope=my_stores{% if filter_type %}&filter={{ filter_type }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}"
                            class="btn btn-outline-primary {% if scope == 'my_stores' %}active{% endif %}"
                            title="Minhas Lojas">
                            <i class="bi bi-person-check"></i> Minhas
                        </a>
                        <a href="?scope=all{% if filter_type %}&filter={{ filter_type }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}"
                            class="btn btn-outline-primary {% if scope != 'my_stores' %}active{% endif %}"
                            title="Todas as Lojas">
                            <i class="bi bi-grid"></i> Todas
                        </a>
                    </div>
                    {% endif %}

                    <div class="input-group" style="width: 320px;">
                        <input type="text" class="form-control" name="q" id="storeSearch"
                            placeholder="Buscar loja (C√≥d, Cidade...)" value="{{ search_query|default:'' }}"
                            style="border-radius: 8px 0 0 8px; border: 1px solid #e2e8f0;">
                        <input type="hidden" name="scope" value="{{ scope|default:'all' }}">
                        <button type="submit" class="btn btn-primary" style="border-radius: 0 8px 8px 0;">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                    {% if search_query %}
                    <a href="?tab={{ tab }}{% if filter_type %}&filter={{ filter_type }}{% endif %}"
                        class="btn btn-outline-secondary ms-2 border-0" title="Limpar busca">
                        <i class="bi bi-x-lg"></i>
                    </a>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>

    <!-- Tab Navigation Menu -->
    <!-- Stat Cards Navigation -->
    <div class="nav-pills-stats mb-4">
        <!-- Gest√£o/Metas Tab -->
        <a class="nav-link-stat stat-cyan {% if tab == 'management' %}active{% endif %}"
            href="?tab=management{% if scope %}&scope={{ scope }}{% endif %}">
            <div class="d-flex justify-content-between w-100">
                <div class="stat-icon">
                    {% if user.is_gestor or user.is_administrador %}
                    <i class="bi bi-people"></i>
                    {% else %}
                    <i class="bi bi-trophy"></i>
                    {% endif %}
                </div>
            </div>
            <div>
                <div class="stat-title">
                    {% if user.is_gestor or user.is_administrador %}
                    Gest√£o de Analistas
                    {% else %}
                    Minhas Metas
                    {% endif %}
                </div>
                <div class="stat-value" style="font-size: 1rem; opacity: 0.9;">
                    <i class="bi bi-arrow-right-circle"></i> Acessar
                </div>
            </div>
        </a>

        <!-- Active Stores Tab -->
        <a class="nav-link-stat stat-blue {% if not tab or tab == 'all' %}active{% endif %}"
            href="?tab=all{% if scope %}&scope={{ scope }}{% endif %}">
            <div class="d-flex justify-content-between w-100">
                <div class="stat-icon"><i class="bi bi-shop"></i></div>
            </div>
            <div>
                <div class="stat-title">Lojas Ativas</div>
                <div class="stat-value">{{ total_stores }}</div>
            </div>
        </a>

        <!-- Irregular Tab -->
        <a class="nav-link-stat stat-orange {% if tab == 'irregular' %}active{% endif %}"
            href="?tab=irregular{% if scope %}&scope={{ scope }}{% endif %}">
            <div class="d-flex justify-content-between w-100">
                <div class="stat-icon"><i class="bi bi-clock-history"></i></div>
            </div>
            <div>
                <div class="stat-title">Pendentes</div>
                <div class="stat-value">{{ irregular_count }}</div>
            </div>
        </a>

        <!-- Verified Tab -->
        <a class="nav-link-stat stat-green {% if tab == 'verified' %}active{% endif %}"
            href="?tab=verified{% if scope %}&scope={{ scope }}{% endif %}">
            <div class="d-flex justify-content-between w-100">
                <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
            </div>
            <div>
                <div class="stat-title">Resolvidas</div>
                <div class="stat-value">{{ ok_count }}</div>
            </div>
        </a>

        <!-- Suspended Tab -->
        <a class="nav-link-stat stat-gray {% if tab == 'suspended' %}active{% endif %}"
            href="?tab=suspended{% if scope %}&scope={{ scope }}{% endif %}">
            <div class="d-flex justify-content-between w-100">
                <div class="stat-icon"><i class="bi bi-pause-circle"></i></div>
            </div>
            <div>
                <div class="stat-title">Lojas Suspensas</div>
                <div class="stat-value">{{ suspended_count|default:0 }}</div>
            </div>
        </a>
    </div>

    <!-- Tab Content -->
    <div class="tab-content" id="verificationTabsContent">

        <!-- Tab: Management -->
        <div class="tab-pane fade {% if tab == 'management' %}show active{% endif %}" id="management" role="tabpanel">
            <!-- Dashboard Cards (Moved inside Management for better focus, or keep global?) -->
            <!-- Keeping Global Counters visible is good, but user requested cleanup. Let's keep counters global but Analyst/Assignments here. -->


            <!-- Se√ß√£o de Gest√£o de Analistas -->
            {% if user.is_gestor or user.is_administrador or user.is_analista %}
            <div class="card mb-4 border-0 shadow-sm">
                <div class="card-header bg-white py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold text-dark">
                            {% if user.is_gestor or user.is_administrador %}
                            <i class="bi bi-people me-2 text-primary"></i> Gest√£o de Analistas
                            {% else %}
                            <i class="bi bi-trophy me-2 text-warning"></i> Minhas Metas Semanais
                            {% endif %}
                        </h5>
                        {% if user.is_gestor or user.is_administrador %}
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal"
                            data-bs-target="#assignStoreModal">
                            <i class="bi bi-plus-circle me-1"></i> Atribuir Loja
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <!-- Dashboard do Analista -->
                    {% if user.is_analista %}
                    <div id="analystDashboard">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="text-center p-3 bg-light rounded h-100">
                                    <i class="bi bi-shop text-primary" style="font-size: 2rem;"></i>
                                    <h3 class="mt-2 mb-0" id="totalStores">-</h3>
                                    <small class="text-muted">Lojas Atribu√≠das</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-3 bg-light rounded h-100">
                                    <i class="bi bi-calendar-check text-info" style="font-size: 2rem;"></i>
                                    <h3 class="mt-2 mb-0" id="dailyTarget">-</h3>
                                    <small class="text-muted">Meta Di√°ria</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-3 bg-light rounded h-100">
                                    <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                                    <h3 class="mt-2 mb-0" id="auditedCount">-</h3>
                                    <small class="text-muted">Auditadas esta Semana</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-3 bg-light rounded h-100">
                                    <i class="bi bi-trophy text-warning" style="font-size: 2rem;"></i>
                                    <h3 class="mt-2 mb-0" id="progressPercentage">-</h3>
                                    <small class="text-muted">Progresso da Meta</small>
                                </div>
                            </div>
                        </div>

                        <!-- Daily Quota Section -->
                        <div class="card border-primary mb-3" id="dailyQuotaCard">
                            <div class="card-header bg-primary bg-opacity-10 border-primary">
                                <div class="d-flex just ify-content-between align-items-center">
                                    <h6 class="mb-0 fw-bold">
                                        <i class="bi bi-calendar-check me-2"></i>
                                        Meta de Hoje
                                    </h6>
                                    <span class="badge bg-primary" id="dailyQuotaBadge">-</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Lojas auditadas hoje:</span>
                                    <span class="fw-bold" id="dailyQuotaText">-/-</span>
                                </div>
                                <div class="progress" style="height: 20px;">
                                    <div id="dailyQuotaProgress"
                                        class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                                        role="progressbar" style="width: 0%">
                                        <span id="dailyQuotaPercentage">0%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Weekly Schedule Container -->
                            <div id="weeklyScheduleContainer" class="card-footer bg-white border-top">
                                <h6 class="small fw-bold text-muted mb-3"><i class="bi bi-calendar-week me-1"></i> Sua
                                    Escala Nesta Semana</h6>
                                <div class="d-flex justify-content-between align-items-center" id="weeklyScheduleList">
                                    <div class="text-center w-100">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Alert quando quota atingida -->
                        <div id="dailyQuotaBlocked" class="alert alert-warning border-warning d-none mb-3">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-lock-fill fs-4 me-3"></i>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 fw-bold">üéâ Meta Di√°ria Conclu√≠da!</h6>
                                    <p class="mb-1">Voc√™ j√° auditou todas as lojas permitidas hoje.</p>
                                    <small class="text-muted">
                                        Pr√≥ximo reset em: <strong id="resetCountdown">-</strong>
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Progresso Semanal</span>
                                <span class="fw-bold" id="progressText">-/-</span>
                            </div>
                            <div class="progress" style="height: 25px;">
                                <div id="progressBar" class="progress-bar bg-success" role="progressbar"
                                    style="width: 0%">
                                    <span id="progressBarText">0%</span>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info bg-info bg-opacity-10 border-info border-opacity-25">
                            <i class="bi bi-info-circle me-1"></i>
                            <strong>Dias restantes:</strong> <span id="daysRemaining">-</span> dias at√© <span
                                id="periodEndDay">domingo</span>
                        </div>

                        <!-- Monthly KPI Section -->
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-gradient-primary text-white py-3">
                                <h6 class="mb-0 fw-bold">
                                    <i class="bi bi-graph-up-arrow me-2"></i>
                                    Desempenho Mensal - √öltimas 5 Semanas
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="monthlyKpiLoading" class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Carregando...</span>
                                    </div>
                                    <small class="d-block mt-2 text-muted">Carregando KPIs mensais...</small>
                                </div>

                                <div id="monthlyKpiContent" class="d-none">
                                    <!-- Success Rate Badge -->
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <small class="text-muted">Taxa de Sucesso Mensal:</small>
                                        <span class="badge bg-primary rounded-pill px-3"
                                            id="monthlySuccessRate">-</span>
                                    </div>

                                    <!-- Weekly KPI Cards -->
                                    <div id="weeklyKpiCards" class="row g-2">
                                        <!-- Populated via JavaScript -->
                                    </div>

                                    <div class="alert alert-light border mt-3 mb-0">
                                        <small class="text-muted">
                                            <i class="bi bi-info-circle me-1"></i>
                                            <strong>Meta:</strong> Verificar todas as lojas atribu√≠das cada semana.
                                            Semanas completas s√£o marcadas com <i
                                                class="bi bi-check-circle-fill text-success"></i>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h6 class="fw-bold mb-3">Minhas Lojas</h6>
                        <div id="myStoresList" class="row">
                            <div class="col-12 text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Tabela de Atribui√ß√µes (Gestor) -->
                    {% if user.role in 'gestor,administrador' %}
                    <div id="analystManagementSection">
                        <p class="text-muted mb-3">
                            <i class="bi bi-info-circle me-1"></i>
                            Vis√£o geral do desempenho e atribui√ß√µes dos analistas.
                        </p>

                        <!-- Management Action Buttons -->
                        <div class="mb-3 d-flex gap-2 justify-content-end">
                            <button class="btn btn-outline-primary" onclick="openAutoDistributionModal()"
                                title="Distribuir lojas automaticamente entre analistas">
                                <i class="bi bi-shuffle me-2"></i>Distribuir Automaticamente
                            </button>
                            <button class="btn btn-outline-danger" onclick="confirmUnassignAllStores()"
                                title="Desatribuir todas as lojas de todos os analistas">
                                <i class="bi bi-x-circle me-2"></i>Desatribuir Tudo
                            </button>
                        </div>

                        <!-- Analyst Cards Grid -->
                        <div id="analystsGrid" class="row g-3" style="max-height: 600px; overflow-y: auto;">
                            <div class="col-12 text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                                <p class="text-muted mt-2">Carregando dados dos analistas...</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Manager KPI Dashboard -->
            {% if user.is_gestor or user.is_administrador %}
            <div class="card mb-4 border-0 shadow-sm">
                <div class="card-header bg-white py-3 border-bottom">
                    <h6 class="mb-0 fw-bold text-dark">
                        <i class="bi bi-graph-up-arrow me-2 text-primary"></i> Desempenho Mensal da Equipe
                    </h6>
                </div>
                <div class="card-body bg-light bg-opacity-50">
                    <div id="managerKpiLoading" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p class="mt-2 text-muted small">Carregando indicadores...</p>
                    </div>

                    <div id="managerKpiContent" class="d-none">
                        <div id="managerKpiList" class="row g-3">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Irregular Tab Content (Pending Issues) -->
        </div> <!-- End Management Tab -->

        <div class="tab-pane fade {% if tab == 'irregular' %}show active{% endif %}" id="irregular-issues"
            role="tabpanel">
            {% if pending_issues %}
            <!-- Pending Issues for Managers -->
            <div class="card mb-4 border-0 shadow-sm" style="border-left: 5px solid #f59e0b !important;">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold text-dark"><i class="bi bi-megaphone me-2 text-warning"></i> Pend√™ncias
                        Solicitadas
                    </h5>
                    <span class="badge bg-warning text-dark px-3 rounded-pill">{{ pending_issues_count }}
                        Pend√™ncia(s)</span>
                </div>
                <!-- ... existing table content ... -->
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="bg-light">
                                <tr>
                                    <th class="ps-4">Loja</th>
                                    <th>√çtem Irregular</th>
                                    <th>Analista</th>
                                    <th>Status</th>
                                    <th>Data/Hora</th>
                                    <th class="text-end pe-4">A√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for issue in pending_issues %}
                                <tr id="issue-row-{{ issue.id }}">
                                    <!-- ... existing row content ... -->
                                    <td class="ps-4">
                                        <div class="fw-bold text-primary">{{ issue.store.code }}</div>
                                        <small class="text-muted">{{ issue.store.city }}</small>
                                    </td>
                                    <td>
                                        {% for item in issue.items.all %}
                                        <span
                                            class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25 px-2 py-2 me-1 mb-1">
                                            {{ item.get_item_name_display }}
                                        </span>
                                        {% endfor %}
                                    </td>
                                    <td>
                                        {% with first_item=issue.items.first %}
                                        {% if first_item.audit.analyst.get_full_name %}
                                        {{ first_item.audit.analyst.get_full_name }}
                                        {% else %}
                                        {{ first_item.audit.analyst.username }}
                                        {% endif %}
                                        {% endwith %}
                                    </td>
                                    <td>
                                        <div id="status-{{ issue.id }}">
                                            {% if issue.status == 'notificado_whatsapp' %}
                                            <div class="d-flex align-items-center gap-2">
                                                <span class="badge bg-info text-white">
                                                    <i class="bi bi-whatsapp me-1"></i> WhatsApp
                                                </span>
                                                <div class="timer-container" data-issue-id="{{ issue.id }}">
                                                    <small class="text-muted timer-text">Carregando...</small>
                                                </div>
                                            </div>
                                            {% elif issue.status == 'notificado_ticket' %}
                                            <span class="badge bg-primary">
                                                <i class="bi bi-ticket me-1"></i> Ticket {{ issue.ticket_id }}
                                            </span>
                                            {% elif issue.status == 'resolvida' %}
                                            <span class="badge bg-success">
                                                <i class="bi bi-check-circle me-1"></i> Resolvida
                                            </span>
                                            {% else %}
                                            <span class="badge bg-secondary">Aguardando</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>{{ issue.created_at|date:"d/m/Y H:i" }}</td>
                                    <td class="text-end pe-4">
                                        <div class="d-flex justify-content-end gap-2 align-items-center">
                                            {% if issue.status == 'aberta' %}
                                            <button
                                                class="btn btn-sm btn-primary fw-bold px-3 d-flex align-items-center"
                                                onclick="openNotifyModal({{ issue.id }})" style="height: 32px;">
                                                <i class="bi bi-send me-1"></i> Notificar
                                            </button>
                                            {% endif %}

                                            {% if issue.status != 'resolvida' %}
                                            <button
                                                class="btn btn-sm btn-warning fw-bold px-3 d-flex align-items-center"
                                                data-bs-toggle="modal" data-bs-target="#resolveModal{{ issue.id }}"
                                                style="height: 32px;">
                                                <i class="bi bi-tools me-1"></i> Resolver
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagina√ß√£o de Pend√™ncias - CORRIGIDA -->
                    {% if pending_issues_page and pending_issues_page.has_other_pages %}
                    <div class="card-footer bg-white py-3 border-top">
                        <nav aria-label="Navega√ß√£o de pend√™ncias">
                            <ul class="pagination justify-content-center mb-0">
                                {% if pending_issues_page.has_previous %}
                                <li class="page-item">
                                    <a class="page-link border-0 rounded-circle"
                                        href="?pending_page={{ pending_issues_page.previous_page_number }}&tab={{ tab }}{% if scope %}&scope={{ scope }}{% endif %}">&laquo;</a>
                                </li>
                                {% else %}
                                <li class="page-item disabled"><span class="page-link border-0">&laquo;</span></li>
                                {% endif %}

                                {% for page_num in pending_issues_page.paginator.page_range %}
                                {% if pending_issues_page.number == page_num %}
                                <li class="page-item active">
                                    <span class="page-link border-0 rounded-circle fw-bold mx-1"
                                        style="background-color: #f59e0b; border-color: #f59e0b;">{{ page_num }}</span>
                                </li>
                                {% elif page_num > pending_issues_page.number|add:'-3' and page_num <
                                    pending_issues_page.number|add:'3' %} <li class="page-item">
                                    <a class="page-link border-0 rounded-circle mx-1 text-dark"
                                        href="?pending_page={{ page_num }}&tab={{ tab }}{% if scope %}&scope={{ scope }}{% endif %}">{{
                                        page_num }}</a>
                                    </li>
                                    {% endif %}
                                    {% endfor %}

                                    {% if pending_issues_page.has_next %}
                                    <li class="page-item">
                                        <a class="page-link border-0 rounded-circle"
                                            href="?pending_page={{ pending_issues_page.next_page_number }}&tab={{ tab }}{% if scope %}&scope={{ scope }}{% endif %}">&raquo;</a>
                                    </li>
                                    {% else %}
                                    <li class="page-item disabled"><span class="page-link border-0">&raquo;</span>
                                    </li>
                                    {% endif %}
                            </ul>
                            <div class="text-center text-muted small mt-2">
                                P√°gina {{ pending_issues_page.number }} de {{ pending_issues_page.paginator.num_pages }}
                            </div>
                        </nav>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

    </div> <!-- End Irregular Tab -->


    <!-- Tabs for Verified/Suspended/All (Lists) -->
    <div class="tab-pane fade {% if tab == 'verified' or tab == 'suspended' or tab == 'all' %}show active{% endif %}"
        id="lists" role="tabpanel">

        <!-- Stores List -->
        <div class="card shadow-sm border-0 rounded-3">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="storesTable">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4 py-3">C√≥d. Loja</th>
                                <th>Status Operacional</th>

                                <th class="text-center">Auditorias (M√™s)</th>

                                <th>√öltima Auditoria</th>

                                <th>Situa√ß√£o</th>
                                <th>Motivo da Suspens√£o</th>
                                <th class="text-end pe-4">A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for store in stores %}
                            <tr {% if not store.active %}class="opacity-75 bg-light" {% endif %}>
                                <td class="ps-4 py-3">
                                    <span class="fw-bold text-dark">{{ store.code }}</span>
                                </td>
                                <td>
                                    {% if store.active %}
                                    <span
                                        class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 px-2 py-1">
                                        <i class="bi bi-play-circle me-1"></i> Ativa
                                    </span>
                                    {% else %}
                                    <span
                                        class="badge bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25 px-2 py-1">
                                        <i class="bi bi-pause-circle me-1"></i> Suspensa
                                    </span>
                                    {% endif %}
                                </td>

                                <td class="text-center"><span class="badge bg-secondary rounded-pill px-3">{{
                                        store.audits_this_month_count|default:"0" }}</span></td>

                                <!-- Columns Removed -->
                                <!-- Otimiza√ß√£o: Uso de latest_audit anexado na view para evitar N+1 queries -->
                                {% with last_audit=store.latest_audit %}

                                <td>
                                    {% if last_audit %}
                                    <span class="text-muted small">{{ last_audit.created_at|date:"d/m/Y H:i" }}</span>
                                    {% else %}
                                    <span class="text-muted italic small">Nenhuma verifica√ß√£o</span>
                                    {% endif %}
                                </td>
                                {% endwith %}
                                <!-- Recent History Removed -->
                                <td>
                                    {% if store.ui_status == 'suspended' %}
                                    <span class="text-muted small">Sem auditoria (Suspensa)</span>
                                    {% elif store.ui_status == 'irregular' %}
                                    <span
                                        class="badge rounded-pill bg-warning text-dark px-3 shadow-sm border border-warning border-opacity-50">
                                        <i class="bi bi-exclamation-circle me-1"></i> Irregular
                                    </span>
                                    {% elif store.ui_status == 'compliant' %}
                                    <span class="badge rounded-pill bg-success px-3 shadow-sm">
                                        <i class="bi bi-check2-all me-1"></i> Conforme
                                    </span>
                                    {% else %}
                                    <span class="badge rounded-pill bg-secondary bg-opacity-10 text-secondary px-3">
                                        Pendente
                                    </span>
                                    {% endif %}

                                    {% if store.needs_reverification %}
                                    <div class="mt-1">
                                        <span
                                            class="badge rounded-pill bg-info bg-opacity-10 text-info border border-info border-opacity-25 px-2 py-1"
                                            title="Precisa ser reverificada">
                                            <i class="bi bi-arrow-repeat me-1"></i> Reverifica√ß√£o Necess√°ria
                                        </span>
                                    </div>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if not store.active and store.suspension_reason %}
                                    <span
                                        class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25 px-2 py-1">
                                        <i class="bi bi-exclamation-triangle me-1"></i>
                                        {{ store.get_suspension_reason_display }}
                                    </span>
                                    {% elif not store.active %}
                                    <span class="text-muted small">-</span>
                                    {% else %}
                                    <span class="text-muted small">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-end pe-4">
                                    {% if store.active %}
                                    <a href="{% url 'store_audit_create' store.id %}"
                                        class="btn btn-primary btn-sm rounded-3 px-3 fw-500">
                                        <i class="bi bi-shield-plus me-1"></i> Auditar
                                    </a>
                                    {% else %}
                                    <button class="btn btn-outline-secondary btn-sm rounded-3 px-3 fw-500" disabled>
                                        <i class="bi bi-lock me-1"></i> Suspensa
                                    </button>
                                    {% endif %}

                                    {% if user.role in 'gestor,administrador' %}
                                    <a href="{% url 'store_edit' store.id %}"
                                        class="btn btn-sm btn-outline-secondary ms-1" title="Editar Loja">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <a href="{% url 'store_delete' store.id %}"
                                        class="btn btn-sm btn-outline-danger ms-1" title="Excluir Loja">
                                        <i class="bi bi-trash"></i>
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                {% if stores.has_other_pages %}
                <div class="card-footer bg-white py-3">
                    <nav aria-label="Navega√ß√£o de p√°ginas">
                        <ul class="pagination justify-content-center mb-0">
                            {% if stores.has_previous %}
                            <li class="page-item"><a class="page-link border-0"
                                    href="?page={{ stores.previous_page_number }}&tab={{ tab }}{% if filter_type %}&filter={{ filter_type }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}{% if scope %}&scope={{ scope }}{% endif %}">&laquo;</a>
                            </li>
                            {% else %}
                            <li class="page-item disabled"><span class="page-link border-0">&laquo;</span></li>
                            {% endif %}
                            {% for page_num in stores.paginator.page_range %}
                            {% if stores.number == page_num %}
                            <li class="page-item active">
                                <span class="page-link border-0 rounded-circle fw-bold mx-1">{{ page_num }}</span>
                            </li>
                            {% elif page_num > stores.number|add:'-3' and page_num < stores.number|add:'3' %} <li
                                class="page-item">
                                <a class="page-link border-0 rounded-circle mx-1 text-dark"
                                    href="?page={{ page_num }}&tab={{ tab }}{% if filter_type %}&filter={{ filter_type }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}{% if scope %}&scope={{ scope }}{% endif %}">
                                    {{ page_num }}
                                </a>
                                </li>
                                {% endif %}
                                {% endfor %}
                                {% if stores.has_next %}
                                <li class="page-item"><a class="page-link border-0"
                                        href="?page={{ stores.next_page_number }}&tab={{ tab }}{% if filter_type %}&filter={{ filter_type }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}{% if scope %}&scope={{ scope }}{% endif %}">&raquo;</a>
                                </li>
                                {% else %}
                                <li class="page-item disabled"><span class="page-link border-0">&raquo;</span></li>
                                {% endif %}
                        </ul>
                        <div class="text-center text-muted small mt-2">
                            P√°gina {{ stores.number }} de {{ stores.paginator.num_pages }}
                        </div>
                    </nav>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Toast Container (Bottom Right) -->
    <div id="toastContainer" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999; min-width: 300px;"></div>

    <!-- Confirmation Modal (Reusable) -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-bottom-0">
                    <h5 class="modal-title fw-bold" id="confirmModalLabel">Confirmar A√ß√£o</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="confirmModalBody">
                    Deseja continuar?
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="confirmModalAction">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Auto Distribution Modal -->
    <div class="modal fade" id="autoDistributionModal" tabindex="-1" aria-labelledby="autoDistributionModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-bottom-0 bg-primary text-white">
                    <h5 class="modal-title fw-bold" id="autoDistributionModalLabel">
                        <i class="bi bi-shuffle me-2"></i>Distribui√ß√£o Autom√°tica de Lojas
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info border-0">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Como funciona:</strong> Selecione os analistas e as lojas dispon√≠veis ser√£o distribu√≠das
                        automaticamente e aleatoriamente. Sobras s√£o distribu√≠das igualmente entre os primeiros
                        analistas.
                    </div>

                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="fw-bold mb-0">Selecione os Analistas:</h6>
                        <button type="button" class="btn btn-sm btn-outline-primary"
                            onclick="toggleSelectAllAnalysts()">
                            <i class="bi bi-check-square me-1"></i>Selecionar Todos
                        </button>
                    </div>
                    <div id="analystCheckboxList" class="mb-4" style="max-height: 300px; overflow-y: auto;">
                        <!-- Populated via JS -->
                    </div>

                    <div class="card border-0 bg-light mb-4">
                        <div class="card-body">
                            <h6 class="fw-bold mb-3"><i class="bi bi-graph-up me-2"></i>Estat√≠sticas</h6>
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="h4 fw-bold text-primary mb-0" id="statsAvailableStores">-</div>
                                    <small class="text-muted">Lojas Dispon√≠veis</small>
                                </div>
                                <div class="col-4">
                                    <div class="h4 fw-bold text-success mb-0" id="statsSelectedAnalysts">0</div>
                                    <small class="text-muted">Analistas</small>
                                </div>
                                <div class="col-4">
                                    <div class="h4 fw-bold text-info mb-0" id="statsPerAnalyst">-</div>
                                    <small class="text-muted">Por Analista</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Frequ√™ncia Semanal</label>
                            <input type="number" class="form-control" id="autoWeeklyTarget" value="3" min="1" max="7">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Per√≠odo</label>
                            <div class="d-flex gap-2">
                                <input type="date" class="form-control" id="autoPeriodStart">
                                <input type="date" class="form-control" id="autoPeriodEnd">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="confirmAutoDistribution()">
                        <i class="bi bi-shuffle me-2"></i>Distribuir Automaticamente
                    </button>
                </div>
            </div>
        </div>
    </div>

    {% if play_sound %}
    <!-- Notifica√ß√£o sonora de irregularidade detectada -->
    <audio id="alertSound" autoplay>
        <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mpeg">
    </audio>
    <script>
        // Limpar o sinal da sess√£o (requer uma chamada ajax ou recarregamento consciente, mas vamos assumir que o Django remove ap√≥s um uso ou o front ignora ap√≥s tocar)
        // Como o Django session geralmente persiste at√© o pr√≥ximo middleware de request, 
        // poder√≠amos fazer um fetch r√°pido para limpar ou apenas deixar o script tocar uma vez.
        const audio = document.getElementById('alertSound');
        if (audio) {
            audio.volume = 0.5;
            audio.play().catch(e => console.log("√Åudio bloqueado pelo navegador."));
        }
    </script>
    <!-- Opcional: view helper para limpar a flag -->
    {% endif %}

    <!-- History Modal -->
    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-bottom-0 pb-0">
                    <h5 class="modal-title fw-bold text-dark">
                        Hist√≥rico Completo: <span class="text-primary" id="historyModalStoreCode"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body pt-4">
                    <div id="historyLoading" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </div>
                    <div id="historyContent" class="d-none">
                        <div class="timeline" id="historyTimeline">
                            <!-- Populated via JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Store Details Modal -->
    <div class="modal fade" id="storeDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold">
                        <i class="bi bi-shop me-2"></i>
                        <span id="storeDetailCode"></span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="storeDetailBody">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Fix excessive scroll - force all containers to fit content */
        html,
        body {
            min-height: 0 !important;
            height: auto !important;
            padding-bottom: 0 !important;
            margin-bottom: 0 !important;
            overflow-y: auto !important;
        }

        .container-fluid {
            min-height: 0 !important;
            height: auto !important;
            padding-bottom: 0 !important;
            margin-bottom: 24px !important;
        }

        .main-content {
            min-height: 0 !important;
            height: auto !important;
            padding-bottom: 0 !important;
            margin-bottom: 0 !important;
        }

        .tab-content {
            min-height: 0 !important;
            height: auto !important;
        }

        .tab-pane {
            min-height: 0 !important;
            height: auto !important;
        }

        #verificationTabsContent {
            min-height: 0 !important;
            height: auto !important;
        }

        #management,
        #irregular-issues,
        #lists {
            min-height: 0 !important;
            height: auto !important;
        }

        /* Remove qualquer espa√ßo ap√≥s os tabs */
        .tab-content::after,
        #verificationTabsContent::after {
            content: none !important;
            display: none !important;
        }

        .presence-badge {
            display: inline-block;
            transition: all 0.3s ease;
        }

        .presence-active {
            background-color: #e0f2fe;
            color: #0369a1;
            border: 1px solid #bae6fd;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .presence-dot {
            width: 6px;
            height: 6px;
            background-color: #0ea5e9;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 4px rgba(14, 165, 233, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(14, 165, 233, 0);
            }
        }

        .store-card-clickable {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .store-card-clickable:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15) !important;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Presence polling removed from list view
        });



        async function showFullHistory(storeId, storeCode) {
            const modal = new bootstrap.Modal(document.getElementById('historyModal'));
            document.getElementById('historyModalStoreCode').textContent = storeCode;
            document.getElementById('historyLoading').classList.remove('d-none');
            document.getElementById('historyContent').classList.add('d-none');
            modal.show();

            try {
                const response = await fetch(`/api/stores/${storeId}/history/`);
                const data = await response.json();

                if (data.success) {
                    const timeline = document.getElementById('historyTimeline');
                    timeline.innerHTML = '';

                    if (data.history.length === 0) {
                        timeline.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-clock-history display-4 mb-3 d-block opacity-25"></i><p>Nenhuma auditoria realizada.</p></div>';
                    } else {
                        data.history.forEach((audit, index) => {
                            const isLast = index === data.history.length - 1;
                            let itemsHtml = '';

                            if (audit.items && audit.items.length > 0) {
                                // Separar itens por status
                                const irregularItems = audit.items.filter(i => !i.is_compliant);
                                const compliantItems = audit.items.filter(i => i.is_compliant);

                                // Irregularidades
                                if (irregularItems.length > 0) {
                                    itemsHtml += `<div class="mb-3">`;
                                    irregularItems.forEach(item => {
                                        let resolutionHtml = '';
                                        if (item.resolution) {
                                            resolutionHtml = `
                                            <div class="mt-2 text-success small border-top border-success border-opacity-25 pt-2">
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-check-circle-fill me-2"></i> 
                                                    <div>
                                                        <strong>Resolvido por ${item.resolution.resolved_by}</strong>
                                                        <div class="text-muted" style="font-size: 0.8rem;">Em ${item.resolution.resolved_at}</div>
                                                    </div>
                                                </div>
                                                ${item.resolution.notes ? `<div class="mt-1 ps-4 text-muted fst-italic">"${item.resolution.notes}"</div>` : ''}
                                            </div>
                                        `;
                                        }

                                        itemsHtml += `
                                        <div class="p-3 bg-danger bg-opacity-10 rounded-3 mb-2 border border-danger border-opacity-10 position-relative">
                                            <div class="d-flex align-items-start">
                                                <i class="bi bi-x-circle-fill text-danger mt-1 me-2"></i>
                                                <div class="w-100">
                                                    <h6 class="mb-1 fw-bold text-danger">${item.name}</h6>
                                                    ${item.description ? `<p class="mb-1 text-dark small">${item.description}</p>` : ''}
                                                    ${resolutionHtml}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                    });
                                    itemsHtml += `</div>`;
                                }

                                // Conformes
                                if (compliantItems.length > 0) {
                                    const compliantNames = compliantItems.map(i => i.name).join(', ');
                                    itemsHtml += `
                                    <div class="accordion accordion-flush mb-2" id="accordionFlush${audit.id}">
                                        <div class="accordion-item bg-transparent">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed py-2 px-0 bg-transparent shadow-none text-muted small" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapse${audit.id}">
                                                    <i class="bi bi-check2-circle me-2 text-success"></i> Ver ${compliantItems.length} itens conformes
                                                </button>
                                            </h2>
                                            <div id="flush-collapse${audit.id}" class="accordion-collapse collapse" data-bs-parent="#accordionFlush${audit.id}">
                                                <div class="accordion-body p-2 text-muted small">
                                                    ${compliantNames}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                }
                            }

                            const html = `
                        <div class="timeline-premium-item d-flex position-relative pb-4">
                            <!-- Timeline Line -->
                            <div class="timeline-line-container d-flex flex-column align-items-center me-3" style="width: 40px; min-width: 40px;">
                                <div class="timeline-marker rounded-circle bg-white border border-4 border-primary shadow-sm position-relative z-2" style="width: 16px; height: 16px; margin-top: 24px;"></div>
                                ${!isLast ? '<div class="flex-grow-1 bg-primary bg-opacity-25 my-1" style="width: 2px;"></div>' : ''}
                            </div>
                            
                            <!-- Content Card -->
                            <div class="card border-0 shadow-sm flex-grow-1 bg-light">
                                <div class="card-body p-0">
                                    <div class="p-3 bg-white rounded-top border-bottom d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="fw-bold text-dark mb-0">${audit.date}</h6>
                                            <small class="text-muted">Auditado por <span class="text-primary fw-medium">${audit.analyst}</span></small>
                                        </div>
                                        ${audit.has_irregularities
                                    ? '<span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25 rounded-pill px-3"><i class="bi bi-exclamation-triangle me-1"></i> Irregular</span>'
                                    : '<span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 rounded-pill px-3"><i class="bi bi-check-circle me-1"></i> Conforme</span>'}
                                    </div>
                                    <div class="p-3">
                                        ${itemsHtml}
                                    </div>
                                </div>
                            </div>
                        </div>
                        `;
                            timeline.insertAdjacentHTML('beforeend', html);
                        });
                    }

                    document.getElementById('historyLoading').classList.add('d-none');
                    document.getElementById('historyContent').classList.remove('d-none');
                }
            } catch (e) {
                console.error(e);
                document.getElementById('historyTimeline').innerHTML = '<div class="alert alert-danger shadow-sm border-0"><i class="bi bi-exclamation-triangle-fill me-2"></i> Erro ao carregar hist√≥rico. Tente novamente.</div>';
                document.getElementById('historyLoading').classList.add('d-none');
                document.getElementById('historyContent').classList.remove('d-none');
            }
        }
    </script>

    <style>
        .presence-badge {
            display: inline-block;
            transition: all 0.3s ease;
        }

        .presence-active {
            background-color: #e0f2fe;
            color: #0369a1;
            border: 1px solid #bae6fd;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .presence-dot {
            width: 6px;
            height: 6px;
            background-color: #0ea5e9;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 4px rgba(14, 165, 233, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(14, 165, 233, 0);
            }
        }

        .page-header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e9ecef;
        }

        .page-header {
            overflow: visible !important;
            /* Fix dropdown clipping */
        }

        .stat-card.active-filter {
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1) inset, 0 8px 30px rgba(0, 0, 0, 0.1) !important;
            outline: 3px solid rgba(255, 255, 255, 0.5);
        }

        .fw-500 {
            font-weight: 500;
        }

        .table-hover tbody tr:hover {
            background-color: rgba(59, 130, 246, 0.05);
        }

        /* Ensure dropdown stays on top */
        .dropdown-menu {
            z-index: 1050 !important;
        }

        .page-link.active {
            background-color: var(--bs-primary);
            color: white;
        }
    </style>
    <script>
        // JS Filter removed as search is now server-side
    </script>
    <!-- Modals de Resolu√ß√£o (Movidos para fora da tabela para evitar bugs de hover/z-index) -->
    {% for issue in pending_issues %}
    <div class="modal fade" id="resolveModal{{ issue.id }}" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0 shadow-lg">
                <form action="{% url 'store_issue_resolve' issue.id %}" method="POST">
                    {% csrf_token %}
                    <div class="modal-header border-bottom-0 pb-0">
                        <h5 class="modal-title fw-bold text-dark">
                            Resolver Pend√™ncias: {{ issue.store.code }}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body pt-4">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="p-3 bg-light rounded-3">
                                    <p class="mb-1 small text-muted text-uppercase">Loja</p>
                                    <p class="mb-0 fw-bold">{{ issue.store.code }}</p>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="p-3 bg-light rounded-3">
                                    <p class="mb-1 small text-muted text-uppercase">Data da Auditoria</p>
                                    <p class="mb-0 fw-bold">{{ issue.created_at|date:"d/m/Y H:i" }}</p>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4" style="max-height: 500px; overflow-y: auto;">
                            <h6 class="fw-bold mb-3 text-secondary border-bottom pb-2">Itens Irregulares</h6>

                            {% for item in issue.items.all %}
                            <div class="mb-4 p-3 border rounded-3 bg-light">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="badge bg-danger bg-opacity-10 text-danger me-2">
                                        {{ item.get_item_name_display }}
                                    </span>
                                    {% if item.item_name == 'cameras' and item.cameras_recording is not None %}
                                    <span class="badge bg-secondary bg-opacity-10 text-secondary border me-1">
                                        <i class="bi bi-camera-video me-1"></i>
                                        {% if item.cameras_recording %}Gravando: Sim{% else %}Gravando: N√£o{% endif %}
                                    </span>
                                    {% if item.cameras_recording and item.cameras_recording_mode %}
                                    <span class="badge bg-secondary bg-opacity-10 text-secondary border">
                                        <i class="bi bi-hdd-network me-1"></i>
                                        {{ item.get_cameras_recording_mode_display }}
                                    </span>
                                    {% endif %}
                                    {% endif %}
                                </div>

                                <div class="p-3 border rounded-3 bg-white mb-3">
                                    <small class="text-muted d-block mb-1">Observa√ß√µes:</small>
                                    {{ item.description|default:"Sem observa√ß√µes." }}
                                </div>

                                {% if item.photo %}
                                <div class="bg-dark rounded-3 overflow-hidden p-2 position-relative group">
                                    <a href="{{ item.photo.url }}" target="_blank" class="d-block text-center"
                                        title="Clique para ampliar">
                                        <img src="{{ item.photo.url }}" class="img-fluid rounded shadow-sm"
                                            style="max-height: 300px; object-fit: contain;" alt="Evid√™ncia">
                                    </a>
                                    <div class="position-absolute bottom-0 end-0 m-3">
                                        <div class="btn-group shadow">
                                            <a href="{{ item.photo.url }}" target="_blank" class="btn btn-sm btn-light"
                                                title="Ver tamanho original">
                                                <i class="bi bi-arrows-fullscreen"></i>
                                            </a>
                                            <a href="{{ item.photo.url }}" download class="btn btn-sm btn-primary"
                                                title="Baixar imagem">
                                                <i class="bi bi-download"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Campos de resolu√ß√£o -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold"><i class="bi bi-list-check me-1"></i> Etapa da
                                    Resolu√ß√£o
                                    <span class="text-danger">*</span></label>
                                <select name="resolution_stage" class="form-select" required>
                                    <option value="" selected disabled>Selecione a etapa</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="em_contato">Em Contato com Franqueado</option>
                                    <option value="aguardando_acao">Aguardando A√ß√£o do Franqueado</option>
                                    <option value="em_validacao">Em Valida√ß√£o</option>
                                    <option value="resolvida">Resolvida</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold"><i class="bi bi-chat-dots me-1"></i> Canal de
                                    Notifica√ß√£o
                                    <span class="text-danger">*</span></label>
                                <select name="notification_channel" class="form-select" required>
                                    <option value="" selected disabled>Selecione o canal</option>
                                    <option value="whatsapp">WhatsApp</option>
                                    <option value="notificacao">Notifica√ß√£o/Email</option>
                                    <option value="ticket">Ticket</option>
                                    <option value="telefone">Telefone</option>
                                    <option value="presencial">Presencial</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold text-success"><i class="bi bi-journal-check me-1"></i>
                                A√ß√µes
                                Tomadas / Notas de Resolu√ß√£o <span class="text-danger">*</span></label>
                            <textarea name="gestor_notes" class="form-control border-success border-opacity-50" rows="4"
                                required placeholder="Como esta pend√™ncia foi resolvida com o franqueado?"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer border-top-0 pt-0 pb-4 d-flex justify-content-between align-items-center">
                        <div class="d-flex gap-2">
                            {% if user.role in 'gestor,administrador' %}
                            <a href="{% url 'store_issue_edit' issue.id %}" class="btn btn-outline-primary rounded-3">
                                <i class="bi bi-pencil me-1"></i> Editar
                            </a>
                            <a href="{% url 'store_issue_delete' issue.id %}" class="btn btn-outline-danger rounded-3">
                                <i class="bi bi-trash3 me-1"></i> Excluir
                            </a>
                            {% endif %}
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-light rounded-3 px-4"
                                data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-warning fw-bold rounded-3 px-4">
                                <i class="bi bi-check-lg me-1"></i> Confirmar Resolu√ß√£o
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- Novo Modal: Escolha de Canal de Notifica√ß√£o -->
    <div class="modal fade" id="notifyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white border-0">
                    <h5 class="modal-title"><i class="bi bi-send me-2"></i> Notificar Franqueado</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <p class="mb-3">Escolha o canal para notificar o franqueado sobre a irregularidade:</p>

                    <div class="d-grid gap-2">
                        <button class="btn btn-lg btn-outline-success d-flex align-items-center justify-content-between"
                            onclick="chooseWhatsApp()">
                            <span><i class="bi bi-whatsapp me-2"></i> WhatsApp</span>
                            <span class="badge bg-success">Recomendado</span>
                        </button>

                        <button class="btn btn-lg btn-outline-primary d-flex align-items-center justify-content-center"
                            onclick="chooseTicket()">
                            <i class="bi bi-ticket me-2"></i> Criar Ticket
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal WhatsApp: Definir Prazo -->
    <div class="modal fade" id="whatsappModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-success text-white border-0">
                    <h5 class="modal-title"><i class="bi bi-whatsapp me-2"></i> Notifica√ß√£o via WhatsApp</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <p class="mb-3">Defina o prazo para resolu√ß√£o via WhatsApp:</p>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Prazo</label>
                        <select id="whatsappDeadline" class="form-select">
                            <option value="24">24 horas</option>
                            <option value="48" selected>48 horas (Recomendado)</option>
                        </select>
                        <small class="text-muted">
                            <i class="bi bi-info-circle me-1"></i>
                            Um timer ser√° iniciado. Se n√£o resolvido no prazo, voc√™ poder√° escalonar para ticket.
                        </small>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="startWhatsAppNotification()">
                        <i class="bi bi-clock me-1"></i> Iniciar Timer
                    </button>
                </div>
            </div>
        </div>
    </div>

</div> <!-- End Lists Tab -->

</div> <!-- End Tab Content -->

<!-- Modal Ticket: Criar Ticket -->
<div class="modal fade" id="ticketModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white border-0">
                <h5 class="modal-title"><i class="bi bi-ticket me-2"></i> Criar Ticket</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">Prioridade</label>
                        <select id="ticketPriority" class="form-select">
                            <option value="baixa">Baixa</option>
                            <option value="media" selected>M√©dia</option>
                            <option value="alta">Alta</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">Prazo (horas)</label>
                        <input type="number" id="ticketDeadline" class="form-control" value="72" min="24" max="168">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Observa√ß√µes</label>
                    <textarea id="ticketNotes" class="form-control" rows="3"
                        placeholder="Detalhes sobre a irregularidade..."></textarea>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="createTicket()">
                    <i class="bi bi-plus-circle me-1"></i> Criar Ticket
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Escalonamento Autom√°tico -->
<div class="modal fade" id="escalationModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg border-warning" style="border-width: 3px !important;">
            <div class="modal-header bg-warning text-dark border-0">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i> Prazo Expirado</h5>
            </div>
            <div class="modal-body p-4 text-center">
                <div class="mb-3">
                    <i class="bi bi-hourglass-bottom text-warning" style="font-size: 4rem;"></i>
                </div>
                <h6 class="fw-bold mb-3">O prazo do WhatsApp expirou!</h6>
                <p class="mb-3">A irregularidade foi resolvida via WhatsApp?</p>

                <div class="d-grid gap-2">
                    <button class="btn btn-success btn-lg" onclick="resolveWithoutTicket()">
                        <i class="bi bi-check-circle me-1"></i> Sim, foi resolvida
                    </button>
                    <button class="btn btn-danger btn-lg" onclick="escalateToTicket()">
                        <i class="bi bi-ticket me-1"></i> N√£o, criar Ticket
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Vari√°veis globais
    let currentIssueId = null;
    let timerIntervals = {};
    const CSRF_TOKEN = '{{ csrf_token }}';

    // Abrir modal de notifica√ß√£o
    function openNotifyModal(issueId) {
        currentIssueId = issueId;
        const modal = new bootstrap.Modal(document.getElementById('notifyModal'));
        modal.show();
    }

    // Escolher WhatsApp
    function chooseWhatsApp() {
        bootstrap.Modal.getInstance(document.getElementById('notifyModal')).hide();
        setTimeout(() => {
            const modal = new bootstrap.Modal(document.getElementById('whatsappModal'));
            modal.show();
        }, 300);
    }

    // Escolher Ticket
    function chooseTicket() {
        bootstrap.Modal.getInstance(document.getElementById('notifyModal')).hide();
        setTimeout(() => {
            const modal = new bootstrap.Modal(document.getElementById('ticketModal'));
            modal.show();
        }, 300);
    }

    // Iniciar notifica√ß√£o WhatsApp
    async function startWhatsAppNotification() {
        const deadlineHours = document.getElementById('whatsappDeadline').value;

        try {
            const response = await fetch(`/api/store-verification/issue/${currentIssueId}/whatsapp/start/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: JSON.stringify({ deadline_hours: parseInt(deadlineHours) })
            });

            const data = await response.json();

            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('whatsappModal')).hide();

                // Atualizar status na tabela
                updateIssueStatus(currentIssueId, 'notificado_whatsapp');

                // Iniciar timer
                startTimer(currentIssueId);

                // Mostrar mensagem de sucesso
                showToast('success', data.message);

                // Recarregar p√°gina ap√≥s 1 segundo
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('error', data.error || 'Erro ao iniciar notifica√ß√£o');
            }
        } catch (error) {
            console.error('Erro:', error);
            showToast('error', 'Erro ao comunicar com o servidor');
        }
    }

    // Criar ticket
    async function createTicket() {
        const priority = document.getElementById('ticketPriority').value;
        const notes = document.getElementById('ticketNotes').value;
        const deadlineHours = document.getElementById('ticketDeadline').value;

        try {
            const response = await fetch(`/api/store-verification/issue/${currentIssueId}/ticket/create/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: JSON.stringify({
                    priority: priority,
                    notes: notes,
                    deadline_hours: parseInt(deadlineHours)
                })
            });

            const data = await response.json();

            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('ticketModal')).hide();
                showToast('success', data.message);
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('error', data.error || 'Erro ao criar ticket');
            }
        } catch (error) {
            console.error('Erro:', error);
            showToast('error', 'Erro ao comunicar com o servidor');
        }
    }

    // Timer em tempo real
    function startTimer(issueId) {
        // Limpar timer anterior se existir
        if (timerIntervals[issueId]) {
            clearInterval(timerIntervals[issueId]);
        }

        // Atualizar a cada 30 segundos
        timerIntervals[issueId] = setInterval(() => updateTimer(issueId), 30000);

        // Atualizar imediatamente
        updateTimer(issueId);
    }

    async function updateTimer(issueId) {
        try {
            const response = await fetch(`/api/store-verification/issue/${issueId}/timer/status/`);
            const data = await response.json();

            if (data.success) {
                const container = document.querySelector(`.timer-container[data-issue-id="${issueId}"]`);
                if (!container) return;

                const timerText = container.querySelector('.timer-text');

                if (data.is_overdue && !data.escalation_shown) {
                    // Prazo expirado - mostrar modal de escalonamento
                    clearInterval(timerIntervals[issueId]);
                    currentIssueId = issueId;
                    showEscalationModal();
                } else if (data.time_remaining_seconds > 0) {
                    // Atualizar timer
                    const hours = Math.floor(data.time_remaining_seconds / 3600);
                    const minutes = Math.floor((data.time_remaining_seconds % 3600) / 60);

                    timerText.textContent = `${hours}h ${minutes}min restantes`;
                    timerText.className = `timer-text text-${data.timer_color === 'green' ? 'success' : data.timer_color === 'yellow' ? 'warning' : 'danger'}`;
                } else {
                    timerText.textContent = 'Prazo expirado';
                    timerText.className = 'timer-text text-danger fw-bold';
                }
            }
        } catch (error) {
            console.error('Erro ao atualizar timer:', error);
        }
    }

    // Mostrar modal de escalonamento
    function showEscalationModal() {
        const modal = new bootstrap.Modal(document.getElementById('escalationModal'));
        modal.show();
    }

    // Resolver sem ticket (ap√≥s prazo)
    async function resolveWithoutTicket() {
        try {
            const response = await fetch(`/api/store-verification/issue/${currentIssueId}/escalate/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: JSON.stringify({ auto_escalate: false })
            });

            const data = await response.json();

            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('escalationModal')).hide();
                showToast('success', 'Irregularidade marcada como resolvida');
                setTimeout(() => location.reload(), 1000);
            }
        } catch (error) {
            console.error('Erro:', error);
            showToast('error', 'Erro ao processar solicita√ß√£o');
        }
    }

    // Escalonar para ticket
    async function escalateToTicket() {
        try {
            const response = await fetch(`/api/store-verification/issue/${currentIssueId}/escalate/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: JSON.stringify({ auto_escalate: true })
            });

            const data = await response.json();

            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('escalationModal')).hide();
                showToast('success', `Irregularidade escalonada para ${data.ticket_id}`);
                setTimeout(() => location.reload(), 1000);
            }
        } catch (error) {
            console.error('Erro:', error);
            showToast('error', 'Erro ao escalonar');
        }
    }

    // Atualizar status visual
    function updateIssueStatus(issueId, status) {
        const statusDiv = document.getElementById(`status-${issueId}`);
        if (!statusDiv) return;

        if (status === 'notificado_whatsapp') {
            statusDiv.innerHTML = `
            <div class="d-flex align-items-center gap-2">
                <span class="badge bg-info text-white">
                    <i class="bi bi-whatsapp me-1"></i> WhatsApp
                </span>
                <div class="timer-container" data-issue-id="${issueId}">
                    <small class="text-muted timer-text">Carregando...</small>
                </div>
            </div>
        `;
        }
    }

    // Toast notification
    function showToast(type, message) {
        const toastHtml = `
        <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;

        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }

        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        const toastElement = toastContainer.lastElementChild;
        const toast = new bootstrap.Toast(toastElement);
        toast.show();

        setTimeout(() => toastElement.remove(), 5000);
    }

    // Iniciar timers ao carregar p√°gina
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.timer-container').forEach(container => {
            const issueId = container.dataset.issueId;
            startTimer(issueId);
        });
    });
</script>

<style>
    .timer-text {
        font-weight: 500;
        transition: color 0.3s ease;
    }

    .toast {
        min-width: 300px;
    }

    .modal-content {
        border-radius: 12px !important;
    }

    .btn-lg {
        padding: 12px 24px;
        font-size: 1.1rem;
    }
</style>

<!-- Modal: Atribuir Lojas a Analista (Em Lote) -->
<div class="modal fade" id="assignStoreModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white border-0">
                <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i> Atribuir Lojas a Analista</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <!-- Etapa 1: Sele√ß√£o de Analista e Quantidade -->
                <div id="step1Selection">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Analista</label>
                            <select id="assignAnalystId" class="form-select">
                                <option value="">Carregando analistas...</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">Quantidade de Lojas</label>
                            <input type="number" id="assignQuantity" class="form-control" placeholder="Ex: 35" min="1"
                                max="500">
                            <small class="text-muted">
                                <span id="availableCount">-</span> lojas dispon√≠veis
                            </small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Meta Semanal (por loja)</label>
                        <select id="assignWeeklyTarget" class="form-select">
                            <option value="1" selected>1x por semana</option>
                            <option value="2">2x por semana</option>
                            <option value="3">3x por semana</option>
                        </select>
                    </div>

                    <!-- NOVO: Per√≠odo de Verifica√ß√£o -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="bi bi-calendar-range me-1 text-primary"></i>
                            Per√≠odo de Verifica√ß√£o
                        </label>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label small text-muted">Data de In√≠cio</label>
                                <input type="date" id="assignPeriodStart" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small text-muted">Data de Fim</label>
                                <input type="date" id="assignPeriodEnd" class="form-control" required>
                            </div>
                        </div>
                        <div id="periodSummary"
                            class="alert alert-info bg-info bg-opacity-10 border-info border-opacity-25 mt-2 d-none">
                            <i class="bi bi-calendar-check me-2"></i>
                            <strong>Per√≠odo:</strong> <span id="periodDays">-</span> dias
                            (<span id="periodRange">-</span>)
                        </div>
                        <small class="text-muted">
                            <i class="bi bi-info-circle me-1"></i>
                            Defina o prazo que o analista ter√° para completar as verifica√ß√µes
                        </small>
                    </div>

                    <div class="alert alert-info bg-info bg-opacity-10 border-info border-opacity-25">
                        <i class="bi bi-lightbulb me-1"></i>
                        O sistema ir√° selecionar lojas <strong>aleat√≥rias</strong> que ainda n√£o est√£o
                        atribu√≠das a
                        nenhum analista.
                    </div>
                </div>

                <!-- Etapa 2: Visualiza√ß√£o das Lojas Selecionadas -->
                <div id="step2Preview" class="d-none">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="fw-bold mb-0">
                            <i class="bi bi-shop me-1"></i>
                            <span id="selectedCount">0</span> Lojas Selecionadas
                        </h6>
                        <button class="btn btn-sm btn-outline-primary" onclick="regenerateSelection()">
                            <i class="bi bi-arrow-clockwise me-1"></i> Gerar Novamente
                        </button>
                    </div>

                    <div id="selectedStoresList" class="border rounded p-3"
                        style="max-height: 300px; overflow-y: auto;">
                        <!-- Lista ser√° preenchida via JS -->
                    </div>

                    <div class="alert alert-warning bg-warning bg-opacity-10 border-warning border-opacity-25 mt-3">
                        <i class="bi bi-info-circle me-1"></i>
                        Confira se as lojas selecionadas est√£o corretas. Voc√™ pode gerar uma nova sele√ß√£o
                        aleat√≥ria
                        clicando em "Gerar Novamente".
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>

                <!-- Bot√£o Etapa 1 -->
                <button type="button" id="btnGenerateSelection" class="btn btn-primary" onclick="generateSelection()">
                    <i class="bi bi-shuffle me-1"></i> Gerar Sele√ß√£o
                </button>

                <!-- Bot√µes Etapa 2 (ocultos inicialmente) -->
                <button type="button" id="btnBackToSelection" class="btn btn-secondary d-none" onclick="backToStep1()">
                    <i class="bi bi-arrow-left me-1"></i> Voltar
                </button>
                <button type="button" id="btnConfirmAssignment" class="btn btn-success d-none"
                    onclick="confirmBulkAssignment()">
                    <i class="bi bi-check-lg me-1"></i> Confirmar Atribui√ß√£o
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // JavaScript para Gest√£o de Analistas

    {% if user.role == 'analista' %}
    // Carregar dashboard do analista
    document.addEventListener('DOMContentLoaded', function () {
        loadAnalystDashboard();
    });

    async function loadAnalystDashboard() {
        try {
            const response = await fetch('/api/store-verification/analyst/dashboard/');
            const data = await response.json();

            if (data.success) {
                // Atualizar m√©tricas
                document.getElementById('totalStores').textContent = data.metrics.total_stores;
                document.getElementById('dailyTarget').textContent = data.metrics.daily_target;
                document.getElementById('auditedCount').textContent = data.metrics.total_audited;
                document.getElementById('progressPercentage').textContent = data.metrics.progress_percentage + '%';
                document.getElementById('progressText').textContent = `${data.metrics.total_audited}/${data.metrics.total_target}`;
                document.getElementById('daysRemaining').textContent = data.metrics.days_remaining;

                // Update the end day name
                if (data.metrics.period_end_day) {
                    document.getElementById('periodEndDay').textContent = data.metrics.period_end_day;
                }

                // Atualizar barra de progresso
                const progressBar = document.getElementById('progressBar');
                const percentage = data.metrics.progress_percentage;
                progressBar.style.width = percentage + '%';
                progressBar.querySelector('span').textContent = Math.round(percentage) + '%';

                // Mudar cor da barra baseada no progresso
                progressBar.className = 'progress-bar';
                if (percentage >= 100) {
                    progressBar.classList.add('bg-success');
                } else if (percentage >= 75) {
                    progressBar.classList.add('bg-info');
                } else if (percentage >= 50) {
                    progressBar.classList.add('bg-warning');
                } else {
                    progressBar.classList.add('bg-danger');
                }

                // Carregar lojas atribu√≠das
                loadMyStores();
            }
        } catch (error) {
            console.error('Erro ao carregar dashboard:', error);
        }
    }

    async function loadMyStores() {
        try {
            const response = await fetch('/api/store-verification/analyst/assignments/');
            const data = await response.json();

            if (data.success) {
                const container = document.getElementById('myStoresList');

                if (data.assignments.length === 0) {
                    container.innerHTML = `
                    <div class="col-12 text-center py-4">
                        <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-2">Nenhuma loja atribu√≠da ainda</p>
                    </div>
                `;
                    return;
                }

                container.innerHTML = '';
                data.assignments.forEach(assignment => {
                    const progress = assignment.progress;
                    const card = `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card h-100 border-0 shadow-sm store-card-clickable" onclick="showStoreDetails(${assignment.store_id})">
                            <div class="card-body">
                                <h6 class="fw-bold text-primary">${assignment.store_code}</h6>
                                <small class="text-muted">${assignment.store_city || '-'}</small>
                                <hr>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted small">Progresso</span>
                                    <span class="fw-bold small">${progress.completed}/${progress.target}</span>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar ${progress.percentage >= 100 ? 'bg-success' : 'bg-primary'}" 
                                         style="width: ${Math.min(100, progress.percentage)}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                    container.insertAdjacentHTML('beforeend', card);
                });
            }
        } catch (error) {
            console.error('Erro ao carregar lojas:', error);
        }
    }
    {% endif %}

    {% if user.role in 'gestor,administrador' %}
    // JavaScript para Atribui√ß√£o em Lote
    let selectedStoresArray = [];  // Armazena lojas selecionadas

    document.addEventListener('DOMContentLoaded', function () {
        loadAnalysts();
        loadAvailableCount();
        loadAllAssignments();
    });

    async function loadAnalysts() {
        try {
            const response = await fetch('/api/users/nrs-analysts/');
            const data = await response.json();

            const select = document.getElementById('assignAnalystId');
            select.innerHTML = '<option value="">Selecione um analista...</option>';

            if (data.analysts) {
                data.analysts.forEach(analyst => {
                    select.innerHTML += `<option value="${analyst.id}">${analyst.name}</option>`;
                });
            }
        } catch (error) {
            console.error('Erro ao carregar analistas:', error);
        }
    }

    async function loadAvailableCount() {
        try {
            const response = await fetch('/api/store-verification/analyst/available-stores/');
            const data = await response.json();

            if (data.success) {
                document.getElementById('availableCount').textContent = data.total_available;
                document.getElementById('assignQuantity').max = data.total_available;
            }
        } catch (error) {
            console.error('Erro ao carregar contador:', error);
        }
    }

    // Gerar sele√ß√£o aleat√≥ria
    async function generateSelection() {
        const analystId = document.getElementById('assignAnalystId').value;
        const quantity = document.getElementById('assignQuantity').value;

        if (!analystId) {
            showToast('error', 'Selecione um analista');
            return;
        }

        if (!quantity || parseInt(quantity) < 1) {
            showToast('error', 'Digite uma quantidade v√°lida');
            return;
        }

        try {
            const response = await fetch(`/api/store-verification/analyst/available-stores/?quantity=${quantity}`);
            const data = await response.json();

            if (data.success) {
                selectedStoresArray = data.stores;
                showStep2(data.stores);
            } else {
                showToast('error', data.error || 'Erro ao gerar sele√ß√£o');
            }
        } catch (error) {
            console.error('Erro:', error);
            showToast('error', 'Erro ao comunicar com o servidor');
        }
    }

    // Mostrar etapa 2 (preview)
    function showStep2(stores) {
        // Ocultar etapa 1
        document.getElementById('step1Selection').classList.add('d-none');
        document.getElementById('btnGenerateSelection').classList.add('d-none');

        // Mostrar etapa 2
        document.getElementById('step2Preview').classList.remove('d-none');
        document.getElementById('btnBackToSelection').classList.remove('d-none');
        document.getElementById('btnConfirmAssignment').classList.remove('d-none');

        // Atualizar contador
        document.getElementById('selectedCount').textContent = stores.length;

        // Renderizar lista de lojas
        const container = document.getElementById('selectedStoresList');
        container.innerHTML = '';

        stores.forEach(store => {
            const storeCard = `
                <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                    <div>
                        <span class="fw-bold text-primary">${store.code}</span>
                        <small class="text-muted ms-2">${store.city || '-'}</small>
                    </div>
                    <i class="bi bi-check-circle text-success"></i>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', storeCard);
        });
    }

    // Voltar para etapa 1
    function backToStep1() {
        document.getElementById('step1Selection').classList.remove('d-none');
        document.getElementById('btnGenerateSelection').classList.remove('d-none');

        document.getElementById('step2Preview').classList.add('d-none');
        document.getElementById('btnBackToSelection').classList.add('d-none');
        document.getElementById('btnConfirmAssignment').classList.add('d-none');

        selectedStoresArray = [];
    }

    // Regenerar sele√ß√£o (nova sele√ß√£o aleat√≥ria)
    function regenerateSelection() {
        const quantity = document.getElementById('assignQuantity').value;

        // Voltar para etapa 1 e gerar novamente
        backToStep1();
        generateSelection();
    }

    // Confirmar atribui√ß√£o em lote
    async function confirmBulkAssignment() {
        const analystId = document.getElementById('assignAnalystId').value;
        const weeklyTarget = document.getElementById('assignWeeklyTarget').value;

        if (selectedStoresArray.length === 0) {
            showToast('error', 'Nenhuma loja selecionada');
            return;
        }

        const storeIds = selectedStoresArray.map(s => s.id);

        try {
            const response = await fetch('/api/store-verification/analyst/bulk-assign/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: JSON.stringify({
                    analyst_id: parseInt(analystId),
                    store_ids: storeIds,
                    weekly_target: parseInt(weeklyTarget)
                })
            });

            const data = await response.json();

            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('assignStoreModal')).hide();
                showToast('success', data.message);

                // Resetar modal
                setTimeout(() => {
                    backToStep1();
                    document.getElementById('assignQuantity').value = '';
                    loadAvailableCount();  // Atualizar contador
                }, 500);
            } else {
                showToast('error', data.error || 'Erro ao atribuir lojas');

                // Se houve conflito, mostrar detalhes
                if (data.conflicts) {
                    let conflictMsg = 'Conflitos encontrados:\n';
                    data.conflicts.forEach(c => {
                        conflictMsg += `\n- ${c.store} j√° est√° com ${c.analyst}`;
                    });
                    alert(conflictMsg);
                }
            }
        } catch (error) {
            console.error('Erro:', error);
            showToast('error', 'Erro ao comunicar com o servidor');
        }
    }

    async function loadAllAssignments() {
        try {
            const response = await fetch('/api/store-verification/analyst/all-assignments/');
            const data = await response.json();

            const tbody = document.getElementById('assignmentsTableBody');

            if (data.success) {
                if (data.assignments.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center py-4">
                                <p class="text-muted">Nenhuma atribui√ß√£o encontrada</p>
                                <small class="text-muted">Use o bot√£o "Atribuir Loja" para come√ßar</small>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = '';
                data.assignments.forEach(item => {
                    const row = `
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar-initials bg-light text-primary rounded-circle me-2" 
                                         style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; overflow: hidden;">
                                        ${item.analyst_photo_url ? `<img src="${item.analyst_photo_url}" alt="${item.analyst_name}" style="width: 100%; height: 100%; object-fit: cover;">` : item.analyst_name.substring(0, 2).toUpperCase()}
                                    </div>
                                    <span class="fw-500">${item.analyst_name}</span>
                                </div>
                            </td>
                            <td>
                                <span class="fw-bold text-dark">${item.store_code}</span>
                                <br>
                                <small class="text-muted">${item.store_city || '-'}</small>
                            </td>
                            <td>
                                <span class="badge bg-light text-dark border">
                                    ${item.weekly_target}x / semana
                                </span>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="progress flex-grow-1 me-2" style="height: 6px;">
                                        <div class="progress-bar ${item.progress.percentage >= 100 ? 'bg-success' : 'bg-primary'}" 
                                             style="width: ${Math.min(100, item.progress.percentage)}%"></div>
                                    </div>
                                    <small class="text-muted">${item.progress.completed}/${item.progress.target}</small>
                                </div>
                            </td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('beforeend', row);
                });
            }
        } catch (error) {
            console.error('Erro ao carregar atribui√ß√µes:', error);
            const tbody = document.getElementById('assignmentsTableBody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-4 text-danger">
                            <i class="bi bi-exclamation-triangle me-1"></i> Erro ao carregar dados
                        </td>
                    </tr>
                `;
            }
        }
    }
    {% endif %}
</script>

<!-- Analyst Detail Modal -->
<div class="modal fade" id="analystDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-bottom-0 pb-0">
                <h5 class="modal-title fw-bold text-dark d-flex align-items-center gap-2">
                    <i class="bi bi-person-circle text-primary"></i>
                    <span id="analystModalName">Analista</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-3">
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="p-3 rounded-3 bg-light text-center h-100">
                            <h3 class="mb-0 fw-bold text-primary" id="modalTotalStores">-</h3>
                            <small class="text-muted">Lojas Atribu√≠das</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3 rounded-3 bg-light text-center h-100">
                            <h3 class="mb-0 fw-bold text-success" id="modalWeeklyAudited">-</h3>
                            <small class="text-muted">Auditadas (Semana)</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3 rounded-3 bg-light text-center h-100">
                            <h3 class="mb-0 fw-bold text-warning" id="modalPending">-</h3>
                            <small class="text-muted">Pendentes</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3 rounded-3 bg-light text-center h-100">
                            <h3 class="mb-0 fw-bold text-info" id="modalDailyAudited">-</h3>
                            <small class="text-muted">Auditadas (Hoje)</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-12 text-end">
                    <button class="btn btn-outline-primary btn-sm" onclick="openOverrideModal()">
                        <i class="bi bi-unlock me-1"></i> Liberar Mais Lojas (Hoje)
                    </button>
                </div>
            </div>

            <h6 class="fw-bold mb-3 border-bottom pb-2">Lojas sob Responsabilidade</h6>
            <div class="table-responsive" style="max-height: 400px;">
                <table class="table table-hover table-sm align-middle">
                    <thead class="bg-light sticky-top">
                        <tr>
                            <th>Loja</th>
                            <th>Status</th>
                            <th>√öltima Auditoria</th>
                            <th class="text-end">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="modalStoresTableBody">
                        <!-- Populated via JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        loadAnalystOverview();
    });

    async function loadAnalystOverview() {
        const grid = document.getElementById('analystsGrid');
        if (!grid) return; // Only if element exists (Manager view)

        try {
            const response = await fetch('/api/store-verification/analyst/overview/');
            const data = await response.json();

            if (data.success) {
                grid.innerHTML = '';
                if (data.analysts.length === 0) {
                    grid.innerHTML = '<div class="col-12 text-center text-muted">Nenhum analista encontrado.</div>';
                    return;
                }

                data.analysts.forEach(analyst => {
                    const isAttention = analyst.is_attention;
                    const borderClass = isAttention ? 'border-warning border-2' : 'border-0';
                    const bgClass = isAttention ? 'bg-warning bg-opacity-10' : 'bg-white';

                    const cardHtml = `
                                <div class="col-md-4 col-lg-3">
                                    <div class="card h-100 shadow-sm ${borderClass} cursor-pointer hover-shadow transition-all" 
                                         onclick='openAnalystModal(${JSON.stringify(analyst).replace(/'/g, "&#39;")})'
                                         style="cursor: pointer; transition: transform 0.2s;">
                                        <div class="card-body ${bgClass}">
                                            <div class="d-flex align-items-center mb-3">
                                                <div class="avatar-circle bg-primary text-white rounded-circle d-flex align-items-center justify-content-center fw-bold me-3" style="width: 48px; height: 48px; font-size: 1.2rem; overflow: hidden;">
                                                    ${analyst.photo_url ? `<img src="${analyst.photo_url}" alt="${analyst.name}" style="width: 100%; height: 100%; object-fit: cover;">` : analyst.name.charAt(0)}
                                                </div>
                                                <div>
                                                    <h6 class="fw-bold mb-0 text-truncate" style="max-width: 150px;" title="${analyst.name}">${analyst.name}</h6>
                                                    <small class="text-muted">${analyst.stats.total_stores} Lojas</small>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-2">
                                                <div class="d-flex justify-content-between small mb-1">
                                                    <span>Semana</span>
                                                    <span class="fw-bold ${analyst.stats.weekly_progress_pct >= 100 ? 'text-success' : 'text-primary'}">${analyst.stats.weekly_audited}/${analyst.stats.weekly_target}</span>
                                                </div>
                                                <div class="progress" style="height: 6px;">
                                                    <div class="progress-bar ${isAttention ? 'bg-warning' : 'bg-success'}" role="progressbar" style="width: ${analyst.stats.weekly_progress_pct}%"></div>
                                                </div>
                                            </div>

                                            ${isAttention ? `
                                            <div class="d-flex align-items-center text-warning small mt-2">
                                                <i class="bi bi-exclamation-triangle-fill me-1"></i> Aten√ß√£o: Meta di√°ria
                                            </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                    grid.insertAdjacentHTML('beforeend', cardHtml);
                });
            }
        } catch (e) {
            console.error("Erro ao carregar analistas", e);
            grid.innerHTML = '<div class="col-12 text-center text-danger">Erro ao carregar dados.</div>';
        }
    }

    let currentAnalystForOverride = null; // Global variable to store current analyst

    function openAnalystModal(analyst) {
        currentAnalystForOverride = analyst;
        document.getElementById('analystModalName').textContent = analyst.name;
        document.getElementById('modalTotalStores').textContent = analyst.stats.total_stores;
        document.getElementById('modalWeeklyAudited').textContent = analyst.stats.weekly_audited;
        document.getElementById('modalPending').textContent = analyst.stats.pending_weekly;
        document.getElementById('modalDailyAudited').textContent = analyst.stats.today_audits;

        const tbody = document.getElementById('modalStoresTableBody');
        tbody.innerHTML = '';

        analyst.stores.forEach(store => {
            let statusBadge = '';
            let rowClass = '';  // Background color for the row

            if (store.status === 'Conforme') {
                statusBadge = '<span class="badge bg-success bg-opacity-10 text-success">Conforme</span>';
                rowClass = 'table-success bg-opacity-25';  // Light green background
            } else if (store.status === 'Irregular') {
                statusBadge = '<span class="badge bg-danger bg-opacity-10 text-danger">Irregular</span>';
                rowClass = 'table-danger bg-opacity-25';  // Light red background
            } else {
                statusBadge = '<span class="badge bg-secondary bg-opacity-10 text-secondary">Pendente</span>';
                rowClass = '';  // No background (white)
            }

            const row = `
                        <tr class="${rowClass}">
                            <td class="fw-bold">${store.code}</td>
                            <td>${statusBadge}</td>
                            <td class="small text-muted">${store.last_audit}</td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-danger rounded-pill px-3" 
                                        onclick="confirmUnassignStore(${store.assignment_id}, '${store.code}', '${analyst.name}')"
                                        title="Desvincular loja">
                                    <i class="bi bi-x-circle me-1"></i>Desvincular
                                </button>
                            </td>
                        </tr>
                    `;
            tbody.insertAdjacentHTML('beforeend', row);
        });

        new bootstrap.Modal(document.getElementById('analystDetailModal')).show();
    }

    // Fun√ß√£o para mostrar detalhes da loja no modal
    function showStoreDetails(storeId) {
        const modal = new bootstrap.Modal(document.getElementById('storeDetailsModal'));
        modal.show();

        // Resetar conte√∫do
        document.getElementById('storeDetailBody').innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
            </div>
        `;

        // Buscar detalhes
        fetch(`/api/stores/${storeId}/detail/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const store = data.store;
                    document.getElementById('storeDetailCode').textContent = store.code;

                    let statusBadge = '';
                    if (store.last_audit_result === 'irregular') {
                        statusBadge = '<span class="badge bg-warning text-dark px-3 py-2"><i class="bi bi-exclamation-triangle me-1"></i>Irregular</span>';
                    } else if (store.last_audit_result === 'conforme') {
                        statusBadge = '<span class="badge bg-success px-3 py-2"><i class="bi bi-check-circle me-1"></i>Conforme</span>';
                    } else {
                        statusBadge = '<span class="badge bg-secondary px-3 py-2">Sem Auditoria</span>';
                    }

                    document.getElementById('storeDetailBody').innerHTML = `
                        <div class="mb-3">
                            <h6 class="text-muted small mb-2">Cidade</h6>
                            <p class="mb-0">${store.city}</p>
                        </div>
                        <div class="mb-3">
                            <h6 class="text-muted small mb-2">Status</h6>
                            <p class="mb-0">${statusBadge}</p>
                        </div>
                        <div class="mb-3">
                            <h6 class="text-muted small mb-2">√öltima Auditoria</h6>
                            <p class="mb-0">${store.last_audit_date || 'Nunca auditada'}</p>
                            ${store.analyst_name ? `<small class="text-muted">por ${store.analyst_name}</small>` : ''}
                        </div>
                        ${store.needs_reverification ? `
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-arrow-repeat me-2"></i>
                                <strong>Reverifica√ß√£o Necess√°ria</strong>
                            </div>
                        ` : ''}
                        <div class="d-grid gap-2 mt-4">
                            <a href="/verificacao-lojas/auditoria/${store.id}/" class="btn btn-primary btn-lg">
                                <i class="bi bi-shield-plus me-2"></i>Realizar Auditoria
                            </a>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Erro ao carregar detalhes:', error);
                document.getElementById('storeDetailBody').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-circle me-2"></i>
                        Erro ao carregar detalhes da loja
                    </div>
                `;
            });
    }

    // ========================================
    // JavaScript para Per√≠odo Personalizado
    // ========================================

    // Definir data m√≠nima como hoje e sugerir per√≠odo padr√£o
    document.addEventListener('DOMContentLoaded', function () {
        const today = new Date().toISOString().split('T')[0];
        const periodStartInput = document.getElementById('assignPeriodStart');
        const periodEndInput = document.getElementById('assignPeriodEnd');

        if (periodStartInput) {
            periodStartInput.min = today;
            periodStartInput.value = today;

            // Sugerir 7 dias a partir de hoje
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            periodEndInput.min = today;
            periodEndInput.value = nextWeek.toISOString().split('T')[0];

            // Atualizar resumo inicial
            updatePeriodSummary();
        }
    });

    // Calcular e exibir resumo do per√≠odo
    function updatePeriodSummary() {
        const startInput = document.getElementById('assignPeriodStart');
        const endInput = document.getElementById('assignPeriodEnd');
        const summary = document.getElementById('periodSummary');
        const daysSpan = document.getElementById('periodDays');
        const rangeSpan = document.getElementById('periodRange');

        if (startInput && endInput && startInput.value && endInput.value) {
            const start = new Date(startInput.value);
            const end = new Date(endInput.value);

            // Validar
            if (start > end) {
                startInput.setCustomValidity('Data de in√≠cio deve ser anterior √† data de fim');
                summary.classList.add('d-none');
                return;
            } else {
                startInput.setCustomValidity('');
            }

            // Calcular dias
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

            // Formatar datas
            const startFormatted = start.toLocaleDateString('pt-BR');
            const endFormatted = end.toLocaleDateString('pt-BR');

            // Exibir resumo
            daysSpan.textContent = diffDays;
            rangeSpan.textContent = `${startFormatted} a ${endFormatted}`;
            summary.classList.remove('d-none');
        } else {
            summary.classList.add('d-none');
        }
    }

    // Adicionar listeners se os campos existirem
    const periodStartField = document.getElementById('assignPeriodStart');
    const periodEndField = document.getElementById('assignPeriodEnd');
    if (periodStartField) periodStartField.addEventListener('change', updatePeriodSummary);
    if (periodEndField) periodEndField.addEventListener('change', updatePeriodSummary);

    // ========================================
    // Fun√ß√µes de Atribui√ß√£o em Lote
    // ========================================

    // Helper function to get CSRF token from multiple sources
    function getCookie(name) {
        let cookieValue = null;

        // Try 1: Get from cookie
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }

        // Try 2: Get from meta tag
        if (!cookieValue) {
            const metaTag = document.querySelector('meta[name="csrf-token"]');
            if (metaTag) {
                cookieValue = metaTag.getAttribute('content');
            }
        }

        // Try 3: Get from hidden input
        if (!cookieValue) {
            const inputTag = document.querySelector('input[name="csrfmiddlewaretoken"]');
            if (inputTag) {
                cookieValue = inputTag.value;
            }
        }

        console.log('CSRF Token retrieved:', cookieValue ? 'Found (length: ' + cookieValue.length + ')' : 'NOT FOUND');
        return cookieValue;
    }

    let selectedStores = [];

    async function generateSelection() {
        const analystId = document.getElementById('assignAnalystId').value;
        const quantity = parseInt(document.getElementById('assignQuantity').value);
        const periodStart = document.getElementById('assignPeriodStart').value;
        const periodEnd = document.getElementById('assignPeriodEnd').value;

        if (!analystId) {
            alert('Por favor, selecione um analista');
            return;
        }

        if (!quantity || quantity < 1) {
            alert('Por favor, informe uma quantidade v√°lida');
            return;
        }

        if (!periodStart || !periodEnd) {
            alert('Por favor, defina o per√≠odo de verifica√ß√£o');
            return;
        }

        if (new Date(periodStart) > new Date(periodEnd)) {
            alert('Data de in√≠cio deve ser anterior √† data de fim');
            return;
        }

        try {
            const response = await fetch(`/api/store-verification/analyst/available-stores/?quantity=${quantity}`);
            const data = await response.json();

            if (data.success && data.stores) {
                selectedStores = data.stores;

                document.getElementById('selectedCount').textContent = selectedStores.length;

                const listHTML = selectedStores.map(store => `
                    <div class="d-flex align-items-center gap-2 p-2 border-bottom">
                        <i class="bi bi-shop text-primary"></i>
                        <div>
                            <strong>${store.code}</strong>
                            <small class="text-muted d-block">${store.city}</small>
                        </div>
                    </div>
                `).join('');

                document.getElementById('selectedStoresList').innerHTML = listHTML;

                // Mudar para etapa 2
                document.getElementById('step1Selection').classList.add('d-none');
                document.getElementById('step2Preview').classList.remove('d-none');
                document.getElementById('btnGenerateSelection').classList.add('d-none');
                document.getElementById('btnBackToSelection').classList.remove('d-none');
                document.getElementById('btnConfirmAssignment').classList.remove('d-none');
            } else {
                alert(data.error || 'Erro ao gerar sele√ß√£o');
            }
        } catch (error) {
            console.error('Erro:', error);
            alert('Erro ao gerar sele√ß√£o de lojas');
        }
    }

    function backToStep1() {
        document.getElementById('step1Selection').classList.remove('d-none');
        document.getElementById('step2Preview').classList.add('d-none');
        document.getElementById('btnGenerateSelection').classList.remove('d-none');
        document.getElementById('btnBackToSelection').classList.add('d-none');
        document.getElementById('btnConfirmAssignment').classList.add('d-none');
    }

    function regenerateSelection() {
        backToStep1();
        generateSelection();
    }

    async function confirmBulkAssignment() {
        const analystId = document.getElementById('assignAnalystId').value;
        const weeklyTarget = parseInt(document.getElementById('assignWeeklyTarget').value);
        const periodStart = document.getElementById('assignPeriodStart').value;
        const periodEnd = document.getElementById('assignPeriodEnd').value;
        const storeIds = selectedStores.map(s => s.id);

        if (!confirm(`Confirma a atribui√ß√£o de ${storeIds.length} lojas?`)) {
            return;
        }

        try {
            const response = await fetch('/api/store-verification/analyst/bulk-assign/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Csrftoken': getCookie('csrftoken')  // FIXED: case-sensitive header name
                },
                body: JSON.stringify({
                    analyst_id: analystId,
                    store_ids: storeIds,
                    weekly_target: weeklyTarget,
                    period_start: periodStart,
                    period_end: periodEnd
                })
            });

            const data = await response.json();

            if (data.success) {
                // Close assignment modal
                const assignmentModal = bootstrap.Modal.getInstance(document.getElementById('assignmentModal'));
                if (assignmentModal) {
                    assignmentModal.hide();
                }

                // Show toast message
                showToast('success', `${data.message} - ${storeIds.length} loja(s) atribu√≠da(s)`);

                // Reload after 2 seconds
                setTimeout(() => location.reload(), 2000);
            } else {
                showToast('error', 'Erro: ' + data.error);
            }
        } catch (error) {
            console.error('Erro:', error);
            showToast('error', 'Erro ao confirmar atribui√ß√£o');
        }
    }

    // Show toast notification
    function showToast(type, message, duration = 4000) {
        const container = document.getElementById('toastContainer');
        if (!container) return;

        // Icon and color maps
        const iconMap = {
            'success': 'bi-check-circle-fill text-success',
            'error': 'bi-x-circle-fill text-danger',
            'warning': 'bi-exclamation-triangle-fill text-warning',
            'info': 'bi-info-circle-fill text-info'
        };

        const borderMap = {
            'success': '#198754',
            'error': '#dc3545',
            'warning': '#ffc107',
            'info': '#0dcaf0'
        };

        const icon = iconMap[type] || iconMap['info'];
        const borderColor = borderMap[type] || borderMap['info'];
        const toastId = 'toast-' + Date.now();

        const toastHTML = `
            <div id="${toastId}" class="toast align-items-center border-0 mb-2 shadow-lg" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body d-flex align-items-center bg-white" style="border-left: 4px solid ${borderColor};">
                        <i class="bi ${icon} me-2" style="font-size: 1.25rem;"></i>
                        <span>${message}</span>
                    </div>
                    <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;

        container.insertAdjacentHTML('beforeend', toastHTML);

        // Initialize and show toast
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, { delay: duration });
        toast.show();

        // Remove from DOM after hiding
        toastElement.addEventListener('hidden.bs.toast', () => {
            toastElement.remove();
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Function to confirm and unassign store from analyst
    async function confirmUnassignStore(assignmentId, storeCode, analystName) {
        // Show confirmation modal instead of confirm()
        showConfirmModal(
            `Deseja realmente desvincular a loja ${storeCode} de ${analystName}?`,
            async () => {
                try {
                    const response = await fetch(`/api/store-verification/analyst/unassign/${assignmentId}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Csrftoken': getCookie('csrftoken')
                        }
                    });

                    const data = await response.json();

                    if (data.success) {
                        showToast('success', data.message);
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showToast('error', 'Erro: ' + data.error);
                    }
                } catch (error) {
                    console.error('Erro ao desvincular loja:', error);
                    showToast('error', 'Erro ao desvincular loja');
                }
            }
        );
    }

    // Show confirmation modal (reusable)
    function showConfirmModal(message, onConfirm) {
        const modalElement = document.getElementById('confirmModal');
        const modalBody = document.getElementById('confirmModalBody');
        const confirmButton = document.getElementById('confirmModalAction');

        // Set message
        modalBody.textContent = message;

        // Remove old event listeners by cloning
        const newConfirmButton = confirmButton.cloneNode(true);
        confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);

        // Add new event listener
        newConfirmButton.addEventListener('click', () => {
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) modal.hide();
            if (onConfirm) onConfirm();
        });

        const modal = new bootstrap.Modal(modalElement);
        modal.show();
    }

    // ===== AUTO DISTRIBUTION FUNCTIONS =====

    let availableStoresCount = 0;

    // Open auto distribution modal
    async function openAutoDistributionModal() {
        const modal = new bootstrap.Modal(document.getElementById('autoDistributionModal'));

        // Load analysts and available stores count
        await loadAnalystsForAutoDistribution();

        // Set default dates
        const today = new Date();
        const endDate = new Date(today);
        endDate.setDate(today.getDate() + 7);

        document.getElementById('autoPeriodStart').valueAsDate = today;
        document.getElementById('autoPeriodEnd').valueAsDate = endDate;

        modal.show();
    }

    // Load analysts with checkboxes
    async function loadAnalystsForAutoDistribution() {
        try {
            const response = await fetch('/api/store-verification/analyst/overview/');
            const data = await response.json();

            const countResponse = await fetch('/api/store-verification/analyst/available-stores/');
            const countData = await countResponse.json();
            availableStoresCount = countData.success ? countData.stores.length : 0;

            document.getElementById('statsAvailableStores').textContent = availableStoresCount;

            const container = document.getElementById('analystCheckboxList');
            if (data.success && data.analysts.length > 0) {
                container.innerHTML = '';
                data.analysts.forEach(analyst => {
                    const checkboxHtml = `
                        <div class="form-check mb-2 p-3 border rounded" style="cursor: pointer; transition: background 0.2s;" 
                             onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                            <input class="form-check-input analyst-checkbox" type="checkbox" value="${analyst.id}" 
                                   id="analyst${analyst.id}" onchange="updateAutoDistributionStats()" 
                                   style="width: 20px; height: 20px; cursor: pointer;">
                            <label class="form-check-label w-100 ms-2" for="analyst${analyst.id}" style="cursor: pointer;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-bold">${analyst.name}</span>
                                    <span class="badge bg-secondary">${analyst.stats.total_stores} lojas</span>
                                </div>
                            </label>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', checkboxHtml);
                });
            } else {
                container.innerHTML = '<p class="text-muted">Nenhum analista encontrado</p>';
            }
        } catch (error) {
            console.error('Erro ao carregar analistas:', error);
            showToast('error', 'Erro ao carregar analistas');
        }
    }

    // Toggle select/deselect all analysts
    function toggleSelectAllAnalysts() {
        const checkboxes = document.querySelectorAll('.analyst-checkbox');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);

        checkboxes.forEach(cb => {
            cb.checked = !allChecked;
        });

        updateAutoDistributionStats();
    }

    // Update stats in real-time
    function updateAutoDistributionStats() {
        const checkboxes = document.querySelectorAll('#analystCheckboxList input[type="checkbox"]:checked');
        const selectedCount = checkboxes.length;

        document.getElementById('statsSelectedAnalysts').textContent = selectedCount;

        if (selectedCount > 0 && availableStoresCount > 0) {
            const perAnalyst = Math.floor(availableStoresCount / selectedCount);
            document.getElementById('statsPerAnalyst').textContent = perAnalyst;
        } else {
            document.getElementById('statsPerAnalyst').textContent = '-';
        }
    }

    // Confirm and execute auto distribution
    async function confirmAutoDistribution() {
        const checkboxes = document.querySelectorAll('#analystCheckboxList input[type="checkbox"]:checked');
        const analystIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

        if (analystIds.length === 0) {
            showToast('warning', 'Selecione pelo menos um analista');
            return;
        }

        const weeklyTarget = parseInt(document.getElementById('autoWeeklyTarget').value);
        const periodStart = document.getElementById('autoPeriodStart').value;
        const periodEnd = document.getElementById('autoPeriodEnd').value;

        try {
            const response = await fetch('/api/store-verification/analyst/auto-distribute/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Csrftoken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    analyst_ids: analystIds,
                    weekly_target: weeklyTarget,
                    period_start: periodStart,
                    period_end: periodEnd
                })
            });

            const data = await response.json();

            if (data.success) {
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('autoDistributionModal'));
                if (modal) modal.hide();

                // Show success toast
                showToast('success', data.message);

                // Reload after 2 seconds
                setTimeout(() => location.reload(), 2000);
            } else {
                showToast('error', 'Erro: ' + data.error);
            }
        } catch (error) {
            console.error('Erro:', error);
            showToast('error', 'Erro ao distribuir lojas');
        }
    }

    // Unassign all stores
    async function confirmUnassignAllStores() {
        showConfirmModal(
            'Deseja realmente DESATRIBUIR TODAS as lojas de TODOS os analistas? Esta a√ß√£o n√£o pode ser desfeita.',
            async () => {
                try {
                    const response = await fetch('/api/store-verification/analyst/unassign-all/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Csrftoken': getCookie('csrftoken')
                        }
                    });

                    const data = await response.json();

                    if (data.success) {
                        showToast('success', data.message);
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showToast('error', 'Erro: ' + data.error);
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    showToast('error', 'Erro ao desatribuir lojas');
                }
            }
        );
    }

    // Load Monthly KPI
    async function loadMonthlyKPI() {
        const kpiLoading = document.getElementById('monthlyKpiLoading');
        const kpiContent = document.getElementById('monthlyKpiContent');

        if (!kpiLoading || !kpiContent) return;

        try {
            const response = await fetch('/api/store-verification/analyst/monthly-kpi/');
            const data = await response.json();

            if (data.success) {
                // Hide loading, show content
                kpiLoading.classList.add('d-none');
                kpiContent.classList.remove('d-none');

                // Update success rate
                const successRate = document.getElementById('monthlySuccessRate');
                successRate.textContent = `${data.monthly_stats.success_rate}% (${data.monthly_stats.completed_weeks}/${data.monthly_stats.total_weeks - 1} semanas)`;

                // Update success rate badge color based on performance
                successRate.classList.remove('bg-primary', 'bg-success', 'bg-warning', 'bg-danger');
                if (data.monthly_stats.success_rate >= 80) {
                    successRate.classList.add('bg-success');
                } else if (data.monthly_stats.success_rate >= 60) {
                    successRate.classList.add('bg-primary');
                } else if (data.monthly_stats.success_rate >= 40) {
                    successRate.classList.add('bg-warning');
                } else {
                    successRate.classList.add('bg-danger');
                }

                // Render weekly KPI cards
                const cardsContainer = document.getElementById('weeklyKpiCards');
                cardsContainer.innerHTML = data.weeks.map(week => {
                    const statusIcon = week.goal_met
                        ? '<i class="bi bi-check-circle-fill text-success fs-5"></i>'
                        : week.is_current
                            ? '<i class="bi bi-hourglass-split text-primary fs-5"></i>'
                            : '<i class="bi bi-x-circle-fill text-danger fs-5"></i>';

                    const cardClass = week.is_current
                        ? 'border-primary border-2'
                        : week.goal_met
                            ? 'border-success'
                            : 'border-secondary';

                    const bgClass = week.is_current
                        ? 'bg-primary bg-opacity-10'
                        : week.goal_met
                            ? 'bg-success bg-opacity-10'
                            : '';

                    return `
                        <div class="col-sm-6 col-lg-4 col-xl-2-4">
                            <div class="card ${cardClass} ${bgClass} h-100">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <small class="text-muted d-block">Semana ${week.week_number}</small>
                                            <strong class="d-block">${week.week_start} - ${week.week_end}</strong>
                                        </div>
                                        ${statusIcon}
                                    </div>
                                    <div class="mt-2">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <small class="text-muted">Progresso:</small>
                                            <span class="badge bg-secondary">${week.stores_verified}/${week.total_assigned}</span>
                                        </div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar ${week.goal_met ? 'bg-success' : 'bg-primary'}" 
                                                 role="progressbar" 
                                                 style="width: ${Math.min(week.percentage, 100)}%">
                                            </div>
                                        </div>
                                        <small class="text-muted d-block mt-1">${week.percentage.toFixed(1)}%</small>
                                    </div>
                                    ${week.is_current ? '<div class="mt-2"><span class="badge bg-primary w-100">EM ANDAMENTO</span></div>' : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            } else {
                kpiLoading.innerHTML = `
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        ${data.error || 'Erro ao carregar KPIs mensais'}
                    </div>
                `;
            }
        } catch (error) {
            console.error('Erro ao carregar KPIs:', error);
            kpiLoading.innerHTML = `
                <div class="alert alert-danger mb-0">
                    <i class="bi bi-x-circle me-2"></i>
                    Erro ao carregar dados de KPI
                </div>
            `;
        }
    }

    // Auto-load monthly KPI when page loads (for analysts)
    {% if user.role == 'analista' %}
    if (document.getElementById('monthlyKpiContent')) {
        loadMonthlyKPI();
    }

    // Load Daily Quota for analysts
    if (document.getElementById('dailyQuotaCard')) {
        loadDailyQuota();
        // Update every minute to refresh countdown
        setInterval(loadDailyQuota, 60000);
    }
    {% endif %}

    // Load Manager KPI Dashboard
    if (document.getElementById('managerKpiList')) {
        loadManagerKpiDashboard();
    }

    // Manager KPI Functions
    async function loadManagerKpiDashboard() {
        const loading = document.getElementById('managerKpiLoading');
        const content = document.getElementById('managerKpiContent');
        const listContainer = document.getElementById('managerKpiList');

        try {
            const response = await fetch('/api/store-verification/manager/all-analysts-kpi/');
            const data = await response.json();

            if (data.success) {
                renderManagerKpi(data.analysts, listContainer);
                loading.classList.add('d-none');
                content.classList.remove('d-none');
            } else {
                loading.innerHTML = `<p class="text-danger">Erro ao carregar dados: ${data.error}</p>`;
            }
        } catch (error) {
            console.error('Erro ao carregar KPI de gestor:', error);
            loading.innerHTML = `<p class="text-danger">Erro de conex√£o</p>`;
        }
    }

    function renderManagerKpi(analysts, container) {
        if (!analysts || analysts.length === 0) {
            container.innerHTML = '<div class="col-12"><p class="text-muted text-center">Nenhum analista com atribui√ß√µes encontrado.</p></div>';
            return;
        }

        let html = '';

        analysts.forEach(item => {
            const analyst = item.analyst;
            const stats = item.monthly_stats;
            const weeks = item.weeks;

            // Determine badge color based on success rate
            let badgeClass = 'bg-secondary';
            if (stats.success_rate >= 80) badgeClass = 'bg-success';
            else if (stats.success_rate >= 50) badgeClass = 'bg-warning text-dark';
            else badgeClass = 'bg-danger';

            // Generate weeks HTML small visualization
            let weeksHtml = '<div class="d-flex gap-1 mt-2">';
            weeks.forEach(week => {
                let color = 'bg-secondary bg-opacity-10'; // Future/unknown
                if (!week.is_current) {
                    if (week.goal_met) color = 'bg-success';
                    else color = 'bg-danger';
                } else {
                    color = 'bg-primary bg-opacity-75'; // Current
                }

                weeksHtml += `
                    <div data-bs-toggle="tooltip" title="Semana ${week.week_number}: ${week.stores_verified}/${week.total_assigned} (${week.percentage}%)" 
                         style="width: 20px; height: 20px; border-radius: 4px;" class="${color}"></div>
                `;
            });
            weeksHtml += '</div>';

            html += `
            <div class="col-md-6 col-lg-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="fw-bold mb-0 text-truncate" title="${analyst.name}">
                                <i class="bi bi-person-circle me-1 text-muted"></i> ${analyst.name}
                            </h6>
                            <span class="badge ${badgeClass}">${stats.success_rate}%</span>
                        </div>
                        
                        <div class="small text-muted mb-2">
                             Taxa de Sucesso Mensal
                             ${analyst.last_audit_date ? `<br><small class="text-primary"><i class="bi bi-clock-history me-1"></i>√öltima auditoria: ${analyst.last_audit_date}</small>` : '<br><small class="text-muted">Nenhuma auditoria recente</small>'}
                        </div>
                        
                        <div class="d-flex justify-content-between small mb-2 border-bottom pb-2">
                            <span>Metas Batidas: <strong>${stats.completed_weeks}/${stats.weeks_evaluated}</strong></span>
                            <span>Total Lojas: <strong>${weeks[weeks.length - 1].total_assigned}</strong></span> <!-- Using last week/current as proxy for total load -->
                        </div>
                        
                        ${weeksHtml}
                    </div>
                </div>
            </div>
            `;
        });

        container.innerHTML = html;

        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    }

    // Daily Quota Functions
    async function loadDailyQuota() {
        try {
            const response = await fetch('/api/store-verification/analyst/dashboard/');
            const data = await response.json();

            if (data.success && data.daily_quota) {
                const quota = data.daily_quota;

                // Update text displays
                document.getElementById('dailyQuotaText').textContent = `${quota.completed}/${quota.target}`;
                document.getElementById('dailyQuotaBadge').textContent = `${quota.remaining} restantes`;

                // Update progress bar
                const percentage = Math.min(100, quota.percentage);
                const progressBar = document.getElementById('dailyQuotaProgress');
                progressBar.style.width = `${percentage}%`;
                document.getElementById('dailyQuotaPercentage').textContent = `${percentage.toFixed(0)}%`;

                // Change color based on completion
                progressBar.classList.remove('bg-primary', 'bg-success', 'bg-warning');
                if (quota.is_blocked) {
                    progressBar.classList.add('bg-success');
                } else if (percentage >= 75) {
                    progressBar.classList.add('bg-warning');
                } else {
                    progressBar.classList.add('bg-primary');
                }

                // Show/hide blocked alert
                const blockedAlert = document.getElementById('dailyQuotaBlocked');
                const quotaCard = document.getElementById('dailyQuotaCard');

                if (quota.is_blocked) {
                    blockedAlert.classList.remove('d-none');
                    quotaCard.classList.add('border-success');
                    quotaCard.classList.remove('border-primary');

                    // Update countdown
                    document.getElementById('resetCountdown').textContent =
                        `${quota.hours_until_reset}h ${quota.minutes_until_reset}min`;

                    // Disable audit buttons (if they exist)
                    disableAuditButtons();
                } else {
                    blockedAlert.classList.add('d-none');
                    quotaCard.classList.remove('border-success');
                    quotaCard.classList.add('border-primary');
                }

                // RENDER WEEKLY SCHEDULE
                if (data.metrics && data.metrics.weekly_schedule) {
                    const scheduleList = document.getElementById('weeklyScheduleList');
                    if (scheduleList) {
                        scheduleList.innerHTML = data.metrics.weekly_schedule.map(day => {
                            let badgeClass = 'bg-secondary bg-opacity-10 text-muted';
                            let icon = '';

                            if (day.status === 'work') {
                                if (day.is_today) {
                                    badgeClass = 'bg-primary text-white shadow-sm';
                                    icon = '<i class="bi bi-briefcase-fill me-1"></i>';
                                } else {
                                    badgeClass = 'bg-primary text-white border border-primary';
                                }
                            } else {
                                // Folga
                                badgeClass = 'bg-secondary bg-opacity-25 text-secondary border border-secondary border-opacity-25';
                                icon = '<i class="bi bi-house-door me-1"></i>';
                            }

                            return `
                                <div class="text-center d-flex flex-column align-items-center" style="flex: 1;">
                                    <small class="d-block text-muted mb-1" style="font-size: 0.75rem;">${day.day_name.substring(0, 3)}</small>
                                    <span class="badge ${badgeClass} d-flex align-items-center justify-content-center" 
                                          style="height: 28px; min-width: 60px; font-weight: 500;"
                                          title="${day.status === 'work' ? 'Dia de Trabalho' : 'Folga'} - ${day.date}">
                                        ${icon}${day.date}
                                    </span>
                                </div>
                            `;
                        }).join('');
                    }
                }
            }
        } catch (error) {
            console.error('Error loading daily quota:', error);
        }
    }

    function disableAuditButtons() {
        // Disable main "Auditar Loja" buttons
        document.querySelectorAll('a[href*="/store-audit/"]').forEach(link => {
            if (!link.classList.contains('disabled')) {
                link.classList.add('disabled', 'quota-disabled');
                link.style.opacity = '0.5';
                link.style.pointerEvents = 'none';
                link.title = 'Limite di√°rio atingido - Aguarde at√© amanh√£';
            }
        });
    }
</script>

<!-- Modal: Liberar Mais Lojas (Override Quota) -->
<div class="modal fade" id="overrideQuotaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-unlock me-2"></i> Liberar Mais Lojas</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info bg-info bg-opacity-10 border-info border-opacity-25 small">
                    <i class="bi bi-info-circle me-1"></i>
                    Selecione as lojas que deseja liberar para <strong><span id="overrideAnalystName"></span></strong>
                    auditar HOJE, al√©m do limite di√°rio.
                </div>

                <h6 class="fw-bold mb-2">Lojas Dispon√≠veis para Libera√ß√£o</h6>
                <div class="list-group mb-3" id="overrideStoreList" style="max-height: 300px; overflow-y: auto;">
                    <!-- Preenchido via JS -->
                </div>

                <div class="d-flex justify-content-between align-items-center mt-3">
                    <span class="text-muted small">Selecionadas: <strong id="overrideSelectedCount">0</strong></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="submitOverride()">
                    <i class="bi bi-check-circle me-1"></i> Confirmar e Liberar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let selectedOverrideStores = new Set();

    function openOverrideModal() {
        if (!currentAnalystForOverride) {
            // Tenta pegar do DOM se a vari√°vel global falhou (ex: reload)
            const nameEl = document.getElementById('analystModalName');
            if (nameEl && nameEl.textContent !== 'Analista') {
                // Estamos numa situa√ß√£o de fallback, mas sem o objeto 'analyst' completo (com lista de lojas)
                // n√£o podemos prosseguir.
                alert('Erro: Dados do analista n√£o carregados. Por favor, reabra o detalhe do analista.');
                return;
            }
            alert('Erro ao identificar analista.');
            return;
        }

        document.getElementById('overrideAnalystName').textContent = currentAnalystForOverride.name;
        const listContainer = document.getElementById('overrideStoreList');
        listContainer.innerHTML = '';
        selectedOverrideStores.clear();
        updateOverrideCount();

        // Preparar lista de lojas
        // Filtrar e ordenar: Irregular > Pendente > Conforme (mas permitir todas)
        const stores = [...currentAnalystForOverride.stores].sort((a, b) => {
            const statusOrder = { 'Irregular': 1, 'Pendente': 2, 'Conforme': 3 };
            const sA = statusOrder[a.status] || 9;
            const sB = statusOrder[b.status] || 9;
            return sA - sB;
        });

        if (stores.length === 0) {
            listContainer.innerHTML = '<div class="text-center p-3 text-muted">Nenhuma loja atribu√≠da.</div>';
        } else {
            stores.forEach(store => {
                const item = document.createElement('div'); // Div wrapper
                item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center cursor-pointer';
                item.style.cursor = 'pointer';

                // Determine icon and color
                let statusIcon = '';
                let statusClass = '';

                if (store.status === 'Conforme') {
                    statusIcon = '<i class="bi bi-check-circle text-success ms-2"></i>';
                    statusClass = 'text-success';
                } else if (store.status === 'Irregular') {
                    statusIcon = '<i class="bi bi-exclamation-triangle text-danger ms-2"></i>';
                    statusClass = 'text-danger';
                } else {
                    statusIcon = '<i class="bi bi-hourglass text-muted ms-2"></i>';
                    statusClass = 'text-secondary';
                }

                item.innerHTML = `
                    <div>
                        <span class="fw-bold">${store.code}</span>
                        <small class="text-muted ms-2">${store.city || ''}</small>
                        ${statusIcon}
                    </div>
                    <div class="form-check pointer-events-none">
                        <input class="form-check-input" type="checkbox" value="${store.id}" style="pointer-events: none;">
                    </div>
                `;

                // Click handler on the whole item
                item.onclick = (e) => {
                    e.preventDefault();
                    toggleStoreSelection(store.id, item);
                };

                listContainer.appendChild(item);
            });
        }

        new bootstrap.Modal(document.getElementById('overrideQuotaModal')).show();
    }

    function toggleStoreSelection(storeId, element) {
        const checkbox = element.querySelector('input[type="checkbox"]');

        if (selectedOverrideStores.has(storeId)) {
            selectedOverrideStores.delete(storeId);
            element.classList.remove('active', 'bg-light');
            checkbox.checked = false;
        } else {
            selectedOverrideStores.add(storeId);
            element.classList.add('active', 'bg-light');
            checkbox.checked = true;
        }
        updateOverrideCount();
    }

    function updateOverrideCount() {
        document.getElementById('overrideSelectedCount').textContent = selectedOverrideStores.size;
    }

    async function submitOverride() {
        if (selectedOverrideStores.size === 0) {
            alert('Selecione pelo menos uma loja para liberar.');
            return;
        }

        const storeIds = Array.from(selectedOverrideStores);
        const submitBtn = document.querySelector('#overrideQuotaModal .btn-primary');
        const originalText = submitBtn.innerHTML;

        try {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Processando...';

            const cookies = document.cookie.split(';');
            let csrftoken = null;
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, 10) === ('csrftoken=')) {
                    csrftoken = decodeURIComponent(cookie.substring(10));
                    break;
                }
            }

            const response = await fetch('/api/store-verification/analyst/override-quota/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Csrftoken': csrftoken
                },
                body: JSON.stringify({
                    analyst_id: currentAnalystForOverride.id,
                    store_ids: storeIds
                })
            });

            const data = await response.json();

            if (data.success) {
                // Show success message (using alert for simplicity, or showToast if available)
                if (typeof showToast === 'function') {
                    showToast('success', data.message);
                } else {
                    alert(data.message);
                }

                bootstrap.Modal.getInstance(document.getElementById('overrideQuotaModal')).hide();

                // Refresh analyst overview to update quotas
                if (typeof loadAnalystOverview === 'function') {
                    setTimeout(() => loadAnalystOverview(), 1000);
                }

                // Also close the detail modal to force refresh when reopening? 
                // bootstrap.Modal.getInstance(document.getElementById('analystDetailModal')).hide();

            } else {
                if (typeof showToast === 'function') {
                    showToast('error', 'Erro: ' + (data.error || 'Erro desconhecido'));
                } else {
                    alert('Erro: ' + (data.error || 'Erro desconhecido'));
                }
            }

        } catch (error) {
            console.error('Error submitting override:', error);
            alert('Erro de conex√£o ao tentar liberar lojas.');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    }
</script>

{% endblock %}
{# validation fix 2 #}