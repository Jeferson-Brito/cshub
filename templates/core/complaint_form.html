{% extends 'base.html' %}
{% load static %}

{% block title %}{% if complaint %}Editar{% else %}Nova{% endif %} Reclamação - Nexus{% endblock %}

{% block content %}
<div class="page-header fade-in">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h1 class="page-title">
                <i class="bi bi-{% if complaint %}pencil{% else %}plus-circle{% endif %}"></i>
                {% if complaint %}Editar{% else %}Nova{% endif %} Reclamação
            </h1>
            <p class="page-subtitle">
                {% if complaint %}Atualize as informações da reclamação{% else %}Preencha os dados para criar uma nova
                reclamação{% endif %}
            </p>
        </div>
        <div class="col-md-4 text-md-end text-start mt-3 mt-md-0">
            <a href="{% if complaint %}{% url 'complaint_detail' complaint.pk %}{% else %}{% url 'complaint_list' %}{% endif %}"
                class="btn btn-secondary">
                <i class="bi bi-x-circle"></i> Cancelar
            </a>
        </div>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-lg-10">
        <form method="post" class="complaint-form fade-in">
            {% csrf_token %}

            <!-- Seção 1: Informações Básicas -->
            <div class="form-section card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle"></i> Informações Básicas
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="bi bi-hash"></i> ID RA <span class="text-danger">*</span>
                            </label>
                            {{ form.id_ra }}
                            {% if form.id_ra.errors %}
                            <div class="text-danger small">{{ form.id_ra.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="bi bi-tag"></i> Status
                            </label>
                            {{ form.status }}
                            {% if form.status.errors %}
                            <div class="text-danger small">{{ form.status.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seção 2: Dados do Cliente -->
            <div class="form-section card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-person"></i> Dados do Cliente
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="bi bi-credit-card"></i> CPF <span class="text-danger">*</span>
                            </label>
                            {{ form.cpf_cliente }}
                            {% if form.cpf_cliente.errors %}
                            <div class="text-danger small">{{ form.cpf_cliente.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">
                                <i class="bi bi-person"></i> Nome e Sobrenome <span class="text-danger">*</span>
                            </label>
                            {{ form.nome_cliente }}
                            {% if form.nome_cliente.errors %}
                            <div class="text-danger small">{{ form.nome_cliente.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="bi bi-envelope"></i> E-mail <span class="text-danger">*</span>
                            </label>
                            {{ form.email_cliente }}
                            {% if form.email_cliente.errors %}
                            <div class="text-danger small">{{ form.email_cliente.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="bi bi-telephone"></i> Telefone <span class="text-danger">*</span>
                            </label>
                            {{ form.telefone }}
                            {% if form.telefone.errors %}
                            <div class="text-danger small">{{ form.telefone.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seção 3: Informações da Loja -->
            <div class="form-section card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-shop"></i> Informações da Loja
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="bi bi-shop"></i> Código da Loja <span class="text-danger">*</span>
                            </label>
                            {{ form.loja_cod }}
                            {% if form.loja_cod.errors %}
                            <div class="text-danger small">{{ form.loja_cod.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="bi bi-telephone-inbound"></i> Origem do Contato <span
                                    class="text-danger">*</span>
                            </label>
                            {{ form.origem_contato }}
                            {% if form.origem_contato.errors %}
                            <div class="text-danger small">{{ form.origem_contato.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="bi bi-tag-fill"></i> Tipo de Reclamação <span class="text-danger">*</span>
                            </label>
                            {{ form.tipo_reclamacao }}
                            {% if form.tipo_reclamacao.errors %}
                            <div class="text-danger small">{{ form.tipo_reclamacao.errors }}</div>
                            {% endif %}
                        </div>
                        {% if user.is_gestor or user.is_administrador %}
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="bi bi-person-badge"></i> Responsável <span class="text-danger">*</span>
                            </label>
                            {{ form.analista }}
                            {% if form.analista.errors %}
                            <div class="text-danger small">{{ form.analista.errors }}</div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Seção 4: Descrição -->
            <div class="form-section card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-chat-left-text"></i> Descrição da Reclamação
                    </h5>
                </div>
                <div class="card-body">
                    <label class="form-label">
                        <i class="bi bi-file-text"></i> Descrição
                    </label>
                    {{ form.descricao }}
                    {% if form.descricao.errors %}
                    <div class="text-danger small">{{ form.descricao.errors }}</div>
                    {% endif %}
                    <small class="text-muted">Adicione aqui a reclamação que o cliente fez no Reclame Aqui</small>
                </div>
            </div>

            <!-- Seção 5: Datas e Avaliação (Opcional) -->
            <div class="form-section card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-calendar-check"></i> Datas e Avaliação
                        <small class="text-muted">(Opcional)</small>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">
                                <i class="bi bi-calendar-event"></i> Data da Reclamação <span
                                    class="text-danger">*</span>
                            </label>
                            {{ form.data_reclamacao }}
                            {% if form.data_reclamacao.errors %}
                            <div class="text-danger small">{{ form.data_reclamacao.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">
                                <i class="bi bi-calendar-check"></i> Data de Resposta
                            </label>
                            {{ form.data_resposta }}
                            {% if form.data_resposta.errors %}
                            <div class="text-danger small">{{ form.data_resposta.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">
                                <i class="bi bi-star"></i> Nota de Satisfação (0 a 10)
                            </label>
                            {{ form.nota_satisfacao }}
                            {% if form.nota_satisfacao.errors %}
                            <div class="text-danger small">{{ form.nota_satisfacao.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">
                                <i class="bi bi-arrow-repeat"></i> Voltaria a Fazer Negócios?
                            </label>
                            {{ form.volta_fazer_negocio }}
                            {% if form.volta_fazer_negocio.errors %}
                            <div class="text-danger small">{{ form.volta_fazer_negocio.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-12">
                            <label class="form-label">
                                <i class="bi bi-chat-quote"></i> Feedback do Cliente
                            </label>
                            {{ form.feedback_text }}
                            {% if form.feedback_text.errors %}
                            <div class="text-danger small">{{ form.feedback_text.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botões de Ação -->
            <div class="form-actions card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                        <a href="{% if complaint %}{% url 'complaint_detail' complaint.pk %}{% else %}{% url 'complaint_list' %}{% endif %}"
                            class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-check-circle"></i> {% if complaint %}Salvar Alterações{% else %}Criar
                            Reclamação{% endif %}
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Função para formatar CPF
    function formatCPF(value) {
        // Remove tudo que não é número
        const numbers = value.replace(/\D/g, '');

        // Limita a 11 dígitos
        const limited = numbers.substring(0, 11);

        // Aplica a máscara
        if (limited.length <= 3) {
            return limited;
        } else if (limited.length <= 6) {
            return limited.substring(0, 3) + '.' + limited.substring(3);
        } else if (limited.length <= 9) {
            return limited.substring(0, 3) + '.' + limited.substring(3, 6) + '.' + limited.substring(6);
        } else {
            return limited.substring(0, 3) + '.' + limited.substring(3, 6) + '.' + limited.substring(6, 9) + '-' + limited.substring(9, 11);
        }
    }

    // Função para remover formatação do CPF (apenas números)
    function unformatCPF(value) {
        return value.replace(/\D/g, '');
    }

    // Adicionar classes aos campos do formulário e formatar CPF
    document.addEventListener('DOMContentLoaded', function () {
        const inputs = document.querySelectorAll('.complaint-form input, .complaint-form select, .complaint-form textarea');
        inputs.forEach(input => {
            if (!input.classList.contains('form-control')) {
                input.classList.add('form-control');
            }
        });

        // Formatar CPF no campo de entrada
        const cpfInput = document.querySelector('#id_cpf_cliente');
        if (cpfInput) {
            // Formatar ao digitar
            cpfInput.addEventListener('input', function (e) {
                const cursorPosition = e.target.selectionStart;
                const oldValue = e.target.value;
                const formatted = formatCPF(e.target.value);
                e.target.value = formatted;

                // Ajustar posição do cursor
                const newCursorPosition = cursorPosition + (formatted.length - oldValue.length);
                e.target.setSelectionRange(newCursorPosition, newCursorPosition);
            });

            // Formatar ao perder o foco (garantir formatação completa)
            cpfInput.addEventListener('blur', function (e) {
                const numbers = unformatCPF(e.target.value);
                if (numbers.length === 11) {
                    e.target.value = formatCPF(numbers);
                }
            });

            // Remover formatação antes de enviar o formulário
            const form = cpfInput.closest('form');
            if (form) {
                form.addEventListener('submit', function (e) {
                    cpfInput.value = unformatCPF(cpfInput.value);
                });
            }

            // Formatar valor inicial se já existir
            if (cpfInput.value) {
                const numbers = unformatCPF(cpfInput.value);
                if (numbers.length === 11) {
                    cpfInput.value = formatCPF(numbers);
                }
            }
        }
    });
</script>
{% endblock %}