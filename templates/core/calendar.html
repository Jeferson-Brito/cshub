{% extends "base.html" %}
{% load static %}

{% block title %}Calendário - GRS{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/calendar.css' %}">
<style>
    .calendar-container {
        margin-top: 0;
    }

    .btn-icon {
        background: transparent;
    }

    /* Estilo para log de erro se houver */
    #js-error-log {
        display: none;
        background: #fee2e2;
        color: #991b1b;
        padding: 1rem;
        margin: 1rem;
        border-radius: 0.5rem;
        border: 1px solid #f87171;
        font-family: monospace;
        white-space: pre-wrap;
    }
</style>
{% endblock %}

{% block content %}
<div class="calendar-container h-100" id="calendar-app" data-can-edit="{% if can_edit %}true{% else %}false{% endif %}"
    data-user-id="{{ user_id|default:0 }}" data-user-name="{{ user_full_name }}"
    data-is-manager="{% if is_manager %}true{% else %}false{% endif %}">
    <div id="js-error-log"></div>

    <!-- Header -->
    <div class="calendar-header">
        <h1>Calendário</h1>
        <div class="calendar-controls">
            <div class="calendar-nav-group">
                <button class="calendar-btn" id="prev-month" title="Mês anterior">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <button class="calendar-btn today-btn" id="go-today">
                    Hoje
                </button>
                <button class="calendar-btn" id="next-month" title="Próximo mês">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
            <h2 class="calendar-month-year" id="current-month-year">
                Carregando...
            </h2>
            <div class="calendar-actions">
                {% if can_edit %}
                <button class="btn-add-event" id="btn-add-event">
                    <i class="bi bi-plus-lg"></i>
                    Adicionar Evento
                </button>
                {% endif %}
                <button class="btn-view-events" id="btn-view-all">
                    <i class="bi bi-list-ul"></i>
                    Ver Todos
                </button>
            </div>
        </div>
    </div>

    <div class="calendar-wrapper">
        <!-- Grid do Calendário -->
        <div class="calendar-grid">
            <div class="calendar-weekdays">
                <div class="calendar-weekday">Dom</div>
                <div class="calendar-weekday">Seg</div>
                <div class="calendar-weekday">Ter</div>
                <div class="calendar-weekday">Qua</div>
                <div class="calendar-weekday">Qui</div>
                <div class="calendar-weekday">Sex</div>
                <div class="calendar-weekday">Sáb</div>
            </div>
            <div class="calendar-days" id="calendar-days">
                <!-- Dias serão inseridos via JS -->
            </div>
        </div>

        <!-- Legenda e Feriados -->
        <div class="calendar-legend">
            <h3 id="holiday-title">Feriados</h3>
            <div class="holidays-list" id="holidays-list">
                <!-- Feriados inseridos via JS -->
            </div>
        </div>
    </div>
</div>

<!-- Modal de Formulário de Evento -->
<div class="calendar-modal-overlay d-none" id="event-modal">
    <div class="calendar-modal">
        <div class="calendar-modal-header">
            <h2 id="modal-title">Novo Evento</h2>
            <button class="btn-close" id="close-event-modal"></button>
        </div>
        <div class="calendar-modal-body">
            <form id="event-form">
                <input type="hidden" id="event-id">
                <div class="mb-3">
                    <label for="titulo" class="form-label">Título *</label>
                    <input type="text" class="form-control" id="titulo" required
                        placeholder="Ex: Reunião, Agendamento...">
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="data_inicio" class="form-label">Data *</label>
                        <input type="date" class="form-control" id="data_inicio" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label d-block text-uppercase small fw-bold text-muted">Horário</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="form-label small text-muted text-uppercase mb-1">Início</label>
                                <div class="custom-timepicker-container">
                                    <input type="text" class="custom-timepicker-input" id="horario" name="horario"
                                        placeholder="--:--" readonly>
                                </div>
                            </div>
                            <div class="col-6">
                                <label class="form-label small text-muted text-uppercase mb-1">Fim</label>
                                <div class="custom-timepicker-container">
                                    <input type="text" class="custom-timepicker-input" id="horario_fim"
                                        name="horario_fim" placeholder="--:--" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="tipo" class="form-label">Tipo</label>
                        <select class="form-control" id="tipo">
                            <option value="agendamento">Agendamento</option>
                            <option value="reuniao">Reunião</option>
                            <option value="visita">Visita</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="codigo_loja" class="form-label">Código da Loja</label>
                        <input type="text" class="form-control" id="codigo_loja" placeholder="Ex: PB05">
                    </div>
                </div>
                <div class="mb-3">
                    <label for="analista_nome" class="form-label">Analista</label>
                    <input type="text" class="form-control" id="analista_nome" placeholder="Nome do responsável"
                        list="analistas-list">
                    <datalist id="analistas-list"></datalist>
                </div>
                <div class="mb-3">
                    <label for="descricao" class="form-label">Descrição</label>
                    <textarea class="form-control" id="descricao" rows="3"></textarea>
                </div>
                <div class="d-flex justify-content-end gap-2 mt-4">
                    <button type="button" class="btn btn-light" id="cancel-event">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="save-event">Salvar Evento</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Listagem de Eventos -->
<div class="calendar-modal-overlay d-none" id="list-modal">
    <div class="calendar-modal large">
        <div class="calendar-modal-header">
            <h2 id="list-modal-title">Todos os Eventos</h2>
            <button class="btn-close" id="close-list-modal"></button>
        </div>
        <div class="calendar-modal-body">
            <div class="events-list" id="events-list-container">
                <!-- Eventos inseridos via JS -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Função global de erro
    window.onerror = function (msg, url, line, col, error) {
        const errorLog = document.getElementById('js-error-log');
        if (errorLog) {
            errorLog.style.display = 'block';
            errorLog.textContent = `Erro JS: ${msg}\nLinha: ${line}, Col: ${col}\n${error ? error.stack : ''}`;
        }
        return false;
    };

    document.addEventListener('DOMContentLoaded', function () {
        try {
            console.log('Iniciando calendário...');
            let currentDate = new Date();
            let events = [];
            const appConfig = document.getElementById('calendar-app').dataset;
            const canEdit = appConfig.canEdit === 'true';
            const currentUserId = parseInt(appConfig.userId || '0');
            const currentUserName = appConfig.userName || '';
            const isManager = appConfig.isManager === 'true';

            const monthNames = [
                'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];

            // --- Lógica de Feriados ---
            function getHolidays(year) {
                const holidays = [
                    { day: 1, month: 0, name: 'Confraternização Universal' },
                    { day: 21, month: 3, name: 'Tiradentes' },
                    { day: 1, month: 4, name: 'Dia do Trabalhador' },
                    { day: 7, month: 8, name: 'Independência do Brasil' },
                    { day: 12, month: 9, name: 'Nossa Senhora Aparecida' },
                    { day: 2, month: 10, name: 'Finados' },
                    { day: 15, month: 10, name: 'Proclamação da República' },
                    { day: 20, month: 10, name: 'Consciência Negra' },
                    { day: 25, month: 11, name: 'Natal' },
                ];

                const a = year % 19;
                const b = Math.floor(year / 100);
                const c = year % 100;
                const d = Math.floor(b / 4);
                const e = b % 4;
                const f = Math.floor((b + 8) / 25);
                const g = Math.floor((b - f + 1) / 3);
                const h = (19 * a + b - d - g + 15) % 30;
                const i = Math.floor(c / 4);
                const k = c % 4;
                const l = (32 + 2 * e + 2 * i - h - k) % 7;
                const m = Math.floor((a + 11 * h + 22 * l) / 451);
                const month = Math.floor((h + l - 7 * m + 114) / 31), day = ((h + l - 7 * m + 114) % 31) + 1;
                const easter = new Date(year, month - 1, day);
                const carnival = new Date(easter); carnival.setDate(easter.getDate() - 47);
                const goodFriday = new Date(easter); goodFriday.setDate(easter.getDate() - 2);
                const corpusChristi = new Date(easter); corpusChristi.setDate(easter.getDate() + 60);

                holidays.push(
                    { day: carnival.getDate(), month: carnival.getMonth(), name: 'Carnaval' },
                    { day: goodFriday.getDate(), month: goodFriday.getMonth(), name: 'Sexta-feira Santa' },
                    { day: easter.getDate(), month: easter.getMonth(), name: 'Páscoa' },
                    { day: corpusChristi.getDate(), month: corpusChristi.getMonth(), name: 'Corpus Christi' }
                );
                return holidays;
            }

            // --- Renderização ---
            function renderCalendar() {
                try {
                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    const firstDay = new Date(year, month, 1).getDay();
                    const holidays = getHolidays(year);
                    const today = new Date();

                    const titleEl = document.getElementById('current-month-year');
                    if (titleEl) titleEl.textContent = `${monthNames[month]} ${year}`;

                    const holidayTitleEl = document.getElementById('holiday-title');
                    if (holidayTitleEl) holidayTitleEl.textContent = `Feriados de ${monthNames[month]}`;

                    const grid = document.getElementById('calendar-days');
                    if (!grid) {
                        console.error('Grid calendar-days not found');
                        return;
                    }
                    grid.innerHTML = '';

                    // Espaços vazios
                    for (let i = 0; i < firstDay; i++) {
                        const empty = document.createElement('div');
                        empty.className = 'calendar-day empty';
                        grid.appendChild(empty);
                    }

                    // Dias do mês
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dayEl = document.createElement('div');
                        const isHoliday = holidays.find(h => h.day === day && h.month === month);
                        const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();
                        const dayEvents = events.filter(e => {
                            const d = new Date(e.data_inicio);
                            return d.getDate() === day && d.getMonth() === month && d.getFullYear() === year;
                        });

                        dayEl.className = `calendar-day ${isHoliday ? 'holiday' : ''} ${isToday ? 'today' : ''} ${dayEvents.length > 0 ? 'has-events' : ''}`;
                        if (isHoliday) dayEl.title = isHoliday.name;

                        dayEl.innerHTML = `<span class="day-number">${day}</span>`;
                        if (isHoliday) dayEl.innerHTML += `<span class="holiday-indicator"><i class="bi bi-star-fill"></i></span>`;

                        if (dayEvents.length > 0) {
                            const indicator = document.createElement('div');
                            indicator.className = 'events-indicator';
                            dayEvents.slice(0, 3).forEach(() => {
                                const dot = document.createElement('div');
                                dot.className = 'event-dot';
                                indicator.appendChild(dot);
                            });
                            if (dayEvents.length > 3) {
                                indicator.innerHTML += `<span class="more-events">+${dayEvents.length - 3}</span>`;
                            }
                            dayEl.appendChild(indicator);
                        }

                        // Event listener corrigido
                        dayEl.addEventListener('click', function () {
                            if (dayEvents.length > 0) {
                                showDayEvents(day, month, year, dayEvents);
                            } else if (canEdit) {
                                openAddModal(new Date(year, month, day));
                            }
                        });

                        grid.appendChild(dayEl);
                    }

                    // Renderizar Lista Feriados
                    const holidayList = document.getElementById('holidays-list');
                    if (holidayList) {
                        holidayList.innerHTML = '';
                        const monthHolidays = holidays.filter(h => h.month === month).sort((a, b) => a.day - b.day);

                        if (monthHolidays.length === 0) {
                            holidayList.innerHTML = '<p class="no-holidays small text-muted">Nenhum feriado neste mês</p>';
                        } else {
                            monthHolidays.forEach(h => {
                                const item = document.createElement('div');
                                item.className = 'holiday-item';
                                item.innerHTML = `
                                    <i class="bi bi-star-fill"></i>
                                    <span class="holiday-date">${String(h.day).padStart(2, '0')}/${String(h.month + 1).padStart(2, '0')}</span>
                                    <span class="holiday-name">${h.name}</span>
                                `;
                                holidayList.appendChild(item);
                            });
                        }
                    }
                } catch (e) {
                    console.error('Erro no renderCalendar:', e);
                    throw e;
                }
            }

            // --- Async Load ---
            async function loadEvents() {
                renderCalendar(); // Renderiza vazio primeiro

                // Carregar analistas
                try {
                    const res = await fetch('/api/eventos/users/');
                    if (res.ok) {
                        const data = await res.json();
                        const datalist = document.getElementById('analistas-list');
                        if (datalist && data.length) {
                            // Adiciona opção "Todos os Analistas" no início
                            const allOption = '<option value="Todos os Analistas">';
                            datalist.innerHTML = allOption + data.map(a => `<option value="${a.nome}">`).join('');
                        }
                    }
                } catch (err) {
                    console.warn('Erro ao carregar analistas (não crítico):', err);
                }

                // Carregar eventos
                try {
                    const response = await fetch('/api/eventos/');
                    if (response.ok) {
                        events = await response.json();
                        renderCalendar();
                    } else {
                        console.error('Erro API Eventos:', response.status);
                    }
                } catch (error) {
                    console.error('Erro fetch eventos:', error);
                }
            }

            // --- Modais e Ações ---
            // (Funções auxiliares mantidas, apenas verificação de existencia)
            function openAddModal(date) {
                const title = document.getElementById('modal-title');
                if (title) title.textContent = 'Novo Evento';
                document.getElementById('event-id').value = '';
                document.getElementById('event-form').reset();
                if (date) {
                    // Ajuste para fuso horário local
                    const offset = date.getTimezoneOffset();
                    const localDate = new Date(date.getTime() - (offset * 60 * 1000));
                    document.getElementById('data_inicio').value = localDate.toISOString().split('T')[0];
                }
                const modal = document.getElementById('event-modal');
                if (modal) modal.classList.remove('d-none');

                // Configurar campo de analista
                const analistaInput = document.getElementById('analista_nome');
                if (!isManager) {
                    // Se não for gestor, trava o campo com o nome do usuário
                    analistaInput.value = currentUserName;
                    analistaInput.disabled = true;
                    analistaInput.classList.add('bg-light');
                } else {
                    analistaInput.value = ''; // Limpa para gestor escolher
                    analistaInput.disabled = false;
                    analistaInput.classList.remove('bg-light');
                }
            }

            function openEditModal(event) {
                const title = document.getElementById('modal-title');
                if (title) title.textContent = 'Editar Evento';
                document.getElementById('event-id').value = event.id;
                document.getElementById('titulo').value = event.titulo || '';

                // Formatar data para o input date
                if (event.data_inicio) {
                    document.getElementById('data_inicio').value = event.data_inicio.split('T')[0];
                }

                document.getElementById('horario').value = event.horario || '';
                document.getElementById('tipo').value = event.tipo || 'agendamento';
                document.getElementById('codigo_loja').value = event.codigo_loja || '';
                const analistaInput = document.getElementById('analista_nome');
                if (!isManager) {
                    // Analista só pode ver seu nome (e já deve ser ele mesmo se ele pode editar)
                    analistaInput.value = currentUserName;
                    analistaInput.disabled = true;
                    analistaInput.classList.add('bg-light');
                } else {
                    // Gestor pode mudar
                    analistaInput.value = event.analista_nome || '';
                    analistaInput.disabled = false;
                    analistaInput.classList.remove('bg-light');
                }

                const modal = document.getElementById('event-modal');
                if (modal) modal.classList.remove('d-none');

                // Fechar o modal de listagem se estiver aberto
                const listModal = document.getElementById('list-modal');
                if (listModal) listModal.classList.add('d-none');
            }

            function showDayEvents(day, month, year, dayEvents) {
                const container = document.getElementById('events-list-container');
                const title = document.getElementById('list-modal-title');
                if (title) title.textContent = `Eventos em ${day}/${month + 1}/${year}`;
                if (container) {
                    container.innerHTML = '';
                    dayEvents.forEach(e => {
                        const item = document.createElement('div');
                        item.className = 'event-item';
                        item.innerHTML = `
                            <div class="event-item-date">
                                <span class="event-day">${day}</span>
                                <span class="event-month">${monthNames[month].substring(0, 3)}</span>
                            </div>
                            <div class="event-item-content">
                                <h4>${e.titulo}</h4>
                                <div class="event-item-details">
                                    ${e.horario ? `<span><i class="bi bi-clock"></i> ${e.horario}</span>` : ''}
                                    <span class="event-type-badge">${e.tipo}</span>
                                </div>
                                ${e.descricao ? `<p class="mb-0 text-muted small">${e.descricao}</p>` : ''}
                            </div>
                        `;
                        const userCanManage = isManager || (e.usuario_id === currentUserId);

                        if (userCanManage) {
                            const actions = document.createElement('div');
                            actions.className = 'event-item-actions';
                            actions.innerHTML = `
                                <button class="btn-icon edit edit-btn" title="Editar"><i class="bi bi-pencil"></i></button>
                                <button class="btn-icon delete delete-btn" title="Excluir"><i class="bi bi-trash"></i></button>
                            `;
                            actions.querySelector('.edit-btn').onclick = () => openEditModal(e);
                            actions.querySelector('.delete-btn').onclick = () => deleteEvent(e.id);
                            item.appendChild(actions);
                        }
                        container.appendChild(item);
                    });
                }
                const modal = document.getElementById('list-modal');
                if (modal) modal.classList.remove('d-none');
            }

            async function deleteEvent(id) {
                if (!confirm('Deseja realmente excluir este evento?')) return;
                try {
                    const response = await fetch(`/api/eventos/${id}/`, {
                        method: 'DELETE',
                        headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                    });
                    if (response.ok) {
                        document.getElementById('list-modal').classList.add('d-none');
                        loadEvents();
                    }
                } catch (error) {
                    console.error('Erro ao excluir:', error);
                }
            }

            // Event Listeners (com Checks)
            const prev = document.getElementById('prev-month');
            if (prev) prev.onclick = () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); };

            const next = document.getElementById('next-month');
            if (next) next.onclick = () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); };

            const todayBtn = document.getElementById('go-today');
            if (todayBtn) todayBtn.onclick = () => { currentDate = new Date(); renderCalendar(); };

            const addBtn = document.getElementById('btn-add-event');
            if (addBtn && canEdit) addBtn.onclick = () => openAddModal();

            const closeEvent = document.getElementById('close-event-modal');
            if (closeEvent) closeEvent.onclick = () => document.getElementById('event-modal').classList.add('d-none');

            const cancelEvent = document.getElementById('cancel-event');
            if (cancelEvent) cancelEvent.onclick = () => document.getElementById('event-modal').classList.add('d-none');

            const closeList = document.getElementById('close-list-modal');
            if (closeList) closeList.onclick = () => document.getElementById('list-modal').classList.add('d-none');

            document.querySelectorAll('.calendar-modal-overlay').forEach(overlay => {
                overlay.onclick = (e) => { if (e.target === overlay) overlay.classList.add('d-none'); };
            });

            const form = document.getElementById('event-form');
            if (form) form.onsubmit = async (e) => {
                e.preventDefault();
                const id = document.getElementById('event-id').value;
                const data = {
                    titulo: document.getElementById('titulo').value,
                    data_inicio: document.getElementById('data_inicio').value,
                    horario: document.getElementById('horario').value,
                    tipo: document.getElementById('tipo').value,
                    codigo_loja: document.getElementById('codigo_loja').value,
                    analista_nome: document.getElementById('analista_nome').value,
                    descricao: document.getElementById('descricao').value,
                };

                const url = id ? `/api/eventos/${id}/` : '/api/eventos/create/';
                const method = id ? 'PUT' : 'POST';

                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                        body: JSON.stringify(data)
                    });
                    if (response.ok) {
                        document.getElementById('event-modal').classList.add('d-none');
                        loadEvents();
                    }
                } catch (error) {
                    console.error('Erro ao salvar:', error);
                }
            };

            // INICIALIZAR
            loadEvents();

        } catch (globalErr) {
            console.error('Erro fatal no script do calendário:', globalErr);
            const log = document.getElementById('js-error-log');
            if (log) {
                log.style.display = 'block';
                log.textContent = 'Erro fatal: ' + globalErr.message;
            }
        }
    });
</script>
{% endblock %}