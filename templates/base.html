<!DOCTYPE html>
{% load static %}
{% load user_tags %}
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Nexus{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="{% static 'img/favicon.png' %}">
    <link rel="stylesheet" href="{% static 'css/style.css' %}?v=15.4">
    <link rel="stylesheet" href="{% static 'css/custom_timepicker.css' %}">


    <!-- EasyMDE -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
    <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>

    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    {% block extra_css %}{% endblock %}


    <style>
        .editor-toolbar {
            border-radius: 8px 8px 0 0 !important;
            border-color: #e5e7eb !important;
            background-color: #f9fafb !important;
        }

        .CodeMirror {
            border-radius: 0 0 8px 8px !important;
            border-color: #e5e7eb !important;
            min-height: 150px !important;
        }
    </style>
</head>

<body>
    {% if user.is_authenticated %}


    <!-- Mobile Toggle Navbar -->
    <nav class="mobile-navbar d-lg-none">
        <div class="mobile-navbar-container">
            <div class="brand-full">
                <!-- Mobile Logo -->
                <span class="brand-grs">Nexus</span>
            </div>
            <button class="mobile-toggle" id="mobileToggle">
                <i class="bi bi-list"></i>
            </button>
        </div>
    </nav>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar Vertical -->

    <div class="sidebar" id="sidebar">
        <!-- Logo -->
        <!-- Logo (Moved to Top Header) -->
        <div class="sidebar-header d-none">
            <!-- Logo hidden in sidebar -->
        </div>

        <button type="button" class="sidebar-toggle" id="sidebarToggle">
            <i class="bi bi-chevron-left"></i>
        </button>

        {% if user.is_administrador %}
        {% if all_departments %}
        <div class="sidebar-dept-selector">
            <div class="dept-label text-center">Departamento:</div>
            <div class="dropdown">
                <button class="btn btn-dept-select dropdown-toggle d-flex align-items-center justify-content-center"
                    type="button" data-bs-toggle="dropdown" aria-expanded="false" data-bs-boundary="viewport">
                    <i class="bi bi-diagram-3"></i>
                    <span class="dept-name">
                        {% if current_department %}
                        {{ current_department.name }}
                        {% else %}
                        Global
                        {% endif %}
                    </span>
                </button>
                <ul class="dropdown-menu dropdown-menu-dark">
                    <li>
                        <hr class="dropdown-divider">
                    </li>
                    {% for dept in all_departments %}
                    <li>
                        <a class="dropdown-item {% if current_department.id == dept.id %}active{% endif %}"
                            href="{% url 'change_department' dept.id %}">
                            {{ dept.name }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}
        {% else %}
        {% if user.department %}
        <div class="sidebar-dept-selector no-dropdown">
            <div class="dept-label text-center">Departamento:</div>
            <div class="btn btn-dept-select disabled text-center w-100 opacity-100"
                style="cursor: default; border-color: rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-diagram-3"></i>
                <span class="dept-name ms-2">{{ user.department.name }}</span>
            </div>
        </div>
        {% endif %}
        {% endif %}

        <!-- Menu de NavegaÃ§Ã£o -->
        <nav class="sidebar-nav">
            {% if current_department.name == 'Reclame Aqui' %}
            <!-- Reclame Aqui -->
            <div class="nav-group-title">OperaÃ§Ã£o</div>

            <a href="#reclameAquiSubmenu"
                class="nav-link dropdown-toggle-custom {% if 'complaint' in request.resolver_match.url_name or 'store' in request.resolver_match.url_name or 'reports' in request.resolver_match.url_name or request.resolver_match.url_name == 'dashboard' %}active{% endif %}"
                data-bs-toggle="collapse"
                aria-expanded="{% if 'complaint' in request.resolver_match.url_name or 'store' in request.resolver_match.url_name or 'reports' in request.resolver_match.url_name or request.resolver_match.url_name == 'dashboard' %}true{% else %}false{% endif %}"
                aria-controls="reclameAquiSubmenu">
                <i class="bi bi-headset"></i>
                <span class="link-text">Reclame Aqui</span>
                <i class="bi bi-chevron-down ms-auto arrow-icon"></i>
            </a>
            <div class="collapse nav-submenu-container {% if 'complaint' in request.resolver_match.url_name or 'store' in request.resolver_match.url_name or 'reports' in request.resolver_match.url_name or request.resolver_match.url_name == 'dashboard' %}show{% endif %}"
                id="reclameAquiSubmenu">
                <div class="nav-submenu">
                    <a href="{% url 'dashboard' %}"
                        class="nav-link sub-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}"
                        title="Dashboard">
                        <i class="bi bi-speedometer2"></i>
                        <span class="link-text">Dashboard</span>
                    </a>
                    <a href="{% url 'complaint_list' %}"
                        class="nav-link sub-link {% if 'complaint' in request.resolver_match.url_name %}active{% endif %}"
                        title="ReclamaÃ§Ãµes">
                        <i class="bi bi-list-ul"></i>
                        <span class="link-text">ReclamaÃ§Ãµes</span>
                    </a>
                    <a href="{% url 'store_list' %}"
                        class="nav-link sub-link {% if 'store' in request.resolver_match.url_name %}active{% endif %}"
                        title="Lojas">
                        <i class="bi bi-shop"></i>
                        <span class="link-text">Lojas</span>
                    </a>
                    <a href="{% url 'reports' %}"
                        class="nav-link sub-link {% if request.resolver_match.url_name == 'reports' %}active{% endif %}"
                        title="RelatÃ³rios">
                        <i class="bi bi-graph-up"></i>
                        <span class="link-text">RelatÃ³rios</span>
                    </a>

                </div>
            </div>

            <div class="nav-group-title">Canais</div>
            <a href="{% url 'google_meu_negocio' %}"
                class="nav-link {% if request.resolver_match.url_name == 'google_meu_negocio' %}active{% endif %}"
                title="Google Meu Negócio">
                <i class="bi bi-google"></i>
                <span class="link-text">Google Meu Negócio</span>
            </a>

            {% elif current_department.name == 'NRS Suporte' %}
            <!-- NRS Suporte -->
            <div class="nav-group-title">Operação</div>
            <a href="{% url 'escala' %}"
                class="nav-link {% if request.resolver_match.url_name == 'escala' %}active{% endif %}">
                <i class="bi bi-calendar-event"></i>
                <span class="link-text">Escala</span>
            </a>
            <a href="{% url 'quadro' %}"
                class="nav-link {% if request.resolver_match.url_name == 'quadro' %}active{% endif %}">
                <i class="bi bi-grid-3x3"></i>
                <span class="link-text">Quadro</span>
            </a>
            <a href="{% url 'calendario' %}"
                class="nav-link {% if request.resolver_match.url_name == 'calendario' %}active{% endif %}">
                <i class="bi bi-calendar3"></i>
                <span class="link-text">Calendário</span>
            </a>
            <a href="{% url 'tasks_view' %}"
                class="nav-link {% if request.resolver_match.url_name == 'tasks_view' %}active{% endif %}">
                <i class="bi bi-list-check"></i>
                <span class="link-text">Tarefas</span>
            </a>
            <a href="{% url 'verificacao_lojas' %}"
                class="nav-link {% if request.resolver_match.url_name == 'verificacao_lojas' %}active{% endif %}">
                <i class="bi bi-shield-check"></i>
                <span class="link-text">Verificação de Lojas</span>
            </a>


            <div class="nav-group-title">Informação</div>
            <a href="{% url 'base_conhecimento' %}"
                class="nav-link {% if request.resolver_match.url_name == 'base_conhecimento' %}active{% endif %}">
                <i class="bi bi-book"></i>
                <span class="link-text">Suporte</span>
            </a>
            <a href="{% url 'desempenho' %}"
                class="nav-link {% if request.resolver_match.url_name == 'desempenho' %}active{% endif %}">
                <i class="bi bi-activity"></i>
                <span class="link-text">Desempenho</span>

            </a>

            {% if user.is_gestor or user.is_administrador or user.is_analista %}
            <a href="{% url 'auditoria_atendimentos' %}"
                class="nav-link {% if request.resolver_match.url_name == 'auditoria_atendimentos' %}active{% endif %}">
                <i class="bi bi-clipboard-check"></i>
                <span class="link-text">Auditoria de Atendimentos</span>
            </a>
            {% endif %}


            {% elif current_department.name == 'Onboarding' %}
            <!-- Onboarding -->
            <div class="nav-group-title">Implantação</div>
            <a href="{% url 'onboarding_dev_1' %}"
                class="nav-link {% if request.resolver_match.url_name == 'onboarding_dev_1' %}active{% endif %}">
                <i class="bi bi-hammer"></i>
                <span class="link-text">Em desenvolvimento</span>
            </a>
            <a href="{% url 'onboarding_dev_2' %}"
                class="nav-link {% if request.resolver_match.url_name == 'onboarding_dev_2' %}active{% endif %}">
                <i class="bi bi-hammer"></i>
                <span class="link-text">Em desenvolvimento</span>
            </a>
            <a href="{% url 'onboarding_dev_3' %}"
                class="nav-link {% if request.resolver_match.url_name == 'onboarding_dev_3' %}active{% endif %}">
                <i class="bi bi-hammer"></i>
                <span class="link-text">Em desenvolvimento</span>
            </a>


            {% elif current_department.name == 'CS Clientes' %}

            <!-- CS Clientes -->
            <div class="nav-group-title">Operação</div>
            <a href="#reclameAquiSubmenuCS"
                class="nav-link dropdown-toggle-custom {% if 'complaint' in request.resolver_match.url_name or 'store' in request.resolver_match.url_name or 'reports' in request.resolver_match.url_name or request.resolver_match.url_name == 'dashboard' %}active{% endif %}"
                data-bs-toggle="collapse"
                aria-expanded="{% if 'complaint' in request.resolver_match.url_name or 'store' in request.resolver_match.url_name or 'reports' in request.resolver_match.url_name or request.resolver_match.url_name == 'dashboard' %}true{% else %}false{% endif %}"
                aria-controls="reclameAquiSubmenuCS">
                <i class="bi bi-headset"></i>
                <span class="link-text">Reclame Aqui</span>
                <i class="bi bi-chevron-down ms-auto arrow-icon"></i>
            </a>
            <div class="collapse nav-submenu-container {% if 'complaint' in request.resolver_match.url_name or 'store' in request.resolver_match.url_name or 'reports' in request.resolver_match.url_name or request.resolver_match.url_name == 'dashboard' %}show{% endif %}"
                id="reclameAquiSubmenuCS">
                <div class="nav-submenu">
                    <a href="{% url 'dashboard' %}"
                        class="nav-link sub-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}"
                        title="Dashboard">
                        <i class="bi bi-speedometer2"></i>
                        <span class="link-text">Dashboard</span>
                    </a>
                    <a href="{% url 'complaint_list' %}"
                        class="nav-link sub-link {% if 'complaint' in request.resolver_match.url_name %}active{% endif %}"
                        title="Reclamações">
                        <i class="bi bi-list-ul"></i>
                        <span class="link-text">Reclamações</span>
                    </a>
                    <a href="{% url 'store_list' %}"
                        class="nav-link sub-link {% if 'store' in request.resolver_match.url_name %}active{% endif %}"
                        title="Lojas">
                        <i class="bi bi-shop"></i>
                        <span class="link-text">Lojas</span>
                    </a>
                    <a href="{% url 'reports' %}"
                        class="nav-link sub-link {% if request.resolver_match.url_name == 'reports' %}active{% endif %}"
                        title="Relatórios">
                        <i class="bi bi-graph-up"></i>
                        <span class="link-text">Relatórios</span>
                    </a>

                </div>
            </div>

            <div class="nav-group-title">Canais</div>
            <a href="{% url 'google_meu_negocio' %}"
                class="nav-link {% if request.resolver_match.url_name == 'google_meu_negocio' %}active{% endif %}"
                title="Google Meu NegÃ³cio">
                <i class="bi bi-google"></i>
                <span class="link-text">Google Meu NegÃ³cio</span>
            </a>

            <div class="nav-group-title">Atendimento</div>
            <a href="{% url 'solicitacoes' %}"
                class="nav-link {% if request.resolver_match.url_name == 'solicitacoes' %}active{% endif %}">
                <i class="bi bi-receipt-cutoff"></i>
                <span class="link-text">Solicitações</span>
            </a>
            {% endif %}




        </nav>
    </div>

    <!-- Top Header -->
    <header class="header d-flex align-items-center px-4 border-bottom bg-white" id="header"
        style="position: fixed; top: 0; left: 0; right: 0; height: 80px; z-index: 1030;">

        <!-- Logo -->
        <a href="{% url 'dashboard' %}" class="d-flex align-items-center text-decoration-none me-4">
            <img src="{% static 'img/logo_nexus_horizontal.png' %}" alt="Nexus" style="height: 60px;">
        </a>

        <button class="btn btn-link text-secondary d-lg-none" id="headerSidebarToggle" title="Alternar Menu">
            <i class="bi bi-list fs-4"></i>
        </button>

        <div class="d-flex align-items-center gap-3 ms-auto">
            <!-- Notification Dropdown -->
            <div class="dropdown">
                <button class="btn btn-link text-secondary p-0 position-relative" title="Notificações"
                    id="notificationDropdownBtn" data-bs-toggle="dropdown" aria-expanded="false"
                    data-bs-auto-close="outside">
                    <i class="bi bi-bell" style="font-size: 1.25rem;"></i>
                    <span id="notificationBadge"
                        class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle"
                        style="display: none;">
                        <span class="visually-hidden">Novas notificações</span>
                    </span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow border-0 p-0"
                    aria-labelledby="notificationDropdownBtn"
                    style="width: 320px; max-height: 400px; overflow-y: auto;">
                    <li class="p-3 border-bottom bg-light d-flex justify-content-between align-items-center">
                        <span class="fw-bold text-primary">Novidades do Sistema</span>
                        <small class="text-muted" style="font-size: 0.75rem;">Nexus Updates</small>
                    </li>
                    <li id="notificationListContainer">
                        <div class="text-center py-4 text-muted">
                            <div class="spinner-border spinner-border-sm mb-2" role="status"></div>
                            <p class="mb-0 small">Carregando...</p>
                        </div>
                    </li>
                    <li class="p-2 border-top text-center bg-light rounded-bottom">
                        <small class="text-muted">Mantenha-se atualizado!</small>
                    </li>
                </ul>
            </div>

            <!-- User Profile -->
            <div class="header-user dropdown">
                <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle no-arrow"
                    id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    {% if user.profile_photo %}
                    <img src="{{ user.profile_photo.url }}" alt="{{ user.get_full_name|default:user.username }}"
                        class="user-photo me-2">
                    {% else %}
                    <div class="user-photo-placeholder me-2">
                        {{ user|get_user_initials }}
                    </div>
                    {% endif %}
                    <div class="user-info d-none d-lg-block text-end me-2">
                        <div class="fw-semibold text-dark">{{ user.username }}</div>
                    </div>
                    <i class="bi bi-chevron-down text-secondary" style="font-size: 0.8rem;"></i>
                </a>
                <ul class="dropdown-menu dropdown-menu-end shadow border-0" aria-labelledby="userDropdown">
                    {% if user.role == 'gestor' or user.role == 'administrador' %}
                    <li><a class="dropdown-item" href="{% url 'user_list' %}"><i
                                class="bi bi-people me-2"></i>Usuários</a></li>
                    {% endif %}
                    <li><a class="dropdown-item" href="{% url 'settings' %}"><i class="bi bi-gear me-2"></i>
                            Configurações</a></li>
                    <li>
                        <hr class="dropdown-divider">
                    </li>
                    <li>
                        <button class="dropdown-item text-danger" data-bs-toggle="modal" data-bs-target="#logoutModal">
                            <i class="bi bi-box-arrow-right me-2"></i> Sair
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </header>
    {% endif %}

    <!-- Conteúdo Principal -->
    <div class="{% if user.is_authenticated %}main-content{% endif %}" style="padding-top: 80px;">
        {% if user.is_authenticated %}
        <!-- Header antigo removido -->
        {% endif %}
        {% block content %}{% endblock %}
    </div>

    <!-- Toast Container -->
    <!-- Toast Container (Bottom Right via style.css) -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Processar mensagens do Django e mostrar como toast -->
    {% if messages %}
    <script id="django-messages" type="application/json">
        [
            {% for message in messages %}
            {"message": "{{ message|escapejs }}", "tags": "{{ message.tags }}"}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const messagesEl = document.getElementById('django-messages');
            if (messagesEl) {
                const messages = JSON.parse(messagesEl.textContent);
                messages.forEach(m => showToast(m.message, m.tags));
            }
        });
    </script>
    {% endif %}


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Carregar tema salvo ao carregar a página
        document.addEventListener('DOMContentLoaded', function () {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
            }
        });
    </script>

    <!-- Sidebar Toggle Script -->
    <script>
        // Toggle Sidebar
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.querySelector('.main-content');

        if (sidebarToggle && sidebar) {
            // Mobile toggle
            const mobileToggle = document.getElementById('mobileToggle');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            // Carregar estado salvo (apenas para desktop)
            if (window.innerWidth > 991) {
                const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
                if (sidebarCollapsed) {
                    document.body.classList.add('sidebar-collapsed');
                    sidebar.classList.add('collapsed');
                    if (mainContent) mainContent.classList.add('expanded');
                }
            }

            // Desktop Toggle
            function toggleSidebar() {
                document.body.classList.toggle('sidebar-collapsed');
                sidebar.classList.toggle('collapsed');
                if (mainContent) mainContent.classList.toggle('expanded');

                // Salvar estado
                const isCollapsed = sidebar.classList.contains('collapsed');
                localStorage.setItem('sidebarCollapsed', isCollapsed);

                // Trocar ícones nos botões (se existirem)
                const toggleBtns = [sidebarToggle, document.getElementById('headerSidebarToggle')];

                toggleBtns.forEach(btn => {
                    if (btn) {
                        const icon = btn.querySelector('i');
                        if (icon) {
                            if (isCollapsed) {
                                icon.classList.remove('bi-chevron-left');
                                icon.classList.remove('bi-list'); // Remove list icon if it was list

                                // Se for o botão do header, mantemos 'list' ou usamos outra lógica?
                                // A referência visual sugere hamburger menu.
                                // Geralmente hamburger menu nÃ£o muda de Ã­cone, mas vamos manter simples.
                                // Se for o toggle da sidebar (seta), vira direita. Se for hambúrguer, pode ficar hambúrguer ou virar X.

                                if (btn.id === 'sidebarToggle') {
                                    icon.classList.add('bi-chevron-right');
                                    btn.title = 'Expandir menu';
                                }
                            } else {
                                if (btn.id === 'sidebarToggle') {
                                    icon.classList.remove('bi-chevron-right');
                                    icon.classList.add('bi-chevron-left');
                                    btn.title = 'Minimizar menu';
                                }
                            }
                        }
                    }
                });
            }

            sidebarToggle.addEventListener('click', toggleSidebar);

            const headerToggle = document.getElementById('headerSidebarToggle');
            if (headerToggle) {
                headerToggle.addEventListener('click', toggleSidebar);
            }

            // Mobile Toggle
            if (mobileToggle) {
                mobileToggle.addEventListener('click', function () {
                    sidebar.classList.add('mobile-show');
                    sidebarOverlay.classList.add('show');
                    document.body.style.overflow = 'hidden';
                });
            }

            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', function () {
                    sidebar.classList.remove('mobile-show');
                    sidebarOverlay.classList.remove('show');
                    document.body.style.overflow = '';
                });
            }
        }

    </script>

    <script>
        // Auto-fechamento do submenu Reclame Aqui -> 5 segundos
        document.addEventListener('DOMContentLoaded', function () {
            const submenu = document.getElementById('reclameAquiSubmenu');
            if (submenu) {
                let autoCloseTimer;

                submenu.addEventListener('shown.bs.collapse', function () {
                    autoCloseTimer = setTimeout(function () {
                        const bsCollapse = bootstrap.Collapse.getOrCreateInstance(submenu);
                        bsCollapse.hide();
                    }, 5000);
                });

                submenu.addEventListener('hidden.bs.collapse', function () {
                    if (autoCloseTimer) clearTimeout(autoCloseTimer);
                });
            }
        });
    </script>

    <!-- Script para submenu flutuante quando sidebar recolhida -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const sidebar = document.getElementById('sidebar');

            // Handle both Reclame Aqui submenus (original and CS Clientes)
            const submenuConfigs = [
                { toggle: document.querySelector('a[href="#reclameAquiSubmenu"]'), submenu: document.getElementById('reclameAquiSubmenu') },
                { toggle: document.querySelector('a[href="#reclameAquiSubmenuCS"]'), submenu: document.getElementById('reclameAquiSubmenuCS') },
                { toggle: document.querySelector('a[href="#hubAtendimentoSubmenu"]'), submenu: document.getElementById('hubAtendimentoSubmenu') }
            ];

            submenuConfigs.forEach(config => {
                const { toggle, submenu } = config;
                if (!toggle || !submenu) return;

                toggle.addEventListener('click', function (e) {
                    // Se a sidebar estÃƒÂ¡ recolhida, forÃƒÂ§ar a abertura do submenu
                    if (sidebar && sidebar.classList.contains('collapsed')) {
                        e.preventDefault();
                        e.stopPropagation();

                        // Posicionar o submenu ao lado do ÃƒÂ­cone
                        const rect = toggle.getBoundingClientRect();
                        submenu.style.top = rect.top + 'px';

                        // Toggle manual do submenu
                        if (submenu.classList.contains('show')) {
                            submenu.classList.remove('show');
                        } else {
                            // Fechar outros submenus primeiro
                            submenuConfigs.forEach(c => {
                                if (c.submenu && c.submenu !== submenu) {
                                    c.submenu.classList.remove('show');
                                }
                            });
                            submenu.classList.add('show');
                        }
                    }
                });
            });

            // Fechar submenu ao clicar fora
            document.addEventListener('click', function (e) {
                if (sidebar && sidebar.classList.contains('collapsed')) {
                    submenuConfigs.forEach(config => {
                        const { toggle, submenu } = config;
                        if (toggle && submenu && !toggle.contains(e.target) && !submenu.contains(e.target)) {
                            submenu.classList.remove('show');
                        }
                    });
                }
            });
        });
    </script>

    <!-- Custom Time Picker JS -->
    <script src="{% static 'js/custom_timepicker.js' %}"></script>
    {% if user.is_authenticated %}
    <script>
        const currentUserId = {% if user.id %}{ { user.id } } {% else %} 0{% endif %};
        const currentUserName = "{{ user.username }}";
    </script>

    {% endif %}
    {% block scripts %}{% endblock %}

    <audio id="notificationSound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mpeg">
    </audio>


    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Removed chat polling
        });





        // --------------------------------------------------
        // Sistema de Toast Notifications (Premium SweetAlert2)
        // --------------------------------------------------
        function showGlobalToast(message, type = 'info') {
            const Toast = Swal.mixin({
                toast: true,
                position: 'bottom-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer)
                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                }
            });

            const typeMap = {
                'success': 'success',
                'error': 'error',
                'danger': 'error',
                'warning': 'warning',
                'info': 'info'
            };

            Toast.fire({
                icon: typeMap[type] || 'info',
                title: message
            });
        }

        // Alias for compatibility
        window.showToast = showGlobalToast;




        async function checkNotifications() {
            try {
                const res = await fetch('/api/notifications/check/');
                if (res.ok) {
                    const data = await res.json();

                    if (data.has_notifications && data.notifications) {
                        let playedSound = false;

                        data.notifications.forEach(n => {
                            let type = 'info';
                            if (n.type && (n.type.includes('warning') || n.type.includes('irregularity'))) type = 'warning';
                            if (n.type && n.type.includes('new')) type = 'success';

                            showGlobalToast(n.message, type);

                            if (!playedSound) {
                                playNotificationSound();
                                playedSound = true;
                            }
                        });
                    }
                }
            } catch (e) {
                console.error('Erro ao verificar notificaÃ§Ãµes', e);
            }
        }

        function playNotificationSound() {
            const audio = document.getElementById('notificationSound');
            if (audio) {
                audio.play().catch(e => console.log('Autoplay bloqueado', e));
            }
        }
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        async function authenticatedFetch(url, options = {}) {
            const defaults = {
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            };
            options.headers = { ...defaults.headers, ...options.headers };
            return fetch(url, options);
        }
    </script>
    <!-- Modal Detalhes da Notificação DO SISTEMA -->
    <div class="modal fade" id="systemNotificationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-0 py-3 bg-light">
                    <div class="d-flex align-items-center">
                        <div id="notifModalIconContainer"
                            class="me-3 rounded-circle p-2 d-flex align-items-center justify-content-center"
                            style="width: 48px; height: 48px;">
                            <i id="notifModalIcon" class="bi fs-4 text-white"></i>
                        </div>
                        <div>
                            <h5 class="modal-title fw-bold text-dark" id="notifModalTitle"></h5>
                            <small class="text-muted" id="notifModalDate"></small>
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4" id="notifModalContent" style="line-height: 1.6; color: #4a5568;">
                    <!-- Content injected via JS -->
                </div>
                <div class="modal-footer border-0 bg-white">
                    <button type="button" class="btn btn-secondary rounded-pill px-4"
                        data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Logout Modal -->
    <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold" id="logoutModalLabel">Sair do Sistema</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body py-4 text-center">
                    <div class="mb-3">
                        <i class="bi bi-box-arrow-right text-danger display-4"></i>
                    </div>
                    <p class="mb-0 text-muted fs-5">Tem certeza que deseja sair?</p>
                </div>
                <div class="modal-footer border-top-0 justify-content-center pb-4">
                    <button type="button" class="btn btn-light rounded-pill px-4"
                        data-bs-dismiss="modal">Cancelar</button>
                    <a href="{% url 'logout' %}" class="btn btn-danger rounded-pill px-4">Sair</a>
                </div>
            </div>
        </div>
    </div>

    <!-- System Notifications JS -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            fetchSystemNotifications();
        });

        function fetchSystemNotifications() {
            fetch('/api/system/notifications/')
                .then(response => response.json())
                .then(data => {
                    const list = document.getElementById('notificationListContainer');
                    const badge = document.getElementById('notificationBadge');

                    if (data.notifications && data.notifications.length > 0) {
                        badge.style.display = 'block';
                        list.innerHTML = ''; // Clear loading

                        data.notifications.forEach(notif => {
                            let iconClass = 'bi-info-circle';
                            let colorClass = 'text-primary';
                            let bgClass = 'bg-primary-subtle';

                            if (notif.category_code === 'news') { iconClass = 'bi-megaphone'; colorClass = 'text-success'; bgClass = 'bg-success-subtle'; }
                            else if (notif.category_code === 'event') { iconClass = 'bi-calendar-event'; colorClass = 'text-warning'; bgClass = 'bg-warning-subtle'; }
                            else if (notif.category_code === 'alert') { iconClass = 'bi-exclamation-triangle'; colorClass = 'text-danger'; bgClass = 'bg-danger-subtle'; }

                            const item = document.createElement('li');
                            item.className = 'dropdown-item p-3 border-bottom d-flex align-items-start gap-3 cursor-pointer';
                            item.style.whiteSpace = 'normal';
                            item.style.cursor = 'pointer';
                            item.onclick = () => openSystemNotification(notif);

                            item.innerHTML = `
                            <div class="rounded-circle p-2 d-flex align-items-center justify-content-center ${bgClass} flex-shrink-0" style="width: 36px; height: 36px;">
                                <i class="bi ${iconClass} ${colorClass}"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1 fw-semibold text-dark" style="font-size: 0.9rem;">${notif.title}</h6>
                                <p class="mb-1 text-muted small text-truncate-2">${notif.message}</p>
                                <small class="text-secondary" style="font-size: 0.75rem;">${notif.created_at}</small>
                            </div>
                        `;

                            list.appendChild(item);
                        });
                    } else {
                        badge.style.display = 'none';
                        list.innerHTML = '<div class="text-center py-4 text-muted"><i class="bi bi-bell-slash fs-4 d-block mb-2"></i><small>Nenhuma nova notificação</small></div>';
                    }
                })
                .catch(err => console.error('Error loading notifications:', err));
        }

        function openSystemNotification(notif) {
            const modal = new bootstrap.Modal(document.getElementById('systemNotificationModal'));

            document.getElementById('notifModalTitle').innerText = notif.title;
            document.getElementById('notifModalDate').innerText = notif.created_at + ' • ' + notif.category;

            // Set Icon
            let iconClass = 'bi-info-circle';
            let bgClass = 'bg-primary';

            if (notif.category_code === 'news') { iconClass = 'bi-megaphone'; bgClass = 'bg-success'; }
            else if (notif.category_code === 'event') { iconClass = 'bi-calendar-event'; bgClass = 'bg-warning'; }
            else if (notif.category_code === 'alert') { iconClass = 'bi-exclamation-triangle'; bgClass = 'bg-danger'; }

            const iconContainer = document.getElementById('notifModalIconContainer');
            iconContainer.className = `me-3 rounded-circle p-2 d-flex align-items-center justify-content-center ${bgClass}`;
            document.getElementById('notifModalIcon').className = `bi ${iconClass} text-white fs-4`;

            // Content (Prefer details HTML, fallback to message)
            const contentDiv = document.getElementById('notifModalContent');
            if (notif.details && notif.details.trim() !== '') {
                contentDiv.innerHTML = notif.details;
            } else {
                contentDiv.innerHTML = `<p>${notif.message}</p>`;
            }

            modal.show();
        }
    </script>
</body>


</html>